{% extends 'base.html' %}
{% block title %}Meu Desempenho{% endblock %}

{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --primary-color: #4A90E2;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --light-bg: #FFFFFF;
    --body-bg: #F8F9FC;
    --border-color: #EAECEF;
    --text-dark: #343a40;
    --text-muted: #6c757d;
    --font-family: 'Poppins', sans-serif;
    --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    --border-radius: 12px;
}

body {
    background-color: var(--body-bg);
    font-family: var(--font-family);
    color: var(--text-dark);
}

.container h2 {
    font-weight: 600;
}

/* Estilo Base dos Cards */
.card {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* Aplica o efeito a todos os cards, EXCETO aquele com a classe .card-filtros */
.card:not(.card-filtros):hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}

.card-header {
    background-color: transparent;
    border-bottom: 1px solid var(--border-color);
    padding: 1rem 1.5rem;
    font-weight: 500;
}

/* Cards de Estatísticas */
.stat-card {
    position: relative;
    overflow: hidden;
    padding: 1.5rem;
}

.stat-card .stat-icon {
    position: absolute;
    top: -10px;
    right: -10px;
    font-size: 4rem;
    opacity: 0.15;
    transform: rotate(15deg);
}

.stat-card .card-title {
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-muted);
}

.stat-card .display-4 {
    font-weight: 600;
    color: var(--text-dark);
}

/* Cores específicas para os cards de estatísticas */
.stat-card.border-left-primary { border-left: 4px solid var(--primary-color); }
.stat-card.border-left-success { border-left: 4px solid var(--success-color); }
.stat-card.border-left-danger { border-left: 4px solid var(--danger-color); }
.stat-card.border-left-info { border-left: 4px solid #17a2b8; }


/* Tabela de Desempenho */
.table {
    border-collapse: separate;
    border-spacing: 0 8px; /* Espaçamento vertical entre as linhas */
}

.table thead th {
    border: none;
    font-weight: 600;
    color: var(--text-muted);
}

.table tbody tr {
    background-color: var(--light-bg);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.table tbody td {
    vertical-align: middle;
    padding: 1rem;
    border: none;
}

.table tbody tr td:first-child {
    border-top-left-radius: 8px;
    border-bottom-left-radius: 8px;
}
.table tbody tr td:last-child {
    border-top-right-radius: 8px;
    border-bottom-right-radius: 8px;
}

/* Barra de Progresso na Tabela */
.progress-bar-container {
    background-color: #e9ecef;
    border-radius: 10px;
    height: 12px;
    width: 100%;
    overflow: hidden;
}
.progress-bar-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease-in-out;
}
.progress-bar-label {
    font-weight: 500;
}

/* Estilos para o formulário de filtros */
.filter-form .form-label {
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
    color: var(--text-muted);
}
.filter-form .form-select,
.filter-form .btn {
    font-size: 0.9rem;
}


@media only screen and (max-width: 768px) {
    .mb-0{
        font-size: 21px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <h2 class="mb-0">Dashboard de Desempenho</h2>
        <a href="{% url 'pratica:listar_questoes' %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Praticar Mais
        </a>
    </div>

    <!-- INÍCIO: Formulário de Filtros Avançados -->
    <div class="card mb-4 card-filtros">
        <div class="card-body">
            <form method="GET" action="{% url 'dashboard' %}" class="filter-form">
                <div class="row g-3 align-items-end">
                    <!-- Filtro de Disciplina -->
                    <div class="col-xl-3 col-lg-4 col-md-6">
                        <label for="disciplina" class="form-label fw-bold">Disciplina</label>
                        <select name="disciplina" id="disciplina" class="form-select">
                            <option value="">Todas as Disciplinas</option>
                            {% for d in disciplinas_para_filtro %}
                            <option value="{{ d.id }}" {% if disciplina_selecionada == d.id %}selected{% endif %}>
                                    {{ d.nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Filtro de Assunto (só aparece se uma disciplina for selecionada) -->
                    <div class="col-xl-3 col-lg-4 col-md-6">
                        <label for="assunto" class="form-label fw-bold">Assunto</label>
                        <select name="assunto" id="assunto" class="form-select" {% if not disciplina_selecionada %}disabled{% endif %}>
                            <option value="">Todos os Assuntos</option>
                            {% for a in assuntos_para_filtro %}
                                <option value="{{ a.id }}" {% if assunto_selecionado == a.id|stringformat:"s" %}selected{% endif %}>
                                    {{ a.nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro de Banca -->
                    <div class="col-xl-2 col-lg-4 col-md-6">
                        <label for="banca" class="form-label fw-bold">Banca</label>
                        <select name="banca" id="banca" class="form-select">
                            <option value="">Todas as Bancas</option>
                            {% for b in bancas_para_filtro %}
                                <option value="{{ b.id }}" {% if banca_selecionada == b.id|stringformat:"s" %}selected{% endif %}>
                                    {{ b.nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro de Período -->
                    <div class="col-xl-2 col-lg-6 col-md-6">
                         <label for="periodo" class="form-label fw-bold">Período</label>
                         <select name="periodo" id="periodo" class="form-select">
                            <option value="geral" {% if periodo_selecionado == 'geral' %}selected{% endif %}>Todo o Período</option>
                            <option value="hoje" {% if periodo_selecionado == 'hoje' %}selected{% endif %}>Hoje</option>
                            <option value="semana" {% if periodo_selecionado == 'semana' %}selected{% endif %}>Esta Semana</option>
                            <option value="mes" {% if periodo_selecionado == 'mes' %}selected{% endif %}>Este Mês</option>
                            <option value="ano" {% if periodo_selecionado == 'ano' %}selected{% endif %}>Este Ano</option>
                        </select>
                    </div>

                    <!-- Botões -->
                    <div class="col-xl-2 col-lg-6 col-md-12">
                        <div class="d-grid d-lg-flex gap-2">
                           <button type="submit" class="btn btn-success flex-grow-1">
                               <i class="fas fa-filter me-1"></i> Filtrar
                           </button>
                           <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary" title="Limpar Filtros">
                               <i class="fas fa-times"></i>
                           </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- FIM: Formulário de Filtros -->


    {% if not total_respondidas %}
    <div class="card card-body text-center py-5">
        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
        <h4 class="h5">Nenhum resultado encontrado</h4>
        <p class="text-muted">Tente ajustar os filtros ou resolva mais questões para ver seu desempenho.</p>
        <div class="mt-3">
            <a href="{% url 'dashboard' %}" class="btn btn-secondary me-2">Limpar Filtros</a>
            <a href="{% url 'listar_questoes' %}" class="btn btn-success">Começar a Praticar</a>
        </div>
    </div>
    {% else %}
    <!-- Cards de Estatísticas Gerais (já refletem os filtros aplicados) -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stat-card border-left-info h-100">
                <div class="card-body">
                    <i class="fas fa-pencil-alt stat-icon"></i>
                    <h5 class="card-title">Questões Resolvidas</h5>
                    <p class="display-4">{{ total_respondidas }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stat-card border-left-success h-100">
                <div class="card-body">
                    <i class="fas fa-check stat-icon"></i>
                    <h5 class="card-title">Acertos</h5>
                    <p class="display-4">{{ total_acertos }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stat-card border-left-danger h-100">
                <div class="card-body">
                    <i class="fas fa-times stat-icon"></i>
                    <h5 class="card-title">Erros</h5>
                    <p class="display-4">{{ total_erros }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stat-card border-left-primary h-100">
                <div class="card-body">
                    <i class="fas fa-bullseye stat-icon"></i>
                    <h5 class="card-title">% de Acerto (Filtro)</h5>
                    <p class="display-4">{{ percentual_acerto_geral }}<small class="fs-4 ms-1">%</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row">
        <div class="col-lg-5 col-md-12 mb-4">
            <div class="card h-100">
                <div class="card-header"><h6>Rendimento Geral (Filtro)</h6></div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <canvas id="rendimentoGeralChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-7 col-md-12 mb-4">
            <div class="card h-100">
                <div class="card-header"><h6>Acertos por Banca (Filtro)</h6></div>
                <div class="card-body">
                    <canvas id="bancaChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabela de Desempenho DINÂMICA -->
    <div class="row mt-2">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6>
                        {% if disciplina_selecionada %}
                            Desempenho por Assunto
                        {% else %}
                            Desempenho por Disciplina
                        {% endif %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                         <table class="table">
                            <thead>
                                <tr>
                                    <th>
                                        {% if disciplina_selecionada %}
                                            Assunto
                                        {% else %}
                                            Disciplina
                                        {% endif %}
                                    </th>
                                    <th class="text-center">Resolvidas</th>
                                    <th style="min-width: 200px;">Percentual de Acerto</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in desempenho_principal %}
                                <tr>
                                    <td><strong>{{ item.nome }}</strong></td>
                                    <td class="text-center">{{ item.total }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress-bar-container flex-grow-1 me-2">
                                                <div class="progress-bar-fill" 
                                                     style="width: {{ item.percentual_acerto }}%; background-color: var(--primary-color);">
                                                </div>
                                            </div>
                                            <span class="progress-bar-label">{{ item.percentual_acerto|floatformat:1 }}%</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lógica para auto-submeter o formulário ao escolher uma disciplina,
    // para que a lista de assuntos seja atualizada dinamicamente.
    const disciplinaSelect = document.getElementById('disciplina');
    if (disciplinaSelect) {
        disciplinaSelect.addEventListener('change', function() {
            // Limpa o valor do assunto para evitar enviar um assunto de outra disciplina
            const assuntoSelect = document.getElementById('assunto');
            if (assuntoSelect) {
                assuntoSelect.value = '';
            }
            this.form.submit();
        });
    }

    // O código de renderização dos gráficos permanece o mesmo,
    // pois ele já renderiza os dados que o Django envia do backend.
    const rootStyles = getComputedStyle(document.documentElement);
    const primaryColor = rootStyles.getPropertyValue('--primary-color').trim();
    const successColor = rootStyles.getPropertyValue('--success-color').trim();
    const dangerColor = rootStyles.getPropertyValue('--danger-color').trim();
    const fontFamily = rootStyles.getPropertyValue('--font-family').trim();

    Chart.defaults.font.family = fontFamily;
    Chart.defaults.plugins.legend.position = 'bottom';
    Chart.defaults.plugins.tooltip.backgroundColor = '#343a40';
    Chart.defaults.plugins.tooltip.titleFont.size = 14;
    Chart.defaults.plugins.tooltip.bodyFont.size = 12;
    Chart.defaults.plugins.tooltip.padding = 10;
    Chart.defaults.plugins.tooltip.cornerRadius = 8;
    
    {% if total_respondidas %}

    const ctxRendimento = document.getElementById('rendimentoGeralChart').getContext('2d');
    new Chart(ctxRendimento, {
        type: 'doughnut',
        data: {
            labels: ['Acertos', 'Erros'],
            datasets: [{
                data: [{{ total_acertos }}, {{ total_erros }}],
                backgroundColor: [successColor, dangerColor],
                borderColor: [rootStyles.getPropertyValue('--light-bg').trim()],
                borderWidth: 4,
                hoverOffset: 8
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
    });

    const ctxBanca = document.getElementById('bancaChart').getContext('2d');
    new Chart(ctxBanca, {
        type: 'bar',
        data: {
            labels: {{ labels_banca|safe }},
            datasets: [{
                label: 'Acertos',
                data: {{ data_acertos_banca|safe }},
                backgroundColor: primaryColor,
                borderColor: primaryColor,
                borderWidth: 1,
                borderRadius: 6,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { drawBorder: false, } },
                x: { grid: { display: false, } }
            },
            plugins: { legend: { display: false } }
        }
    });
    
    {% endif %}
});
</script>
{% endblock %}