<!-- gamificacao/templates/gamificacao/loja.html -->
{% extends 'base.html' %}
{% load static %}
{% load gamificacao_extras %}
{% load colecao_extras %} 
{% block title %}Arsenal Divino{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/listagem-comum.css' %}">
<link rel="stylesheet" href="{% static 'css/celestial_card.css' %}">
<style>
    /* ======================================================================= */
    /* INÍCIO DA REFORMULAÇÃO DE DESIGN DA LOJA                              */
    /* ======================================================================= */

    /* Cabeçalho da Loja */
    .loja-header {
        position: relative;
        background: radial-gradient(ellipse at top, #2D2F55 0%, #1A1F3D 80%);
        color: white;
        border-radius: 16px;
        text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        padding: 4px; /* Espaço para a borda */
        overflow: hidden;
    }
    .loja-header::before {
        content: '';
        position: absolute;
        inset: 0;
        z-index: 0;
        background-image: conic-gradient(from var(--angle), #4A3D8C, #6E5BD4, #8FD3FF, #6E5BD4, #4A3D8C);
        border-radius: inherit;
        animation: rarity-border-spin 8s linear infinite;
        opacity: 0.8;
    }
    .loja-header-content {
        position: relative;
        z-index: 1;
        background-color: rgba(26, 31, 61, 0.8); /* Fundo semi-transparente para o conteúdo */
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 2rem;
    }
    @media (max-width: 767px) {
        .loja-header-content {
            padding: 1.5rem;
        }
    }

    .loja-header h1 {
        font-family: var(--fonte-display);
        color: var(--cor-dourada);
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
    }
    .loja-header .lead {
        color: rgba(255, 255, 255, 0.8);
    }
    .saldo-display {
        font-family: var(--fonte-display);
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--cor-dourada);
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    /* Card de Filtros */
    .filter-card {
        background-color: #1A1F3D;
        border: 1px solid #2D2F55;
    }

    /* Placeholder de loja vazia */
    .empty-store-card {
        background-color: rgba(26, 31, 61, 0.5) !important;
        border: 1px dashed #2D2F55;
        color: rgba(255, 255, 255, 0.5) !important;
    }
    .empty-store-card .fa-store-slash {
        color: rgba(255, 255, 255, 0.3) !important;
    }

    /* Itens bloqueados na loja */
    .item-card.locked {
        opacity: 0.7;
        filter: grayscale(80%);
        pointer-events: none; /* Impede cliques no card inteiro */
    }
    /* ======================================================================= */
    /* INÍCIO DA CORREÇÃO: Habilitando cliques no botão E no link "Ver mais..." */
    /* ======================================================================= */
    .item-card.locked .btn,
    .item-card.locked .view-details-link {
        pointer-events: all; /* Permite que o tooltip no botão e o link de detalhes funcionem */
    }
    /* ======================================================================= */
    /* FIM DA CORREÇÃO                                                         */
    /* ======================================================================= */
    /* ======================================================================= */
    /* FIM DA REFORMULAÇÃO DE DESIGN                                           */
    /* ======================================================================= */

</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="loja-header text-center mb-5 shadow">
        <div class="loja-header-content">
            <i class="fas fa-store-alt fa-3x mb-3" style="color: var(--cor-dourada);"></i>
            <h1 class="display-5">Arsenal Divino</h1>
            <p class="lead">Forje seu destino com artefatos celestiais usando seus Fragmentos de Conhecimento.</p>
            <div class="d-inline-flex align-items-center bg-white bg-opacity-10 p-2 px-4 rounded-pill mt-3">
                <span class="me-3 text-white-50">Seu Tesouro:</span>
                <span class="saldo-display" id="saldo-atual-display">
                    <i class="fas fa-coins me-2"></i>{{ saldo_atual }}
                </span>
            </div>
        </div>
    </div>

    <!-- Filtros e Ordenação -->
    <div class="card shadow-sm mb-4 filter-card">
        <div class="card-body">
            <form method="GET" action="{% url 'gamificacao:loja' %}" class="row g-3 align-items-center">
                <div class="col-md-3"><select name="tipo" class="form-select"><option value="">Todos os Tipos</option>{% for value, name in tipo_choices %}<option value="{{ value }}" {% if active_filters.tipo == value %}selected{% endif %}>{{ name }}</option>{% endfor %}</select></div>
                <div class="col-md-3"><select name="raridade" class="form-select"><option value="">Todas as Raridades</option>{% for value, name in raridade_choices %}<option value="{{ value }}" {% if active_filters.raridade == value %}selected{% endif %}>{{ name }}</option>{% endfor %}</select></div>
                <div class="col-md-3"><select name="sort_by" class="form-select">{% for value, name in sort_options.items %}<option value="{{ value }}" {% if active_filters.sort_by == value %}selected{% endif %}>{{ name }}</option>{% endfor %}</select></div>
                <div class="col-md-3 d-flex"><button type="submit" class="btn btn-primary w-100 me-2">Filtrar</button><a href="{% url 'gamificacao:loja' %}" class="btn btn-outline-secondary">Limpar</a></div>
            </form>
        </div>
    </div>

    <!-- Listagem de Itens -->
    <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-4" id="lista-itens-loja">
        {% for item in itens_loja %}
        <div class="col">
            <!-- ======================================================================= -->
            <!-- INÍCIO DA ALTERAÇÃO: Adicionando data attributes para o modal -->
            <!-- ======================================================================= -->
            <div class="card h-100 item-card {% rarity_class item.raridade %} {% if item.ja_possui %}owned{% endif %} {% if item.is_locked %}locked{% endif %}"
                 data-name="{{ item.nome }}"
                 data-description="{{ item.descricao }}"
                 data-image="{% if item.imagem %}{{ item.imagem.url }}{% else %}{% endif %}"
                 data-rarity="{{ item.get_raridade_display }}"
                 data-type="{{ item|class_name }}"
                 data-owned="{% if item.ja_possui %}true{% else %}false{% endif %}">
            <!-- ======================================================================= -->
            <!-- FIM DA ALTERAÇÃO -->
            <!-- ======================================================================= -->
                
                <div class="card-img-container">
                    {% if item.imagem %}
                        <img src="{{ item.imagem.url }}" class="card-img-top" alt="{{ item.nome }}">
                    {% else %}
                        <div class="card-img-top d-flex align-items-center justify-content-center bg-dark bg-opacity-25">
                            <i class="fas fa-image fa-3x text-white-50"></i>
                        </div>
                    {% endif %}
                    <span class="badge rarity-badge {% rarity_class item.raridade %}">{{ item.get_raridade_display }}</span>
                </div>
                
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ item.nome }}</h5>
                    <!-- ======================================================================= -->
                    <!-- INÍCIO DA ALTERAÇÃO: Lógica de truncamento e link para modal -->
                    <!-- ======================================================================= -->
                    {% if item.descricao %}
                        <p class="card-text small mb-1">{{ item.descricao|truncatewords:12 }}</p>
                        {% if item.descricao|wordcount > 12 %}
                            <a href="#" class="view-details-link small mt-auto" data-bs-toggle="modal" data-bs-target="#itemDetailModal" style="text-decoration: none;">
                                Ver mais...
                            </a>
                        {% endif %}
                    {% endif %}
                    <!-- ======================================================================= -->
                    <!-- FIM DA ALTERAÇÃO -->
                    <!-- ======================================================================= -->
                </div>
                
                <div class="card-footer">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
                        <span class="preco-tag mb-2 mb-sm-0"><i class="fas fa-coins me-1"></i> {{ item.preco_moedas }}</span>
                        
                        {% if item.ja_possui %}
                            <button class="btn btn-sm btn-success disabled w-100 w-sm-auto"><i class="fas fa-check me-2"></i>Adquirido</button>
                        {% elif item.is_locked %}
                            <button class="btn btn-sm btn-secondary w-100 w-sm-auto" disabled data-bs-toggle="tooltip" title="{{ item.unlock_condition }}">
                                <i class="fas fa-lock me-2"></i>Bloqueado
                            </button>
                        {% else %}
                            <button class="btn btn-sm btn-primary btn-comprar w-100 w-sm-auto" data-item-id="{{ item.id }}" data-item-tipo="{{ item|class_name }}" data-item-preco="{{ item.preco_moedas }}">
                                <i class="fas fa-shopping-cart me-2"></i>Comprar
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="card card-body text-center py-5 empty-store-card">
                <i class="fas fa-store-slash fa-3x mb-3"></i>
                <h4 class="h5">Nenhum item encontrado</h4>
                <p>Tente ajustar os filtros ou volte mais tarde!</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="mt-5">{% include 'includes/_paginacao.html' with paginated_object=itens_loja %}</div>
</div>

<!-- ======================================================================= -->
<!-- INÍCIO DA ADIÇÃO: Modal para detalhes do item -->
<!-- ======================================================================= -->
{% include 'usuarios/includes/_modal_detalhes_item.html' %}
<!-- ======================================================================= -->
<!-- FIM DA ADIÇÃO -->
<!-- ======================================================================= -->
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const itemContainer = document.getElementById('lista-itens-loja');
    if (itemContainer) {
        itemContainer.addEventListener('click', function(event) {
            const button = event.target.closest('.btn-comprar');
            if (button) {
                const itemId = button.dataset.itemId;
                const itemTipo = button.dataset.itemTipo;
                const itemPreco = button.dataset.itemPreco;
                const url = "{% url 'gamificacao:comprar_item' %}";

                Swal.fire({
                    title: 'Confirmar Compra',
                    text: `Você tem certeza que deseja gastar ${itemPreco} moedas neste item?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: 'var(--cor-primaria)',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sim, comprar!',
                    cancelButtonText: 'Cancelar',
                    background: 'var(--cor-fundo-intermediario)',
                    color: 'var(--cor-texto-claro)'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrftoken
                            },
                            body: JSON.stringify({
                                item_id: itemId,
                                item_tipo: itemTipo
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                document.getElementById('saldo-atual-display').innerHTML = `<i class="fas fa-coins me-2"></i>${data.novo_saldo}`;
                                button.classList.remove('btn-primary', 'btn-comprar');
                                button.classList.add('btn-success', 'disabled');
                                button.innerHTML = '<i class="fas fa-check me-2"></i>Adquirido';
                                button.disabled = true;
                                const card = button.closest('.item-card');
                                if(card) card.classList.add('owned');
                                Swal.fire('Sucesso!', data.message, 'success');
                            } else {
                                Swal.fire('Erro!', data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire('Erro!', 'Não foi possível completar a compra.', 'error');
                        });
                    }
                });
            }
        });
    }

    const itemDetailModal = document.getElementById('itemDetailModal');
    if (itemDetailModal) {
        itemDetailModal.addEventListener('show.bs.modal', function (event) {
            const triggerElement = event.relatedTarget;
            const card = triggerElement.closest('.item-card, .collection-card');

            // Captura todos os dados do card
            const name = card.dataset.name;
            const description = card.dataset.description;
            const imageUrl = card.dataset.image;
            const rarity = card.dataset.rarity;
            const type = card.dataset.type;
            const owned = card.dataset.owned === 'true';

            // Seleciona os elementos do modal
            const modalImage = itemDetailModal.querySelector('#itemDetailImage');
            const modalImagePlaceholder = itemDetailModal.querySelector('#itemDetailImagePlaceholder');
            const modalName = itemDetailModal.querySelector('#itemDetailName');
            const modalDescription = itemDetailModal.querySelector('#itemDetailDescription');
            const modalRarity = itemDetailModal.querySelector('#itemDetailRarity');
            const modalType = itemDetailModal.querySelector('#itemDetailType');
            const modalStatus = itemDetailModal.querySelector('#itemDetailStatus');

            // Preenche os dados básicos
            modalName.textContent = name;
            modalDescription.textContent = description;

            // Preenche os novos campos de informação
            modalRarity.innerHTML = `<i class="fas fa-gem fa-fw text-info"></i> Raridade: <strong class="text-white">${rarity}</strong>`;
            modalType.innerHTML = `<i class="fas fa-tag fa-fw text-info"></i> Tipo: <strong class="text-white">${type}</strong>`;
            if (owned) {
                modalStatus.innerHTML = `<i class="fas fa-check-circle fa-fw text-success"></i> Status: <strong class="text-white">Possui</strong>`;
            } else {
                modalStatus.innerHTML = `<i class="fas fa-times-circle fa-fw text-danger"></i> Status: <strong class="text-white">Não Possui</strong>`;
            }
            
            // Lida com a imagem
            if (imageUrl) {
                modalImage.src = imageUrl;
                modalImage.classList.remove('d-none');
                modalImagePlaceholder.classList.add('d-none');
            } else {
                modalImage.classList.add('d-none');
                modalImagePlaceholder.classList.remove('d-none');
            }
        });
    }
});
</script>
{% endblock %}