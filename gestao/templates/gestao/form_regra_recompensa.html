{% extends 'base.html' %}
{% load static %}
{% block title %}{{ titulo }}{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<style>
    .grupo-condicao { border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #f8f9fa; }
    .grupo-condicao h6 { border-bottom: 1px solid #ccc; padding-bottom: 0.5rem; margin-bottom: 1rem; }
    .condicao-field { display: none; }
    .condicao-field input:disabled { background-color: #e9ecef; cursor: not-allowed; }
    .dynamic-condition { gap: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    {% include 'gestao/includes/_submenu_gamificacao.html' with active_tab='campanhas' %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0">{{ titulo }}</h2>
        <a href="{% url 'gestao:listar_campanhas' %}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i>Voltar</a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-4 p-md-5">
            <form method="POST">
                {% csrf_token %}
                <h5 class="h6 mb-3 border-bottom pb-2">Dados Gerais da Campanha</h5>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.nome.label }}</label>{{ form.nome }}</div>
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.gatilho.label }}</label>{{ form.gatilho }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.data_inicio.label }}</label>{{ form.data_inicio }}</div>
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.data_fim.label }}</label>{{ form.data_fim }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.tipo_recorrencia.label }}</label>{{ form.tipo_recorrencia }}</div>
                    <div class="col-md-6 mb-3 align-self-center"><div class="form-check form-switch">{{ form.ativo }}<label class="form-check-label" for="{{ form.ativo.id_for_label }}">{{ form.ativo.label }}</label></div></div>
                </div>

                <hr class="my-4">
                <h5 class="h6 mb-3 border-bottom pb-2">Grupos de Condições e Recompensas</h5>
                <div id="grupos-container"></div>
                <button type="button" id="add-grupo-btn" class="btn btn-outline-success mt-2"><i class="fas fa-plus me-2"></i>Adicionar Grupo de Recompensa</button>
            
                <div class="mt-5 d-flex justify-content-center">
                    <button type="submit" class="btn btn-primary btn-lg px-5">Salvar Campanha</button>
                </div>
            </form>
        </div>
    </div>
</div>

<template id="grupo-template">
    <div class="grupo-condicao">
        <div class="d-flex justify-content-between align-items-center">
            <h6>Grupo de Recompensa #__INDEX_DISPLAY__</h6>
            <button type="button" class="btn-close remove-grupo-btn" aria-label="Close"></button>
        </div>
        <div class="row">
            <div class="col-md-6">
                <label class="form-label fw-bold small">Condições Legadas</label>
                <div class="condicao-field p-2 border rounded bg-light" data-gatilho="RANKING">
                    <label class="form-label">Posição Exata</label>
                    <input type="number" name="grupo-__INDEX__-posicao_exata" class="form-control mb-2 form-control-sm" placeholder="Ex: 1" data-input-type="posicao_exata">
                    <label class="form-label">Até a Posição (Top N)</label>
                    <input type="number" name="grupo-__INDEX__-posicao_ate" class="form-control form-control-sm" placeholder="Ex: 3" data-input-type="posicao_ate">
                </div>
                <div class="condicao-field p-2 border rounded bg-light" data-gatilho="SIMULADO">
                    <label class="form-label">Mínimo de Acertos (%)</label>
                    <input type="number" name="grupo-__INDEX__-min_acertos_percent" class="form-control form-control-sm" placeholder="Ex: 80">
                </div>

                <div class="mt-3">
                    <label class="form-label fw-bold small">Condições Dinâmicas</label>
                    <div class="dynamic-conditions-container"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary w-100 mt-2 add-dynamic-condition-btn"><i class="fas fa-plus"></i> Adicionar Condição</button>
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold small">Recompensas</label>
                <div class="p-2 border rounded bg-light">
                    <label class="form-label">XP Extra</label>
                    <input type="number" name="grupo-__INDEX__-xp_extra" class="form-control form-control-sm mb-2" value="0">
                    <label class="form-label">Moedas Extras</label>
                    <input type="number" name="grupo-__INDEX__-moedas_extras" class="form-control form-control-sm mb-2" value="0">
                    <label class="form-label mt-2">Avatares</label><select name="grupo-__INDEX__-avatares" multiple></select>
                    <label class="form-label mt-2">Bordas</label><select name="grupo-__INDEX__-bordas" multiple></select>
                    <label class="form-label mt-2">Banners</label><select name="grupo-__INDEX__-banners" multiple></select>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
{{ avatares_disponiveis|json_script:"avatares-data" }}
{{ bordas_disponiveis|json_script:"bordas-data" }}
{{ banners_disponiveis|json_script:"banners-data" }}
{{ grupos_de_condicoes|json_script:"grupos-existentes-data" }}
{{ variaveis_disponiveis|json_script:"variaveis-data" }}

<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const avataresData = JSON.parse(document.getElementById('avatares-data').textContent);
    const bordasData = JSON.parse(document.getElementById('bordas-data').textContent);
    const bannersData = JSON.parse(document.getElementById('banners-data').textContent);
    const gruposExistentes = JSON.parse(document.getElementById('grupos-existentes-data').textContent);
    const variaveisData = JSON.parse(document.getElementById('variaveis-data').textContent);

    const gatilhoSelect = document.getElementById('id_gatilho_select');
    const container = document.getElementById('grupos-container');
    const addBtn = document.getElementById('add-grupo-btn');
    const template = document.getElementById('grupo-template');
    let groupIndex = 0;

    function createTomSelect(element, options) { /* ... (sem alterações) ... */ }
    function handleExclusiveInputs(groupElement) { /* ... (sem alterações) ... */ }

    function addGrupo(data = {}) {
        const clone = template.content.cloneNode(true);
        const grupoDiv = clone.querySelector('.grupo-condicao');
        
        const html = grupoDiv.innerHTML.replace(/__INDEX__/g, groupIndex).replace(/__INDEX_DISPLAY__/g, groupIndex + 1);
        const newGroup = document.createElement('div');
        newGroup.innerHTML = html;
        container.appendChild(newGroup.firstChild);

        const addedGroupElement = container.children[container.children.length - 1];
        createTomSelect(addedGroupElement.querySelector('select[name$="-avatares"]'), avataresData);
        createTomSelect(addedGroupElement.querySelector('select[name$="-bordas"]'), bordasData);
        createTomSelect(addedGroupElement.querySelector('select[name$="-banners"]'), bannersData);
        
        if (Object.keys(data).length > 0) {
            // Preenche dados legados e de recompensas
            // ... (código para popular campos existentes) ...
            if (data.condicoes) {
                data.condicoes.forEach(cond => addDynamicCondition(addedGroupElement.querySelector('.dynamic-conditions-container'), cond));
            }
        }
        
        addedGroupElement.querySelector('.add-dynamic-condition-btn').addEventListener('click', function() {
            addDynamicCondition(this.previousElementSibling);
        });

        handleExclusiveInputs(addedGroupElement);
        groupIndex++;
        toggleCondicaoFields();
    }

    function addDynamicCondition(condContainer, data = {}) {
        const groupIndex = condContainer.closest('.grupo-condicao').querySelector('input[name*="posicao_exata"]').name.split('-')[1];
        const condIndex = condContainer.children.length;

        const varOptions = variaveisData.map(v => `<option value="${v.id}" ${data.variavel_id == v.id ? 'selected' : ''}>${v.nome_exibicao}</option>`).join('');
        const opOptions = `
            <option value=">=" ${data.operador == '>=' ? 'selected' : ''}>&ge;</option>
            <option value="==" ${data.operador == '==' ? 'selected' : ''}>==</option>
            <option value="<=" ${data.operador == '<=' ? 'selected' : ''}>&le;</option>
        `;

        const html = `
            <div class="input-group input-group-sm mb-2 dynamic-condition">
                <select class="form-select" name="grupo-${groupIndex}-cond-var-${condIndex}">${varOptions}</select>
                <select class="form-select" name="grupo-${groupIndex}-cond-op-${condIndex}">${opOptions}</select>
                <input type="number" class="form-control" name="grupo-${groupIndex}-cond-val-${condIndex}" value="${data.valor || ''}" placeholder="Valor">
                <button class="btn btn-outline-danger remove-dynamic-condition-btn" type="button"><i class="fas fa-times"></i></button>
            </div>
        `;
        condContainer.insertAdjacentHTML('beforeend', html);
    }
    
    container.addEventListener('click', function(e) {
        if (e.target.closest('.remove-grupo-btn')) { e.target.closest('.grupo-condicao').parentElement.remove(); }
        if (e.target.closest('.remove-dynamic-condition-btn')) { e.target.closest('.dynamic-condition').remove(); }
    });
    
    function toggleCondicaoFields() { /* ... (sem alterações) ... */ }
    
    gatilhoSelect.addEventListener('change', toggleCondicaoFields);

    if (gruposExistentes && gruposExistentes.length > 0) {
        gruposExistentes.forEach(grupo => addGrupo(grupo));
    } else {
        addGrupo();
    }
});
</script>
{% endblock %}