{% extends 'base.html' %}
{% load static %}
{% block title %}{{ titulo }}{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<style>
    .grupo-condicao { border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #f8f9fa; }
    .grupo-condicao .grupo-header { border-bottom: 1px solid #ccc; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
    .condicao-field { display: none; }
    .condicao-field input:disabled { background-color: #e9ecef; cursor: not-allowed; }
    .dynamic-condition { gap: 0.5rem; }
    .context-field { display: none; margin-top: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    {% include 'gestao/includes/_submenu_gamificacao.html' with active_tab='campanhas' %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0">{{ titulo }}</h2>
        <a href="{% url 'gestao:listar_campanhas' %}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i>Voltar</a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-4 p-md-5">
            <form method="POST">
                {% csrf_token %}
                <h5 class="h6 mb-3 border-bottom pb-2">Dados Gerais da Campanha</h5>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.nome.label }}</label>{{ form.nome }}</div>
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.gatilho.label }}</label>{{ form.gatilho }}</div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3" id="simulado-especifico-wrapper" style="display: none;">
                        <label for="{{ form.simulado_especifico.id_for_label }}" class="form-label">{{ form.simulado_especifico.label }}</label>
                        {{ form.simulado_especifico }}
                        <div class="form-text">{{ form.simulado_especifico.help_text }}</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.data_inicio.label }}</label>{{ form.data_inicio }}</div>
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.data_fim.label }}</label>{{ form.data_fim }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.tipo_recorrencia.label }}</label>{{ form.tipo_recorrencia }}</div>
                    <div class="col-md-6 mb-3 align-self-center"><div class="form-check form-switch">{{ form.ativo }}<label class="form-check-label" for="{{ form.ativo.id_for_label }}">{{ form.ativo.label }}</label></div></div>
                </div>

                <hr class="my-4">
                <h5 class="h6 mb-3 border-bottom pb-2">Grupos de Condições e Recompensas</h5>
                <div id="grupos-container"></div>
                <button type="button" id="add-grupo-btn" class="btn btn-outline-success mt-2"><i class="fas fa-plus me-2"></i>Adicionar Grupo de Recompensa</button>
            
                <div class="mt-5 d-flex justify-content-center">
                    <button type="submit" class="btn btn-primary btn-lg px-5">Salvar Campanha</button>
                </div>
            </form>
        </div>
    </div>
</div>

<template id="grupo-template">
    <div class="grupo-condicao">
        <div class="d-flex justify-content-between align-items-center grupo-header">
            <h6 class="mb-0 group-title">Grupo de Recompensa</h6>
            <button type="button" class="btn-close remove-grupo-btn" aria-label="Close"></button>
        </div>
        <div class="mb-3">
            <label class="form-label small text-muted">Nome do Grupo (opcional)</label>
            <input type="text" name="grupo-__INDEX__-nome_grupo" class="form-control form-control-sm" placeholder="Ex: Prêmios Top 3, Maratonista de Bronze">
        </div>
        <div class="row">
            <div class="col-md-6">
                <label class="form-label fw-bold small text-muted">Condições Específicas do Gatilho</label>
                <div class="condicao-field p-2 border rounded bg-light" data-gatilho="RANKING">
                    <p class="small text-muted mb-2">Use apenas um dos campos abaixo.</p>
                    <input type="number" name="grupo-__INDEX__-posicao_exata" class="form-control mb-2 form-control-sm" placeholder="Posição Exata (Ex: 1)" data-input-type="posicao_exata">
                    <input type="number" name="grupo-__INDEX__-posicao_ate" class="form-control form-control-sm" placeholder="Até a Posição (Ex: 3)" data-input-type="posicao_ate">
                </div>
                <div class="condicao-field p-2 border rounded bg-light" data-gatilho="SIMULADO">
                    <input type="number" name="grupo-__INDEX__-min_acertos_percent" class="form-control form-control-sm" placeholder="Mínimo de Acertos (%)">
                </div>
                <div class="mt-3">
                    <label class="form-label fw-bold small text-muted">Condições Gerais (opcional)</label>
                    <div class="dynamic-conditions-container"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary w-100 mt-2 add-dynamic-condition-btn"><i class="fas fa-plus"></i> Adicionar Condição Geral</button>
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold small text-muted">Recompensas</label>
                <div class="p-2 border rounded bg-light">
                    <label class="form-label">XP Extra</label>
                    <input type="number" name="grupo-__INDEX__-xp_extra" class="form-control form-control-sm mb-2" value="0">
                    <label class="form-label">Moedas Extras</label>
                    <input type="number" name="grupo-__INDEX__-moedas_extras" class="form-control form-control-sm mb-2" value="0">
                    <label class="form-label mt-2">Avatares</label><select name="grupo-__INDEX__-avatares" multiple></select>
                    <label class="form-label mt-2">Bordas</label><select name="grupo-__INDEX__-bordas" multiple></select>
                    <label class="form-label mt-2">Banners</label><select name="grupo-__INDEX__-banners" multiple></select>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
{{ avatares_disponiveis|json_script:"avatares-data" }}
{{ bordas_disponiveis|json_script:"bordas-data" }}
{{ banners_disponiveis|json_script:"banners-data" }}
{{ grupos_de_condicoes|json_script:"grupos-existentes-data" }}
{{ variaveis_disponiveis|json_script:"variaveis-data" }}
{{ disciplinas_disponiveis|json_script:"disciplinas-data" }}

<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Carregamento de dados
    const avataresData = JSON.parse(document.getElementById('avatares-data').textContent);
    const bordasData = JSON.parse(document.getElementById('bordas-data').textContent);
    const bannersData = JSON.parse(document.getElementById('banners-data').textContent);
    const gruposExistentes = JSON.parse(document.getElementById('grupos-existentes-data').textContent);
    const variaveisData = JSON.parse(document.getElementById('variaveis-data').textContent);
    const disciplinasData = JSON.parse(document.getElementById('disciplinas-data').textContent);

    // Seletores de elementos do DOM
    const gatilhoSelect = document.getElementById('id_gatilho_select');
    const container = document.getElementById('grupos-container');
    const addBtn = document.getElementById('add-grupo-btn');
    const template = document.getElementById('grupo-template');
    const simuladoWrapper = document.getElementById('simulado-especifico-wrapper');
    let groupIndex = 0;

    function createTomSelect(element, options) {
        if (!element || (element.tomselect && !element.tomselect.recreate)) { return; }
        new TomSelect(element, { options: options, valueField: 'id', labelField: 'nome', searchField: 'nome', plugins: ['remove_button'], create: false, placeholder: 'Selecione um ou mais itens...' });
    }

    function handleExclusiveInputs(groupElement) { /* ... (código existente, sem alterações) ... */ }

    function updateGroupTitles() {
        container.querySelectorAll('.grupo-condicao').forEach((group, index) => {
            const title = group.querySelector('.group-title');
            if (title) title.textContent = `Grupo de Recompensa #${index + 1}`;
        });
    }

    function handleContextVisibility(variavelSelect) {
        const wrapper = variavelSelect.closest('.dynamic-condition-wrapper');
        const contextField = wrapper.querySelector('.context-field');
        
        function toggle() {
            const selectedOptionText = variavelSelect.options[variavelSelect.selectedIndex]?.dataset.text || '';
            if (selectedOptionText.includes('acertos') || selectedOptionText.includes('respostas')) {
                contextField.style.display = 'block';
            } else {
                contextField.style.display = 'none';
                contextField.querySelector('select').value = '';
            }
        }
        variavelSelect.addEventListener('change', toggle);
        toggle();
    }

    function addDynamicCondition(condContainer, currentGroupIndex, data = {}) {
        const condIndex = condContainer.children.length;
        const varOptions = variaveisData.map(v => `<option value="${v.id}" data-text="${v.nome_exibicao.toLowerCase()}" ${data.variavel_id == v.id ? 'selected' : ''}>${v.nome_exibicao}</option>`).join('');
        const opOptions = `<option value=">=" ${data.operador == '>=' ? 'selected' : ''}>&ge;</option><option value="==" ${data.operador == '==' ? 'selected' : ''}>==</option><option value="<=" ${data.operador == '<=' ? 'selected' : ''}>&le;</option>`;
        
        const conditionWrapper = document.createElement('div');
        conditionWrapper.className = 'dynamic-condition-wrapper mb-2';
        
        const disciplinaContexto = data.contexto ? data.contexto.disciplina_id : '';
        const disciplinaOptions = disciplinasData.map(d => `<option value="${d.id}" ${disciplinaContexto == d.id ? 'selected' : ''}>${d.nome}</option>`).join('');

        let html = `
            <div class="input-group input-group-sm dynamic-condition">
                <select class="form-select" name="grupo-${currentGroupIndex}-cond-var-${condIndex}"><option value="">Variável...</option>${varOptions}</select>
                <select class="form-select" name="grupo-${currentGroupIndex}-cond-op-${condIndex}">${opOptions}</select>
                <input type="number" class="form-control" name="grupo-${currentGroupIndex}-cond-val-${condIndex}" value="${data.valor || ''}" placeholder="Valor">
                <button class="btn btn-outline-danger remove-dynamic-condition-btn" type="button"><i class="fas fa-times"></i></button>
            </div>
            <div class="context-field">
                <select class="form-select form-select-sm" name="grupo-${currentGroupIndex}-cond-ctx-disciplina-${condIndex}">
                    <option value="">Qualquer Disciplina</option>${disciplinaOptions}
                </select>
            </div>`;
        
        conditionWrapper.innerHTML = html;
        condContainer.appendChild(conditionWrapper);
        
        handleContextVisibility(conditionWrapper.querySelector('select[name$="-var-' + condIndex + '"]'));
    }

    function addGrupo(data = {}) {
        const clone = template.content.cloneNode(true);
        const grupoDiv = clone.querySelector('.grupo-condicao');
        grupoDiv.innerHTML = grupoDiv.innerHTML.replace(/__INDEX__/g, groupIndex);
        container.appendChild(grupoDiv);
        const addedGroupElement = container.lastElementChild;
        
        createTomSelect(addedGroupElement.querySelector('select[name$="-avatares"]'), avataresData);
        createTomSelect(addedGroupElement.querySelector('select[name$="-bordas"]'), bordasData);
        createTomSelect(addedGroupElement.querySelector('select[name$="-banners"]'), bannersData);
        
        if (Object.keys(data).length > 0) {
            addedGroupElement.querySelector('[name$="-nome_grupo"]').value = data.nome_grupo || '';
            addedGroupElement.querySelector('[name$="-posicao_exata"]').value = data.condicao_posicao_exata || '';
            addedGroupElement.querySelector('[name$="-posicao_ate"]').value = data.condicao_posicao_ate || '';
            addedGroupElement.querySelector('[name$="-min_acertos_percent"]').value = data.condicao_min_acertos_percent || '';
            addedGroupElement.querySelector('[name$="-xp_extra"]').value = data.xp_extra || 0;
            addedGroupElement.querySelector('[name$="-moedas_extras"]').value = data.moedas_extras || 0;
            
            ['avatares', 'bordas', 'banners'].forEach(key => {
                const select = addedGroupElement.querySelector(`select[name$="-${key}"]`);
                if (select && select.tomselect && data[key]) { select.tomselect.setValue(data[key]); }
            });

            if (data.condicoes) {
                const dynamicContainer = addedGroupElement.querySelector('.dynamic-conditions-container');
                data.condicoes.forEach(cond => addDynamicCondition(dynamicContainer, groupIndex, cond));
            }
        }
        
        const currentGroupIndex = groupIndex;
        addedGroupElement.querySelector('.add-dynamic-condition-btn').addEventListener('click', function() {
            addDynamicCondition(addedGroupElement.querySelector('.dynamic-conditions-container'), currentGroupIndex);
        });

        handleExclusiveInputs(addedGroupElement);
        groupIndex++;
        toggleCondicaoFields();
        updateGroupTitles();
    }
    
    function toggleCondicaoFields() { /* ... (código existente, sem alterações) ... */ }
    function toggleSimuladoField() { /* ... (código existente, sem alterações) ... */ }

    container.addEventListener('click', function(e) {
        if (e.target.closest('.remove-grupo-btn')) { e.target.closest('.grupo-condicao').remove(); updateGroupTitles(); }
        if (e.target.closest('.remove-dynamic-condition-btn')) { e.target.closest('.dynamic-condition-wrapper').remove(); }
    });
    
    addBtn.addEventListener('click', () => addGrupo({}));
    gatilhoSelect.addEventListener('change', () => { toggleCondicaoFields(); toggleSimuladoField(); });

    if (gruposExistentes && gruposExistentes.length > 0) {
        gruposExistentes.forEach(grupo => addGrupo(grupo));
    } else {
        addGrupo({});
    }
    
    toggleCondicaoFields();
    toggleSimuladoField();
});
</script>
{% endblock %}