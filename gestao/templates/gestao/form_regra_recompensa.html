<!-- gestao/templates/gestao/form_regra_recompensa.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}{{ titulo }}{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<style>
    .grupo-condicao { border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #f8f9fa; }
    .grupo-condicao h6 { border-bottom: 1px solid #ccc; padding-bottom: 0.5rem; margin-bottom: 1rem; }
    .condicao-field { display: none; }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- CORREÇÃO DA ABA ATIVA -->
    {% include 'gestao/includes/_submenu_gamificacao.html' with active_tab='campanhas' %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0">{{ titulo }}</h2>
        <!-- CORREÇÃO DA URL AQUI -->
        <a href="{% url 'gestao:listar_campanhas' %}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i>Voltar</a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-4 p-md-5">
            <form method="POST">
                {% csrf_token %}
                <h5 class="h6 mb-3 border-bottom pb-2">Dados Gerais da Campanha</h5>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.nome.label }}</label>{{ form.nome }}</div>
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.gatilho.label }}</label>{{ form.gatilho }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.data_inicio.label }}</label>{{ form.data_inicio }}</div>
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.data_fim.label }}</label>{{ form.data_fim }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">{{ form.tipo_recorrencia.label }}</label>{{ form.tipo_recorrencia }}</div>
                    <div class="col-md-6 mb-3 align-self-center"><div class="form-check form-switch">{{ form.ativo }}<label class="form-check-label" for="{{ form.ativo.id_for_label }}">{{ form.ativo.label }}</label></div></div>
                </div>

                <hr class="my-4">
                <h5 class="h6 mb-3 border-bottom pb-2">Grupos de Condições e Recompensas</h5>
                <div id="grupos-container">
                    <!-- Grupos existentes serão renderizados aqui pelo JavaScript -->
                </div>
                <button type="button" id="add-grupo-btn" class="btn btn-outline-success mt-2"><i class="fas fa-plus me-2"></i>Adicionar Grupo de Recompensa</button>
            
                <div class="mt-5 d-flex justify-content-center">
                    <button type="submit" class="btn btn-primary btn-lg px-5">Salvar Campanha</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Template para um novo grupo de condição, usado pelo JavaScript -->
<template id="grupo-template">
    <div class="grupo-condicao">
        <div class="d-flex justify-content-between align-items-center">
            <h6>Grupo de Recompensa</h6>
            <button type="button" class="btn-close remove-grupo-btn" aria-label="Close"></button>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="condicao-field" data-gatilho="RANKING">
                    <label class="form-label">Posição Exata</label>
                    <input type="number" name="grupo-__INDEX__-posicao_exata" class="form-control mb-2" placeholder="Ex: 1">
                </div>
                <div class="condicao-field" data-gatilho="RANKING">
                    <label class="form-label">Até a Posição (Top N)</label>
                    <input type="number" name="grupo-__INDEX__-posicao_ate" class="form-control mb-2" placeholder="Ex: 3 (para Top 3)">
                </div>
                <div class="condicao-field" data-gatilho="SIMULADO">
                    <label class="form-label">Mínimo de Acertos (%)</label>
                    <input type="number" name="grupo-__INDEX__-min_acertos_percent" class="form-control mb-2" placeholder="Ex: 80">
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label">XP Extra</label>
                <input type="number" name="grupo-__INDEX__-xp_extra" class="form-control mb-2" value="0">
                <label class="form-label">Moedas Extras</label>
                <input type="number" name="grupo-__INDEX__-moedas_extras" class="form-control mb-2" value="0">
            </div>
        </div>
        <div class="mt-2">
            <label class="form-label">Avatares</label><select name="grupo-__INDEX__-avatares" multiple></select>
            <label class="form-label mt-2">Bordas</label><select name="grupo-__INDEX__-bordas" multiple></select>
            <label class="form-label mt-2">Banners</label><select name="grupo-__INDEX__-banners" multiple></select>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
{{ avatares_json|json_script:"avatares-data" }}
{{ bordas_json|json_script:"bordas-data" }}
{{ banners_json|json_script:"banners-data" }}
{% if campanha %}{{ campanha.grupos_de_condicoes|json_script:"grupos-existentes-data" }}{% else %}{{ '[]'|json_script:"grupos-existentes-data" }}{% endif %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const avataresData = JSON.parse(document.getElementById('avatares-data').textContent);
    const bordasData = JSON.parse(document.getElementById('bordas-data').textContent);
    const bannersData = JSON.parse(document.getElementById('banners-data').textContent);
    const gruposExistentes = JSON.parse(document.getElementById('grupos-existentes-data').textContent);

    const gatilhoSelect = document.getElementById('id_gatilho_select');
    const container = document.getElementById('grupos-container');
    const addBtn = document.getElementById('add-grupo-btn');
    const template = document.getElementById('grupo-template');
    let groupIndex = 0;

    function createTomSelect(element, options) {
        new TomSelect(element, { options: options, valueField: 'id', labelField: 'nome', searchField: 'nome', plugins: ['remove_button'], create: false, placeholder: 'Selecione um ou mais itens...' });
    }

    function addGrupo(data = {}) {
        const clone = template.content.cloneNode(true);
        const grupoDiv = clone.querySelector('.grupo-condicao');
        
        grupoDiv.innerHTML = grupoDiv.innerHTML.replace(/__INDEX__/g, groupIndex);
        container.appendChild(clone);

        const newGroup = container.children[container.children.length - 1];
        createTomSelect(newGroup.querySelector('select[name$="-avatares"]'), avataresData);
        createTomSelect(newGroup.querySelector('select[name$="-bordas"]'), bordasData);
        createTomSelect(newGroup.querySelector('select[name$="-banners"]'), bannersData);

        if (Object.keys(data).length > 0) {
            newGroup.querySelector('[name$="-posicao_exata"]').value = data.condicao_posicao_exata || '';
            newGroup.querySelector('[name$="-posicao_ate"]').value = data.condicao_posicao_ate || '';
            newGroup.querySelector('[name$="-min_acertos_percent"]').value = data.condicao_min_acertos_percent || '';
            newGroup.querySelector('[name$="-xp_extra"]').value = data.xp_extra || 0;
            newGroup.querySelector('[name$="-moedas_extras"]').value = data.moedas_extras || 0;
            Object.keys(data).forEach(key => {
                if (Array.isArray(data[key]) && newGroup.querySelector(`select[name$="-${key}"]`)) {
                    const tomselect = newGroup.querySelector(`select[name$="-${key}"]`).tomselect;
                    tomselect.setValue(data[key]);
                }
            });
        }
        
        groupIndex++;
        toggleCondicaoFields();
    }

    function toggleCondicaoFields() {
        const selectedGatilho = gatilhoSelect.value;
        const allCondicaoFields = container.querySelectorAll('.condicao-field');
        
        allCondicaoFields.forEach(field => {
            if (selectedGatilho.includes('RANKING') && field.dataset.gatilho === 'RANKING') {
                field.style.display = 'block';
            } else if (selectedGatilho.includes('SIMULADO') && field.dataset.gatilho === 'SIMULADO') {
                field.style.display = 'block';
            } else {
                field.style.display = 'none';
            }
        });
    }

    addBtn.addEventListener('click', () => addGrupo());
    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-grupo-btn')) {
            e.target.closest('.grupo-condicao').remove();
        }
    });
    
    gatilhoSelect.addEventListener('change', toggleCondicaoFields);

    if (gruposExistentes && gruposExistentes.length > 0) {
        gruposExistentes.forEach(grupo => addGrupo(grupo));
    } else {
        addGrupo();
    }
});
</script>
{% endblock %}