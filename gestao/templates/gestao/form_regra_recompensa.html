<!-- gestao/templates/gestao/form_regra_recompensa.html (INTEGRAL) -->
{% extends 'base.html' %}
{% load static %}
{% block title %}{{ titulo }}{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<style>
    .ts-control {
        padding: 0.375rem 0.75rem;
        min-height: calc(1.5em + 0.75rem + 2px);
    }
    /* Classe para ocultar os campos de condição dinamicamente */
    .condicao-field {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    {% include 'gestao/includes/_submenu_gamificacao.html' with active_tab='regras' %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0">{{ titulo }}</h2>
        <a href="{% url 'gestao:listar_regras_recompensa' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-4 p-md-5">
            <form method="POST">
                {% csrf_token %}

                <h5 class="h6 mb-3 border-bottom pb-2">Dados Gerais</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.nome.id_for_label }}" class="form-label">{{ form.nome.label }}</label>
                        {{ form.nome }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.gatilho.id_for_label }}" class="form-label">{{ form.gatilho.label }}</label>
                        {{ form.gatilho }}
                    </div>
                </div>
                <div class="form-check form-switch mb-4">
                    {{ form.ativo }}
                    <label class="form-check-label" for="{{ form.ativo.id_for_label }}">{{ form.ativo.label }}</label>
                </div>
                
                <h5 class="h6 mb-3 border-bottom pb-2">Condições e Recompensas</h5>
                
                <!-- CAMPOS DE CONDIÇÃO DINÂMICOS -->
                <div id="condicao-ranking" class="condicao-field mb-3">
                    <label for="{{ form.condicao_top_n.id_for_label }}" class="form-label">{{ form.condicao_top_n.label }}</label>
                    {{ form.condicao_top_n }}
                    <div class="form-text">{{ form.condicao_top_n.help_text }}</div>
                </div>
                <div id="condicao-simulado" class="condicao-field mb-3">
                    <label for="{{ form.condicao_min_acertos_percent.id_for_label }}" class="form-label">{{ form.condicao_min_acertos_percent.label }}</label>
                    {{ form.condicao_min_acertos_percent }}
                     <div class="form-text">{{ form.condicao_min_acertos_percent.help_text }}</div>
                </div>

                <div class="mb-3">
                    <label for="{{ form.xp_extra.id_for_label }}" class="form-label">{{ form.xp_extra.label }}</label>
                    {{ form.xp_extra }}
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.avatares.id_for_label }}" class="form-label">{{ form.avatares.label }}</label>
                    {{ form.avatares }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.bordas.id_for_label }}" class="form-label">{{ form.bordas.label }}</label>
                    {{ form.bordas }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.banners.id_for_label }}" class="form-label">{{ form.banners.label }}</label>
                    {{ form.banners }}
                </div>

                <div class="mt-4 d-flex justify-content-center">
                    <button type="submit" class="btn btn-primary btn-lg px-5">Salvar Regra</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.tom-select').forEach((el) => {
        new TomSelect(el, {
            plugins: ['remove_button'], create: false, placeholder: 'Selecione um ou mais itens...'
        });
    });

    const gatilhoSelect = document.getElementById('id_gatilho_select');
    const condicaoRankingDiv = document.getElementById('condicao-ranking');
    const condicaoSimuladoDiv = document.getElementById('condicao-simulado');

    function toggleCondicaoFields() {
        const selectedGatilho = gatilhoSelect.value;
        
        // Esconde todos por padrão
        condicaoRankingDiv.style.display = 'none';
        condicaoSimuladoDiv.style.display = 'none';

        if (selectedGatilho === 'RANKING_SEMANAL_TOP_N' || selectedGatilho === 'RANKING_MENSAL_TOP_N') {
            condicaoRankingDiv.style.display = 'block';
        } else if (selectedGatilho === 'COMPLETAR_SIMULADO') {
            condicaoSimuladoDiv.style.display = 'block';
        }
    }

    gatilhoSelect.addEventListener('change', toggleCondicaoFields);
    toggleCondicaoFields(); // Executa na inicialização da página
});
</script>
{% endblock %}