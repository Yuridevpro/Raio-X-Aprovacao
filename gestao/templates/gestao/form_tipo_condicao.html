<!-- gestao/templates/gestao/form_tipo_condicao.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}{{ titulo }}{% endblock %}

{% block head %}
<style>
    .parametro-item {
        display: flex;
        gap: 1rem;
        align-items: center;
        padding: 1rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0">{{ titulo }}</h2>
        <a href="{% url 'gestao:listar_tipos_condicao' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar para a Lista
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-4 p-md-5">
            <form method="POST" id="tipo-condicao-form">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="form-label">{{ form.nome.label }}</label>
                    {{ form.nome }}
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.chave.label }}</label>
                    {{ form.chave }}
                    <div class="form-text">{{ form.chave.help_text }}</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ form.descricao.label }}</label>
                    {{ form.descricao }}
                </div>

                <hr class="my-4">
                <h5 class="h6 mb-3">Parâmetros Configuráveis</h5>
                <p class="text-muted small">Defina aqui quais campos o administrador poderá preencher ao usar esta condição em uma conquista.</p>
                
                <!-- O textarea JSON agora fica oculto -->
                {{ form.parametros_configuraveis }}

                <!-- Container para o construtor visual de parâmetros -->
                <div id="parametros-container" class="mb-3">
                    <!-- Parâmetros existentes serão renderizados aqui pelo JS -->
                </div>

                <button type="button" id="add-parametro-btn" class="btn btn-outline-success btn-sm">
                    <i class="fas fa-plus me-2"></i>Adicionar Parâmetro
                </button>

                <div class="mt-4 d-flex justify-content-center">
                    <button type="submit" class="btn btn-primary btn-lg px-5">Salvar Tipo de Condição</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Template para um novo parâmetro, usado pelo JavaScript -->
<template id="parametro-template">
    <div class="parametro-item">
        <div class="flex-grow-1">
            <label class="form-label small">Nome do Parâmetro (chave)</label>
            <input type="text" class="form-control form-control-sm parametro-nome" placeholder="Ex: quantidade">
        </div>
        <div class="flex-grow-1">
            <label class="form-label small">Tipo de Campo</label>
            <select class="form-select form-select-sm parametro-tipo">
                <option value="number">Número</option>
                <option value="text">Texto</option>
                <option value="select_disciplina">Seleção de Disciplina</option>
                <option value="select_assunto">Seleção de Assunto</option>
                <option value="select_banca">Seleção de Banca</option>
            </select>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger remove-parametro-btn mt-3">&times;</button>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('tipo-condicao-form');
    const container = document.getElementById('parametros-container');
    const addBtn = document.getElementById('add-parametro-btn');
    const template = document.getElementById('parametro-template');
    const jsonTextarea = document.getElementById('id_parametros_configuraveis');

    // Esconde o textarea original para o usuário
    jsonTextarea.style.display = 'none';
    if (jsonTextarea.previousElementSibling) {
        jsonTextarea.previousElementSibling.style.display = 'none';
    }

    // Função para adicionar uma nova linha de parâmetro ao construtor
    function addParametro(nome = '', tipo = 'number') {
        const clone = template.content.cloneNode(true);
        clone.querySelector('.parametro-nome').value = nome;
        clone.querySelector('.parametro-tipo').value = tipo;
        container.appendChild(clone);
    }

    // Carrega os parâmetros existentes do JSON para a interface visual
    function carregarParametros() {
        try {
            const data = JSON.parse(jsonTextarea.value || '{}');
            Object.entries(data).forEach(([nome, tipo]) => {
                addParametro(nome, tipo);
            });
        } catch (e) {
            console.error('Erro ao parsear o JSON de parâmetros:', e);
            // Se o JSON for inválido, deixa o construtor vazio
        }
    }

    // Sincroniza a interface visual de volta para o textarea JSON oculto
    function sincronizarJson() {
        const parametros = {};
        container.querySelectorAll('.parametro-item').forEach(item => {
            const nome = item.querySelector('.parametro-nome').value.trim();
            const tipo = item.querySelector('.parametro-tipo').value;
            if (nome) { // Apenas adiciona se o nome do parâmetro for preenchido
                parametros[nome] = tipo;
            }
        });
        jsonTextarea.value = JSON.stringify(parametros, null, 4); // Formatação para facilitar a depuração
    }

    // Event Listeners
    addBtn.addEventListener('click', () => addParametro());

    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-parametro-btn')) {
            e.target.closest('.parametro-item').remove();
        }
    });

    // Sincroniza o JSON antes de enviar o formulário
    form.addEventListener('submit', sincronizarJson);
    
    // Inicializa o construtor com os dados existentes
    carregarParametros();
});
</script>
{% endblock %}