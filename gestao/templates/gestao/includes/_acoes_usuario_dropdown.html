{% load gestao_extras %}

<div class="dropdown">
    <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100" 
            type="button" id="actions-{{ usuario.id }}" data-bs-toggle="dropdown" 
            aria-expanded="false">
        <i class="fas fa-cog"></i> Ações
    </button>
    
    <ul class="dropdown-menu" aria-labelledby="actions-{{ usuario.id }}">
        <!-- Ações de Superusuário -->
        {% if request.user.is_superuser %}
            {% if usuario.is_superuser %}
                {% if usuario != request.user %}
                    <li><a class="dropdown-item text-warning" href="{% url 'gestao:solicitar_despromocao_superuser' usuario.id %}"><i class="fas fa-user-graduate fa-fw me-2"></i>Solicitar Despromoção</a></li>
                {% endif %}
            {% else %}
                <li><a class="dropdown-item" href="{% url 'gestao:editar_usuario_staff' usuario.id %}"><i class="fas fa-edit fa-fw me-2"></i>Editar Permissões</a></li>
                {% if usuario != request.user %}
                    <li>
                        {% get_superuser_count as superuser_count %}
                        {% if superuser_count <= 1 %}
                            <!-- Promoção Direta se for o único SU -->
                            <form id="form-promover-direto-{{ usuario.id }}" method="POST" action="{% url 'gestao:promover_diretamente_superuser' usuario.id %}">
                                {% csrf_token %}
                                <button type="button" class="dropdown-item text-success btn-confirm-action"
                                        data-form-id="form-promover-direto-{{ usuario.id }}"
                                        data-modal-title="Confirmar Promoção Direta"
                                        data-modal-body="Você é o único Superusuário. Deseja promover {{ usuario.username }} diretamente, sem necessidade de aprovação?">
                                    <i class="fas fa-user-check fa-fw me-2"></i>Promover Diretamente
                                </button>
                            </form>
                        {% else %}
                            <!-- Solicitação de Promoção -->
                            <a class="dropdown-item text-success" href="{% url 'gestao:solicitar_promocao_superuser' usuario.id %}"><i class="fas fa-rocket fa-fw me-2"></i>Solicitar Promoção</a>
                        {% endif %}
                    </li>
                {% endif %}
            {% endif %}
        {% endif %}

        <!-- Ações de Exclusão -->
        {% if usuario != request.user and request.user.is_staff %}
            <li><hr class="dropdown-divider"></li>
            <li>
                {% if request.user.is_superuser %}
                    {% if usuario.is_superuser %}
                        <a class="dropdown-item text-danger" href="{% url 'gestao:solicitar_exclusao_superuser' usuario.id %}"><i class="fas fa-user-times fa-fw me-2"></i>Solicitar Exclusão</a>
                    {% else %}
                        <button type="button" class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deletarUsuarioModal" data-user-id="{{ usuario.id }}" data-user-username="{{ usuario.username }}"><i class="fas fa-trash fa-fw me-2"></i>Excluir Usuário</button>
                    {% endif %}
                {% elif not usuario.is_staff and not usuario.is_superuser %}
                    <button type="button" class="dropdown-item text-warning" data-bs-toggle="modal" data-bs-target="#sugerirExclusaoModal" data-user-id="{{ usuario.id }}" data-user-username="{{ usuario.username }}"><i class="fas fa-flag fa-fw me-2"></i>Sugerir Exclusão</button>
                {% endif %}
            </li>
        {% endif %}
    </ul>
</div>