<!-- gestao/templates/gestao/listar_notificacoes_agrupadas.html -->
{% extends 'base.html' %}
{% load static %}
{% load questoes_extras %}

{% block title %}Gerenciar Notificações{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/listagem-comum.css' %}">
<style>
    :root {
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        --card-shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    .summary-card { transition: all 0.3s ease-in-out; }
    .summary-card:hover { transform: translateY(-5px); box-shadow: var(--card-shadow-hover); }
    
    .card-notification-group { transition: all 0.2s ease-in-out, opacity 0.5s ease; border-radius: var(--raio-borda); box-shadow: var(--card-shadow); }
    .card-notification-group:hover { transform: translateY(-4px); box-shadow: var(--card-shadow-hover); }
    .card-notification-group.status-PENDENTE { border-left: 5px solid var(--cor-aviso); }
    .card-notification-group.status-RESOLVIDO { border-left: 5px solid var(--cor-sucesso); }
    .card-notification-group.status-REJEITADO { border-left: 5px solid var(--cor-erro); }
    
    .card-notification-group.removing { transform: scale(0.95); opacity: 0; }

    .reports-container.is-expanded {
        max-height: 250px;
        overflow-y: auto;
        border-radius: 0.5rem;
        border: 1px solid var(--cor-borda);
        padding: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 py-md-5">
    <div class="mb-4"><a href="{% url 'gestao:dashboard' %}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-2"></i>Voltar ao Painel</a></div>
    
    <div class="text-center mb-5">
        <h2 class="display-6">Gerenciamento de Notificações</h2>
        <p class="text-muted fs-5">Revise e gerencie os erros reportados pelos usuários.</p>
    </div>
    
    {% if messages %}{% for message in messages %}<div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endfor %}{% endif %}

    <!-- CARDS DE RESUMO -->
    <div class="row g-4 mb-5">
        <div class="col-6 col-md-4"><div class="card h-100 summary-card"><div class="card-body text-center"><h5 class="card-title text-danger">{{ stats.pendentes_total }}</h5><p class="card-text text-muted mb-0">Pendentes</p></div></div></div>
        <div class="col-6 col-md-4"><div class="card h-100 summary-card"><div class="card-body text-center"><h5 class="card-title text-success">{{ stats.resolvidas_total }}</h5><p class="card-text text-muted mb-0">Corrigidos</p></div></div></div>
        <div class="col-6 col-md-4"><div class="card h-100 summary-card"><div class="card-body text-center"><h5 class="card-title">{{ stats.rejeitadas_total }}</h5><p class="card-text text-muted mb-0">Rejeitados</p></div></div></div>
    </div>

    <!-- NAVEGAÇÃO POR STATUS -->
    <ul class="nav nav-pills justify-content-center border-bottom pb-3 mb-4">
        <li class="nav-item"><a class="nav-link {% if status_ativo == 'PENDENTE' %}active{% endif %}" href="?status=PENDENTE">Pendentes</a></li>
        <li class="nav-item"><a class="nav-link {% if status_ativo == 'RESOLVIDO' %}active{% endif %}" href="?status=RESOLVIDO">Corrigidos</a></li>
        <li class="nav-item"><a class="nav-link {% if status_ativo == 'REJEITADO' %}active{% endif %}" href="?status=REJEITADO">Rejeitados</a></li>
        <li class="nav-item"><a class="nav-link {% if status_ativo == 'TODAS' %}active{% endif %}" href="?status=TODAS">Todos</a></li>
    </ul>

    <!-- CONTROLES E AÇÕES EM MASSA -->
    <div class="my-4">
        {% include 'gestao/includes/_ordenacao_e_paginacao_controls.html' with paginated_object=questoes_agrupadas sort_options=sort_options sort_by=sort_by per_page=per_page %}
    </div>
    {% if status_ativo != 'TODAS' %}
        {% include 'gestao/includes/_barra_acoes_em_massa_notificacoes.html' %}
    {% endif %}

    <!-- LISTA DE NOTIFICAÇÕES AGRUPADAS -->
    {% for questao in questoes_agrupadas %}
        {% include 'gestao/includes/_card_notificacao_agrupada.html' %}
    {% empty %}
        <div class="text-center p-5 border rounded bg-light mt-4">
            <h4 class="h5">Nenhuma notificação encontrada</h4>
            <p class="text-muted mb-0">Não há notificações com os filtros aplicados.</p>
        </div>
    {% endfor %}

    <!-- PAGINAÇÃO -->
    <div class="mt-4">
        {% include 'includes/_paginacao.html' with paginated_object=questoes_agrupadas %}
    </div>
</div>
{% include 'gestao/includes/_modais_notificacoes.html' %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Função genérica para realizar uma ação (individual ou em massa)
    const performAction = (action, ids, status, successCallback) => {
        const url = (ids.length === 1) ? `/gestao/notificacoes/${ids[0]}/acao-agrupada/` : "{% url 'gestao:notificacoes_acoes_em_massa' %}";
        const isBulk = ids.length > 1;
        const body = isBulk ? JSON.stringify({ ids, action, status_original: status }) : new FormData();
        if (!isBulk) {
            body.append('action', action);
            body.append('status_original', status);
        }

        fetch(url, {
            method: 'POST',
            body: body,
            headers: isBulk ? {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'} : {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(response => response.json().then(data => ({ ok: response.ok, data })))
        .then(({ ok, data }) => {
            if (ok) {
                showNotificationModal('Sucesso!', data.message, 'success', () => {
                    if (isBulk) window.location.reload();
                });
                if (successCallback) successCallback(data);
            } else {
                throw new Error(data.message || 'Ocorreu um erro.');
            }
        })
        .catch(err => showNotificationModal('Erro', err.message, 'error'));
    };
    
    // Delegação de eventos para ações
    document.body.addEventListener('click', function(e) {
        const individualBtn = e.target.closest('.individual-action-btn');
        const bulkBtn = e.target.closest('.bulk-action-btn');
        const toggleReportsBtn = e.target.closest('.toggle-reports-visibility');

        if (individualBtn) {
            e.preventDefault();
            showConfirmationModal('Confirmar Ação', individualBtn.dataset.confirmMessage, () => {
                performAction(individualBtn.dataset.action, [individualBtn.dataset.questaoId], '{{ status_ativo }}', (data) => {
                    const card = document.getElementById(data.removed_card_id);
                    if (card) {
                        card.classList.add('removing');
                        setTimeout(() => card.remove(), 500);
                    }
                });
            });
        }

        if (bulkBtn) {
            e.preventDefault();
            const selectedIds = Array.from(document.querySelectorAll('.notification-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0) {
                showNotificationModal('Atenção', 'Nenhuma questão selecionada.', 'info');
                return;
            }
            showConfirmationModal('Confirmar Ação em Massa', `Aplicar esta ação para ${selectedIds.length} questão(ões)?`, () => {
                performAction(bulkBtn.dataset.action, selectedIds, '{{ status_ativo }}');
            });
        }
        
        if (toggleReportsBtn) {
            e.preventDefault();
            const container = document.querySelector(toggleReportsBtn.dataset.target);
            const isExpanded = container.classList.toggle('is-expanded');
            toggleReportsBtn.textContent = isExpanded ? 'Ver menos' : `Ver todos os ${toggleReportsBtn.dataset.total} reports`;
        }
    });
    
    // Lógica para checkboxes e barra de ações em massa
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const checkboxes = document.querySelectorAll('.notification-checkbox');
    const bulkActionsBar = document.getElementById('bulk-actions-bar');
    const selectedCountSpan = document.getElementById('selected-count');

    const updateBulkActionBar = () => {
        if (!bulkActionsBar) return;
        const count = document.querySelectorAll('.notification-checkbox:checked').length;
        bulkActionsBar.style.display = count > 0 ? 'block' : 'none';
        selectedCountSpan.textContent = count;
        if (selectAllCheckbox) selectAllCheckbox.checked = count > 0 && count === checkboxes.length;
    };

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', () => {
            checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            updateBulkActionBar();
        });
    }
    checkboxes.forEach(cb => cb.addEventListener('change', updateBulkActionBar));

    // Script do modal de visualização rápida (reutilizado)
    const visualizarQuestaoModalEl = document.getElementById('visualizarQuestaoModal');
    if (visualizarQuestaoModalEl) {
        visualizarQuestaoModalEl.addEventListener('show.bs.modal', function(event) {
            const questaoId = event.relatedTarget.dataset.questaoId;
            const content = this.querySelector('#modalQuestaoContent');
            const spinner = this.querySelector('#modalQuestaoSpinner');
            content.style.display = 'none';
            spinner.style.display = 'block';

            fetch(`/gestao/api/visualizar-questao/${questaoId}/`)
                .then(r => r.ok ? r.json() : Promise.reject('Erro'))
                .then(data => {
                    this.querySelector('#modalQuestaoCodigo').textContent = data.codigo;
                    this.querySelector('#modalQuestaoEnunciado').innerHTML = data.enunciado;
                    this.querySelector('#modalQuestaoAlternativas').innerHTML = Object.entries(data.alternativas).map(([k, v]) => `<li class="list-group-item ${k===data.gabarito ? 'list-group-item-success fw-bold':''}">${k}) ${v}</li>`).join('');
                })
                .catch(err => this.querySelector('#modalQuestaoEnunciado').innerHTML = `<div class="alert alert-danger">Erro ao carregar.</div>`)
                .finally(() => { spinner.style.display = 'none'; content.style.display = 'block'; });
        });
    }
});
</script>
{% endblock %}