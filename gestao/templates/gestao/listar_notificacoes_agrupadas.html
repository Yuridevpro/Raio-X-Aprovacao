<!-- gestao/templates/gestao/listar_notificacoes_agrupadas.html -->

{% extends 'base.html' %}
{% load static %}
{% load questoes_extras %}
{% block title %}Gerenciar Notificações{% endblock %}


{% block head %}

<link rel="stylesheet" href="{% static 'css/listagem-comum.css' %}">
<!-- Todos os links de CSS e Fonts que você já tinha -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">


<style>
    :root {
        --cor-primaria: #0d6efd;
        --bs-body-font-family: 'Inter', sans-serif;
        --bs-border-color-translucent: rgba(0, 0, 0, 0.08);
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        --card-shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.1);
        --card-border-radius: 0.75rem;
    }
    body { background-color: #f9fafb; }
    .page-header h2 { font-weight: 700; color: #111827; }
    .summary-card { border-radius: var(--card-border-radius); border: 1px solid var(--bs-border-color-translucent); background-color: #fff; box-shadow: var(--card-shadow); transition: all 0.3s ease-in-out; }
    .summary-card:hover { transform: translateY(-5px); box-shadow: var(--card-shadow-hover); }
    .nav-pills .nav-link { color: #4b5563; font-weight: 600; }
    .nav-pills .nav-link.active { background-color: var(--cor-primaria); color: #fff; }
    .filters-card { background-color: #fff; border: 1px solid var(--bs-border-color-translucent); border-radius: var(--card-border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); }
    
    .card-notification-group { transition: all 0.2s ease-in-out; border-radius: var(--card-border-radius); box-shadow: var(--card-shadow); }
    .card-notification-group:hover { transform: translateY(-4px); box-shadow: var(--card-shadow-hover); }
    .card-notification-group.status-PENDENTE { border-left: 5px solid #ffc107; }
    .card-notification-group.status-EM_ANALISE { border-left: 5px solid #0dcaf0; }
    .card-notification-group.status-RESOLVIDO { border-left: 5px solid #198754; }
    .card-notification-group.status-REJEITADO { border-left: 5px solid #dc3545; }
    .card-notification-group.status-ARQUIVADO { border-left: 5px solid #6c757d; }
    
    .reporter-list-item { font-size: 0.9rem; padding: 0.5rem 0.75rem; }
    .enunciado-formatado p:last-child { margin-bottom: 0; }

    /* Ações no Card - Adiciona borda à esquerda apenas em telas médias ou maiores */
    @media (min-width: 768px) {
        .actions-column {
            border-left: 1px solid var(--bs-border-color-translucent);
        }
    }
    
    /* Ajustes para Telas Pequenas (Mobile) */
    @media (max-width: 767.98px) {
        .page-header h2 {
            font-size: 1.9rem; /* Tamanho mais contido para o título principal */
        }

        /* Coluna de ações se torna uma seção separada por uma linha superior */
        .actions-column {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--bs-border-color-translucent);
        }
        
        /* Garante que o cabeçalho dos resultados não quebre em telas estreitas */
        .header-resultados-agrupados {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 0.25rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 py-md-5">
    <div class="mb-4"><a href="{% url 'gestao:dashboard' %}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-2"></i> Voltar ao Painel</a></div>
    
    <div class="row justify-content-center">
        <div class="col-lg-11 col-xl-10">
            <div class="text-center mb-5 page-header">
                <h2 class="display-6">Gerenciamento de Notificações</h2>
                <p class="text-muted fs-5">Revise e gerencie os erros reportados pelos usuários.</p>
            </div>
            
            {% if messages %}
                {% for message in messages %}
                    <!-- CORREÇÃO: Mensagem de erro bem formatada -->
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Cards de Resumo Simplificados -->
            <div class="row g-4 mb-5">
                <div class="col-6 col-md-4"><div class="card h-100 summary-card"><div class="card-body text-center"><h5 class="card-title text-danger">{{ stats.pendentes_total }}</h5><p class="card-text text-muted mb-0">Pendentes</p></div></div></div>
                <div class="col-6 col-md-4"><div class="card h-100 summary-card"><div class="card-body text-center"><h5 class="card-title text-success">{{ stats.resolvidas_total }}</h5><p class="card-text text-muted mb-0">Corrigidos</p></div></div></div>
                <div class="col-6 col-md-4"><div class="card h-100 summary-card"><div class="card-body text-center"><h5 class="card-title">{{ stats.rejeitadas_total }}</h5><p class="card-text text-muted mb-0">Rejeitados</p></div></div></div>
            </div>

            <!-- Abas de Navegação Simplificadas -->
            <ul class="nav nav-pills justify-content-center border-bottom pb-3 mb-4">
                <li class="nav-item"><a class="nav-link {% if status_ativo == 'PENDENTE' %}active{% endif %}" href="?status=PENDENTE">Pendentes</a></li>
                <li class="nav-item"><a class="nav-link {% if status_ativo == 'RESOLVIDO' %}active{% endif %}" href="?status=RESOLVIDO">Corrigidos</a></li>
                <li class="nav-item"><a class="nav-link {% if status_ativo == 'REJEITADO' %}active{% endif %}" href="?status=REJEITADO">Rejeitados</a></li>
                <li class="nav-item"><a class="nav-link {% if status_ativo == 'TODAS' %}active{% endif %}" href="?status=TODAS">Todos</a></li>
            </ul>

                <!-- BARRA DE AÇÕES EM MASSA (HTML) -->

                {% if status_ativo != 'TODAS' %}
                    <div id="bulk-actions-bar" class="card card-body mb-3 sticky-top" style="display: none; top: 10px; z-index: 1000;">
                        <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="select-all-checkbox"><label class="form-check-label" for="select-all-checkbox"><span id="selected-count" class="fw-bold">0</span> selecionada(s)</label></div>
                        <div class="dropdown">
                            <button class="btn btn-dark dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">Aplicar Ação</button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                {% if status_ativo == 'PENDENTE' %}
                                <li><a class="dropdown-item bulk-action-btn" href="#" data-action="resolver"><i class="fas fa-check-circle text-success fa-fw me-2"></i>Corrigir Selecionados</a></li>
                                <li><a class="dropdown-item bulk-action-btn" href="#" data-action="rejeitar"><i class="fas fa-times-circle text-danger fa-fw me-2"></i>Rejeitar Selecionados</a></li>
                                {% elif status_ativo == 'RESOLVIDO' or status_ativo == 'REJEITADO' %}
                                <li><a class="dropdown-item bulk-action-btn" href="#" data-action="excluir"><i class="fas fa-trash-alt text-danger fa-fw me-2"></i>Excluir Permanentemente</a></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}

            <div class="d-flex justify-content-between align-items-center mb-3 header-resultados-agrupados">
                <h3 class="h5 mb-0 fw-bold">Resultados Agrupados</h3>
                <span class="text-muted">{{ questoes_agrupadas.paginator.count }} quest{{ questoes_agrupadas.paginator.count|pluralize:"ão,ões" }} com reports</span>
            </div>
            
            {% for questao in questoes_agrupadas %}
            <div class="card mb-4 card-notification-group status-{{ status_ativo }}">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        
                        <div class="d-flex align-items-center gap-3">
                            <!-- CHECKBOX INDIVIDUAL PARA CADA GRUPO -->
                            {% if status_ativo != 'TODAS' %}
                            <input class="form-check-input notification-checkbox" type="checkbox" value="" data-id="{{ questao.id }}">
                            {% endif %}
                            <div>
                                <h5 class="mb-0">Questão: <a href="{% url 'gestao:editar_questao' questao.id %}" target="_blank">{{ questao.codigo }}</a><button type="button" class="btn btn-outline-secondary btn-sm py-0 px-1 ms-1 btn-visualizar-questao" data-questao-id="{{ questao.id }}" title="Visualização Rápida"><i class="fas fa-eye"></i></button></h5>
                                {% if questao.ultima_notificacao %}<small class="text-muted">Último report em: {{ questao.ultima_notificacao|date:"d/m/Y H:i" }}</small>{% endif %}
                            </div>
                        </div>
            
                        <span class="badge bg-warning text-dark fs-6 rounded-pill"><i class="fas fa-flag me-1"></i>{{ questao.num_reports }} Report{{ questao.num_reports|pluralize:"s" }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8"><h6 class="mb-2 small text-uppercase fw-bold">Detalhes dos Reports:</h6><ul class="list-group list-group-flush">{% for report in questao.reports_filtrados %}<li class="list-group-item px-0 py-2"><div class="d-flex justify-content-between align-items-center reporter-list-item"><div><strong>{{ report.usuario_reportou.userprofile.nome|default:"N/A" }}</strong><span class="text-muted ms-2">({{ report.get_tipo_erro_display }})</span></div><small class="text-muted">{{ report.data_criacao|date:"d/m H:i" }}</small></div><p class="ms-3 mt-1 mb-0 fst-italic text-muted">"{{ report.descricao }}"</p></li>{% endfor %}</ul></div>
                        <div class="col-md-4 d-flex flex-column justify-content-center align-items-center actions-column">
                            <h6 class="mb-3 small text-uppercase fw-bold">Ações</h6>
                            <div class="d-grid gap-2 w-100 w-md-75 mx-auto">
                                {% if status_ativo == 'PENDENTE' %}
                                    <form method="POST" action="{% url 'gestao:notificacao_acao_agrupada' questao.id %}" class="form-require-confirmation" data-confirm-message="Corrigir todos os {{ questao.num_reports }} reports?">{% csrf_token %}<input type="hidden" name="action" value="resolver"><input type="hidden" name="status_original" value="{{ status_ativo }}"><button type="submit" class="btn btn-success w-100"><i class="fas fa-check me-2"></i>Corrigir</button></form>
                                    <form method="POST" action="{% url 'gestao:notificacao_acao_agrupada' questao.id %}" class="form-require-confirmation" data-confirm-message="Rejeitar todos os reports?">{% csrf_token %}<input type="hidden" name="action" value="rejeitar"><input type="hidden" name="status_original" value="{{ status_ativo }}"><button type="submit" class="btn btn-danger w-100"><i class="fas fa-times me-2"></i>Rejeitar</button></form>
                                {% elif status_ativo == 'RESOLVIDO' or status_ativo == 'REJEITADO' %}
                                    <form method="POST" action="{% url 'gestao:notificacao_acao_agrupada' questao.id %}" class="form-require-confirmation" data-confirm-message="EXCLUIR PERMANENTEMENTE todos os {{ questao.num_reports }} reports? Esta ação não pode ser desfeita.">{% csrf_token %}<input type="hidden" name="action" value="excluir"><input type="hidden" name="status_original" value="{{ status_ativo }}"><button type="submit" class="btn btn-outline-danger w-100"><i class="fas fa-trash me-2"></i>Excluir</button></form>
                                {% else %}
                                    <p class="text-muted text-center small">Nenhuma ação disponível.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
                <div class="text-center p-5 border rounded bg-light mt-4"><h4 class="h5">Nenhuma notificação encontrada</h4><p class="text-muted mb-0">Não há notificações com os filtros aplicados.</p></div>
            {% endfor %}


                <div class="mt-4">
   {% include 'includes/_paginacao.html' with paginated_object=questoes_agrupadas page_numbers=page_numbers %}
                </div>
   
        </div>
    </div>
</div>
{% include 'gestao/includes/_modais_notificacoes.html' %}
{% endblock %}


{% block scripts %}
<!-- JAVASCRIPT REUTILIZADO E ADAPTADO -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // INICIALIZAÇÃO DO SELETOR DE DATA (flatpickr)
    flatpickr(".datepicker", {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d/m/Y",
        allowInput: true,
    });

    // =======================================================================
    // 1. INICIALIZAÇÃO DOS MODAIS
    // =======================================================================
    const confirmationModalEl = document.getElementById('confirmationModal');
    const confirmationModal = confirmationModalEl ? new bootstrap.Modal(confirmationModalEl) : null;

    const notificationModalEl = document.getElementById('notificationModal'); // Assumindo que você tenha um modal com este ID
    const notificationModal = notificationModalEl ? new bootstrap.Modal(notificationModalEl) : null;

    const visualizarQuestaoModalEl = document.getElementById('visualizarQuestaoModal');
    const visualizarQuestaoModal = visualizarQuestaoModalEl ? new bootstrap.Modal(visualizarQuestaoModalEl) : null;

    // =======================================================================
    // 2. FUNÇÕES GENÉRICAS PARA MODAIS
    // =======================================================================

    /**
     * Exibe um modal de NOTIFICAÇÃO (sucesso, erro, info).
     * Requer um modal com id="notificationModal" no seu HTML.
     */
    function showNotificationModal(title, message, type = 'info') {
        if (!notificationModal || !notificationModalEl) {
            alert(`${title}: ${message}`); // Fallback para alert
            return;
        }
        const modalTitle = notificationModalEl.querySelector('.modal-title');
        const modalBody = notificationModalEl.querySelector('.modal-body');
        const modalHeader = notificationModalEl.querySelector('.modal-header');

        modalTitle.textContent = title;
        modalBody.innerHTML = message;

        modalHeader.classList.remove('bg-success', 'bg-danger', 'bg-primary');
        if (type === 'success') modalHeader.classList.add('bg-success');
        else if (type === 'error') modalHeader.classList.add('bg-danger');
        else modalHeader.classList.add('bg-primary');
        
        notificationModal.show();
    }

    /**
     * Exibe um modal de CONFIRMAÇÃO e executa um callback.
     */
    function showConfirmationModal(title, message, onConfirmCallback) {
        if (!confirmationModal || !confirmationModalEl) {
            if (confirm(message)) onConfirmCallback(); // Fallback para confirm
            return;
        }
        confirmationModalEl.querySelector('.modal-title').textContent = title;
        confirmationModalEl.querySelector('.modal-body').textContent = message;
        const confirmBtn = confirmationModalEl.querySelector('#btn-confirm-action');
        
        // Clona o botão para remover listeners antigos e evitar disparos múltiplos
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        newConfirmBtn.addEventListener('click', () => {
            onConfirmCallback();
            confirmationModal.hide();
        }, { once: true });

        confirmationModal.show();
    }

    // =======================================================================
    // 3. EVENT LISTENERS PARA AÇÕES DA PÁGINA
    // =======================================================================

    // Ações de formulário individual (Corrigir, Rejeitar, Excluir em cada card)
    document.querySelectorAll('.form-require-confirmation').forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const message = this.dataset.confirmMessage || 'Tem certeza que deseja executar esta ação?';
            showConfirmationModal('Confirmar Ação', message, () => form.submit());
        });
    });

    // Modal de visualização rápida
    if (visualizarQuestaoModalEl) {
        const modalCodigo = visualizarQuestaoModalEl.querySelector('#modalQuestaoCodigo');
        const modalEnunciado = visualizarQuestaoModalEl.querySelector('#modalQuestaoEnunciado');
        const modalAlternativas = visualizarQuestaoModalEl.querySelector('#modalQuestaoAlternativas');
        const modalSpinner = visualizarQuestaoModalEl.querySelector('#modalQuestaoSpinner');
        const modalContent = visualizarQuestaoModalEl.querySelector('#modalQuestaoContent');

        document.querySelectorAll('.btn-visualizar-questao').forEach(button => {
            button.addEventListener('click', function() {
                const questaoId = this.dataset.questaoId;
                modalContent.style.display = 'none';
                modalSpinner.style.display = 'block';
                modalCodigo.textContent = '...';
                visualizarQuestaoModal.show();
                fetch(`/gestao/api/visualizar-questao/${questaoId}/`)
                    .then(response => {
                        if (!response.ok) throw new Error(`Erro de servidor: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            modalCodigo.textContent = data.codigo;
                            modalEnunciado.innerHTML = data.enunciado;
                            modalAlternativas.innerHTML = '';
                            for (const [key, value] of Object.entries(data.alternativas)) {
                                const listItem = document.createElement('li');
                                listItem.classList.add('list-group-item');
                                if (key === data.gabarito) {
                                    listItem.classList.add('list-group-item-success', 'fw-bold');
                                }
                                listItem.innerHTML = `<strong>${key})</strong> ${value}`;
                                modalAlternativas.appendChild(listItem);
                            }
                        } else {
                            throw new Error(data.message || 'Não foi possível carregar os dados da questão.');
                        }
                    })
                    .catch(error => {
                        modalEnunciado.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                    })
                    .finally(() => {
                        modalSpinner.style.display = 'none';
                        modalContent.style.display = 'block';
                    });
            });
        });
    }

    // --- LÓGICA DAS AÇÕES EM MASSA (CHECKBOXES) ---
    const bulkActionsBar = document.getElementById('bulk-actions-bar');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const notificationCheckboxes = document.querySelectorAll('.notification-checkbox');
    const selectedCountSpan = document.getElementById('selected-count');

    function updateBulkActionBar() {
        if (!bulkActionsBar) return;
        const selectedCheckboxes = document.querySelectorAll('.notification-checkbox:checked');
        const count = selectedCheckboxes.length;
        if (count > 0) {
            bulkActionsBar.style.display = 'block';
            selectedCountSpan.textContent = count;
        } else {
            bulkActionsBar.style.display = 'none';
        }
        if (selectAllCheckbox) selectAllCheckbox.checked = count > 0 && count === notificationCheckboxes.length;
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            notificationCheckboxes.forEach(checkbox => { checkbox.checked = this.checked; });
            updateBulkActionBar();
        });
    }
    notificationCheckboxes.forEach(checkbox => checkbox.addEventListener('change', updateBulkActionBar));

    document.querySelectorAll('.bulk-action-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const action = this.dataset.action;
            const selectedIds = Array.from(document.querySelectorAll('.notification-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0) {
                showNotificationModal('Atenção', 'Nenhuma questão foi selecionada.', 'info');
                return;
            }
            let confirmationMessage = `Tem certeza que deseja aplicar a ação '${action}' para ${selectedIds.length} questão(ões)?`;
            if (action === 'excluir') confirmationMessage += " Esta ação é PERMANENTE e não pode ser desfeita.";

            showConfirmationModal('Confirmar Ação em Massa', confirmationMessage, () => {
                fetch("{% url 'gestao:notificacoes_acoes_em_massa' %}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                    body: JSON.stringify({ ids: selectedIds, action: action, status_original: '{{ status_ativo }}' })
                })
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => { 
                    if (ok && data.status === 'success') {
                        showNotificationModal('Sucesso!', 'Ação em massa aplicada com sucesso. A página será recarregada.', 'success');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        throw new Error(data.message || 'Ocorreu um erro desconhecido no servidor.');
                    }
                })
                .catch(err => {
                    showNotificationModal('Erro', err.message, 'error');
                });
            });
        });
    });
});
</script>
{% endblock %}