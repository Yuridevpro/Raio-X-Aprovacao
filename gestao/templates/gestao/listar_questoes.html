<!-- gestao/listar_questoes.html -->
{% extends 'base.html' %}
{% load static %}
{% load questoes_extras %}
{% load pratica_extras %}

{% block title %}Gerenciar Questões{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/listagem-comum.css' %}">
    <style>
        .page-header {
            background-color: var(--cor-fundo-claro);
            padding: 1.5rem 2rem;
            border-radius: var(--raio-borda);
            margin-bottom: 2rem;
            border: 1px solid var(--cor-borda);
        }
        
        .lista-questoes-container {
            background-color: var(--cor-fundo-claro);
            border-radius: var(--raio-borda);
            border: 1px solid var(--cor-borda);
            overflow: hidden;
        }
        
        .questao-item {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--cor-borda);
            transition: background-color 0.2s ease-in-out;
        }
        .lista-questoes-container .questao-item:last-child {
            border-bottom: none;
        }
        .questao-item:hover {
            background-color: #f8f9fa;
        }
        
        .questao-info { display: flex; align-items: center; gap: 1.25rem; flex-wrap: wrap; flex-grow: 1; }
        .questao-info .codigo { font-size: 1.1rem; font-weight: 600; color: var(--cor-primaria); min-width: 80px; }
        .questao-info .disciplina { font-weight: 500; }
        .questao-info .meta { font-size: 0.9rem; color: var(--cor-texto-muted); }
        .questao-actions { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }

        @media (max-width: 767.98px) {
            .page-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .questao-item { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .questao-actions { width: 100%; justify-content: flex-end; }
        }
    </style>
{% endblock %}
    
{% block content %}
<div class="container mt-5 mb-5">
    <div class="mb-4">
        <a href="{% url 'gestao:dashboard' %}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-2"></i>Voltar ao Painel</a>
    </div>
    
    <!-- CABEÇALHO DA PÁGINA -->
    <div class="page-header d-flex justify-content-between align-items-center">
        <h2 class="h3 mb-0">Gerenciamento de Questões</h2>
        <div class="d-flex gap-2">
            <!-- ======================================================================= -->
            <!-- INÍCIO DA MODIFICAÇÃO: Botão para Lixeira -->
            <!-- ======================================================================= -->
            <a href="{% url 'gestao:listar_questoes_deletadas' %}" class="btn btn-outline-secondary">
                <i class="fas fa-trash me-2"></i>Lixeira
                {% if lixeira_count > 0 %}
                    <span class="badge bg-secondary ms-1">{{ lixeira_count }}</span>
                {% endif %}
            </a>
            <!-- ======================================================================= -->
            <!-- FIM DA MODIFICAÇÃO -->
            <!-- ======================================================================= -->
            <div class="btn-group">
                <a href="{% url 'gestao:adicionar_questao' %}" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Adicionar Questão</a>
                <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false"></button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addEntidadeModal" data-tipo="disciplina" data-titulo="Adicionar Disciplina"><i class="fas fa-book fa-fw me-2"></i>Adicionar Disciplina</a></li>
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addAssuntoModal"><i class="fas fa-tags fa-fw me-2"></i>Adicionar Assunto</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addEntidadeModal" data-tipo="banca" data-titulo="Adicionar Banca"><i class="fas fa-gavel fa-fw me-2"></i>Adicionar Banca</a></li>
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addEntidadeModal" data-tipo="instituicao" data-titulo="Adicionar Instituição"><i class="fas fa-university fa-fw me-2"></i>Adicionar Instituição</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    {% if messages %}{% for message in messages %}<div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endfor %}{% endif %}

    <!-- CARD DE FILTROS RECOLHÍVEL -->
    <div class="card mb-4 shadow-sm filter-card">
        <div class="card-header p-3 collapsed" data-bs-toggle="collapse" data-bs-target="#collapseFilters"><div class="d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros de Busca</h5><span class="icon-toggle"></span></div></div>
        <div class="collapse" id="collapseFilters"><div class="card-body p-4">{% include 'includes/_filtros_questoes.html' with form_action_url=request.path %}</div></div>
    </div>
    
    <!-- CONTROLES DE ORDENAÇÃO E PAGINAÇÃO -->
    {% include 'gestao/includes/_ordenacao_e_paginacao_controls.html' with paginated_object=questoes sort_options=sort_options sort_by=sort_by per_page=per_page %}

    <!-- BARRA DE AÇÕES EM MASSA -->
    {% include 'gestao/includes/_barra_acoes_em_massa_questoes.html' %}

    <!-- LISTAGEM DE QUESTÕES -->
    {% if questoes %}
        <div class="lista-questoes-container">
            {% for questao in questoes %}
            <div class="questao-item" id="questao-item-{{ questao.id }}">
                <div class="form-check"><input class="form-check-input questao-checkbox" type="checkbox" data-id="{{ questao.id }}"></div>
                <div class="questao-info">
                    <span class="codigo">{{ questao.codigo }}</span>
                    <span class="disciplina">{{ questao.disciplina.nome }}</span>
                    <span class="meta">{% if questao.is_inedita %}<span class="badge bg-info text-dark">Inédita</span>{% else %}{{ questao.banca.nome|default_if_none:"-" }} / {{ questao.ano|default_if_none:"-" }}{% endif %}</span>
                </div>
                <div class="questao-actions">
                    <button type="button" class="btn btn-sm btn-outline-secondary btn-visualizar-questao" data-questao-id="{{ questao.id }}" data-bs-toggle="modal" data-bs-target="#visualizarQuestaoModal" title="Visualização Rápida"><i class="fas fa-eye"></i></button>
                    <a href="{% url 'gestao:editar_questao' questao.id %}" class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip" title="Editar"><i class="fas fa-edit"></i></a>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-deletar-questao" data-bs-toggle="modal" data-bs-target="#deletarQuestaoModal" data-questao-id="{{ questao.id }}" data-questao-codigo="{{ questao.codigo }}"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-5 card card-body"><i class="fas fa-search fa-4x text-muted mb-3"></i><h4 class="h5 fw-bold">Nenhuma questão foi encontrada</h4><p class="text-muted">Tente ajustar seus filtros de busca ou adicione novas questões.</p></div>
    {% endif %}

    <!-- PAGINAÇÃO -->
    <div class="mt-4">{% include 'includes/_paginacao.html' with paginated_object=questoes %}</div>
</div>

<!-- MODAIS -->
{% include 'gestao/includes/_modais_gestao_questoes.html' %}
{% endblock %}


{% block scripts %}
<script src="{% static 'js/filtros-questoes.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        new bootstrap.Tooltip(document.body, { selector: "[data-bs-toggle='tooltip']" });
    
        // ... (todo o restante do seu JavaScript existente para esta página, sem alterações) ...
        function setupAjaxModalForm(modalId, formId, url) {
            const modalEl = document.getElementById(modalId);
            if (!modalEl) return;
    
            modalEl.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                if (button && button.dataset.tipo) {
                    modalEl.querySelector('.modal-title').textContent = button.dataset.titulo;
                    modalEl.querySelector('#input-tipo-entidade').value = button.dataset.tipo;
                }
            });
    
            const form = document.getElementById(formId);
            const submitBtn = modalEl.querySelector('.modal-footer button.btn-primary');
            
            submitBtn.addEventListener('click', function() {
                const spinner = submitBtn.querySelector('.spinner-border');
                const btnText = submitBtn.querySelector('.btn-text');
                submitBtn.disabled = true;
                spinner.style.display = 'inline-block';
                btnText.style.display = 'none';
    
                fetch(url, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: { 'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value }
                })
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ok, data}) => {
                    if (ok) {
                        bootstrap.Modal.getInstance(modalEl).hide();
                        showNotificationModal('Sucesso!', 'Item adicionado. A página será recarregada.', 'success', () => window.location.reload());
                    } else {
                        const errorField = Object.keys(data.errors)[0];
                        const input = form.querySelector(`[name=${errorField}]`);
                        if (input) {
                            input.classList.add('is-invalid');
                            input.nextElementSibling.textContent = data.errors[errorField][0];
                        } else {
                            throw new Error(data.message || 'Erro de validação.');
                        }
                    }
                })
                .catch(error => showNotificationModal('Erro de Rede', error.message, 'error'))
                .finally(() => {
                    submitBtn.disabled = false;
                    spinner.style.display = 'none';
                    btnText.style.display = 'inline-block';
                });
            });
        }
    
        function setupDeletarQuestaoModal() {
            const modalEl = document.getElementById('deletarQuestaoModal');
            if (!modalEl) return;
            
            const modal = new bootstrap.Modal(modalEl);
            const form = document.getElementById('form-deletar-questao');
            
            modalEl.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                form.action = `{% url 'gestao:deletar_questao' 0 %}`.replace('0', button.dataset.questaoId);
                this.querySelector('#codigo-para-deletar').textContent = button.dataset.questaoCodigo;
            });
    
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const submitBtn = form.querySelector('button[type="submit"]');
                const spinner = submitBtn.querySelector('.spinner-border');
                const btnText = submitBtn.querySelector('.btn-text');
                submitBtn.disabled = true;
                spinner.style.display = 'inline-block';
                btnText.style.display = 'none';
    
                fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value }
                })
                .then(response => response.json().then(data => ({ok: response.ok, data})))
                .then(({ok, data}) => {
                    modal.hide();
                    if(ok) {
                        showNotificationModal('Sucesso!', data.message, 'success', () => {
                            window.location.reload();
                        });
                    } else {
                        throw new Error(data.message || 'Não foi possível mover a questão para a lixeira.');
                    }
                })
                .catch(error => showNotificationModal('Erro', error.message, 'error'))
                .finally(() => {
                    submitBtn.disabled = false;
                    spinner.style.display = 'none';
                    btnText.style.display = 'inline-block';
                });
            });
        }
    
        function setupVisualizarQuestaoModal() {
            const modalEl = document.getElementById('visualizarQuestaoModal');
            if (!modalEl) return;
            
            const modal = new bootstrap.Modal(modalEl);
            modalEl.addEventListener('show.bs.modal', function(event) {
                const questaoId = event.relatedTarget.dataset.questaoId;
                const content = this.querySelector('#modalQuestaoContent');
                const spinner = this.querySelector('#modalQuestaoSpinner');
                content.style.display = 'none';
                spinner.style.display = 'block';
    
                fetch(`/gestao/api/visualizar-questao/${questaoId}/`)
                    .then(response => response.ok ? response.json() : Promise.reject('Erro de servidor'))
                    .then(data => {
                        this.querySelector('#modalQuestaoCodigo').textContent = data.codigo;
                        this.querySelector('#modalQuestaoEnunciado').innerHTML = data.enunciado;
                        const alternativasList = this.querySelector('#modalQuestaoAlternativas');
                        alternativasList.innerHTML = Object.entries(data.alternativas).map(([key, value]) => `
                            <li class="list-group-item ${key === data.gabarito ? 'list-group-item-success fw-bold' : ''}">
                                <strong>${key})</strong> ${value}
                            </li>`).join('');
                    })
                    .catch(error => this.querySelector('#modalQuestaoEnunciado').innerHTML = `<div class="alert alert-danger">${error}</div>`)
                    .finally(() => {
                        spinner.style.display = 'none';
                        content.style.display = 'block';
                    });
            });
        }
    
        const advancedConfirmationModalEl = document.getElementById('advancedConfirmationModal');
        if (advancedConfirmationModalEl) {
            const modal = new bootstrap.Modal(advancedConfirmationModalEl);
            const titleEl = document.getElementById('advancedConfirmationModalLabel');
            const bodyEl = document.getElementById('advancedConfirmationModalBody');
            const phraseEl = document.getElementById('confirmacao-frase');
            const inputEl = document.getElementById('input-confirmacao');
            const confirmBtn = document.getElementById('btn-advanced-confirm-action');
            let onConfirmCallback = () => {};

            inputEl.addEventListener('input', () => {
                confirmBtn.disabled = inputEl.value.trim().toUpperCase() !== phraseEl.textContent.trim().toUpperCase();
            });

            confirmBtn.addEventListener('click', () => {
                if (onConfirmCallback) onConfirmCallback();
                modal.hide();
            });
            
            advancedConfirmationModalEl.addEventListener('hidden.bs.modal', () => {
                inputEl.value = '';
                confirmBtn.disabled = true;
            });

            window.showAdvancedConfirmationModal = (title, body, phrase, callback) => {
                titleEl.textContent = title;
                bodyEl.textContent = body;
                phraseEl.textContent = phrase;
                onConfirmCallback = callback;
                modal.show();
            };
        }

        // --- FUNÇÃO MODIFICADA: Lógica das Ações em Massa ---
        function setupAcoesEmMassa() {
            const bulkActionsBar = document.getElementById('bulk-actions-bar');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const questaoCheckboxes = document.querySelectorAll('.questao-checkbox');
            const selectedCountSpan = document.getElementById('selected-count');
            const bulkActionBtn = document.querySelector('.bulk-action-btn');
    
            if (!bulkActionsBar || !bulkActionBtn) return;
    
            const updateBulkActionBar = () => {
                const count = document.querySelectorAll('.questao-checkbox:checked').length;
                bulkActionsBar.style.display = count > 0 ? 'block' : 'none';
                if (selectedCountSpan) selectedCountSpan.textContent = count;
                if (selectAllCheckbox) selectAllCheckbox.checked = count > 0 && count === questaoCheckboxes.length;
            };
    
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', () => {
                    questaoCheckboxes.forEach(checkbox => { checkbox.checked = selectAllCheckbox.checked; });
                    updateBulkActionBar();
                });
            }
            questaoCheckboxes.forEach(checkbox => checkbox.addEventListener('change', updateBulkActionBar));
    
            bulkActionBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const selectedIds = Array.from(document.querySelectorAll('.questao-checkbox:checked')).map(cb => cb.dataset.id);
    
                if (selectedIds.length === 0) {
                    showNotificationModal('Atenção', 'Nenhuma questão foi selecionada.', 'info');
                    return;
                }
                
                // Prepara os dados para o modal AVANÇADO
                const message = `Você está prestes a mover ${selectedIds.length} questões para a lixeira.`;
                const phrase = `MOVER ${selectedIds.length} QUESTÕES`;

                // Chama a nova função de modal avançado
                if (window.showAdvancedConfirmationModal) {
                    showAdvancedConfirmationModal('Confirmar Ação em Massa', message, phrase, () => {
                        // Lógica de fetch que era usada no modal antigo
                        const dropdownBtn = document.getElementById('bulk-action-dropdown-btn');
                        const spinner = dropdownBtn.querySelector('.spinner-border');
                        const btnText = dropdownBtn.querySelector('.btn-text');
                        dropdownBtn.disabled = true;
                        spinner.style.display = 'inline-block';
                        btnText.style.display = 'none';
        
                        fetch("{% url 'gestao:questoes_acoes_em_massa' %}", {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                            body: JSON.stringify({ ids: selectedIds, action: 'delete' }) // Ação é sempre 'delete' nesta página
                        })
                        .then(response => response.json().then(data => ({ ok: response.ok, data })))
                        .then(({ ok, data }) => { 
                            if (ok) {
                                showNotificationModal('Sucesso!', data.message, 'success', () => {
                                    window.location.reload();
                                });
                            } else {
                                throw new Error(data.message || 'Ocorreu um erro.');
                            }
                        })
                        .catch(err => showNotificationModal('Erro', err.message, 'error'))
                        .finally(() => {
                            dropdownBtn.disabled = false;
                            spinner.style.display = 'none';
                            btnText.style.display = 'inline-block';
                        });
                    });
                } else {
                    console.error("Função showAdvancedConfirmationModal não encontrada.");
                }
            });
        }
    
        setupAjaxModalForm('addEntidadeModal', 'form-add-entidade', "{% url 'gestao:adicionar_entidade_simples' %}");
        setupAjaxModalForm('addAssuntoModal', 'form-add-assunto', "{% url 'gestao:adicionar_assunto' %}");
        setupDeletarQuestaoModal();
        setupVisualizarQuestaoModal();
        setupAcoesEmMassa();
    });
</script>
{% endblock %}