<!-- listar_simulados -->

{% extends 'base.html' %}
{% load static %}
{% load pratica_extras %}
{% load gestao_extras %}

{% block title %}Gerenciar Simulados{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/listagem-comum.css' %}">
<style>
    /*
      ========================================================================
      ✅ CORREÇÃO CSS ESPECÍFICA PARA O CHECKBOX DO FILTRO "ASSUNTO"
      ========================================================================
      Este bloco força a restauração do espaçamento para os checkboxes
      gerados dinamicamente no filtro de Assunto, resolvendo o problema de
      alinhamento e o desaparecimento do input.
    */

    /* 
      O seletor [id$="options-assunto"] mira especificamente no <ul> do
      dropdown de "Assunto", independentemente de haver um prefixo,
      garantindo que a regra só se aplique a ele.
    */
    [id$="options-assunto"] .form-check {
        /* 1. Restaura um padding à esquerda generoso para criar espaço para o checkbox. */
        /*    Usamos !important para garantir que esta regra vença qualquer conflito. */
        padding-left: 2.2rem !important;

        /* 2. Garante que o container se comporte como um bloco para alinhamento correto. */
        display: block !important;
        
        /* 3. Adiciona um padding vertical para que o texto não fique colado. */
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        
        /* 4. Remove margens que possam causar desalinhamento. */
        margin: 0 !important;
    }

    /*
      Esta regra garante que o input (o checkbox) seja posicionado
      corretamente dentro do espaço criado pelo padding acima.
    */
    [id$="options-assunto"] .form-check .form-check-input {
        /* Puxa o checkbox para a esquerda, posicionando-o dentro do 'padding-left'. */
        margin-left: -1.9rem !important; 
        
        /* Centraliza verticalmente o checkbox com a primeira linha do texto. */
        margin-top: 0.4em !important;
        
        /* Garante que o checkbox não flutue de forma incorreta. */
        float: left !important;
    }
    
    
    
    .simulado-card { 
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
        border-left: 4px solid var(--cor-borda); 
    }

    
    .badge.bg-status-ativo { background-color: var(--cor-sucesso) !important; }
    .badge.bg-status-em-breve { background-color: var(--cor-aviso) !important; color: #000 !important; }
    .badge.bg-status-arquivado { background-color: var(--cor-texto-muted) !important; }
    #editSimuladoMetaModal { z-index: 1100; }

    /* ======================================================================== */
    /* ✅ INÍCIO DA CORREÇÃO: ESTILOS UNIFICADOS PARA OS FILTROS                 */
    /* ======================================================================== */

    /* Garante que o dropdown ocupe 100% da largura do botão e define uma altura máxima com rolagem */
    .dropdown .dropdown-menu { 
        width: 100%; 
        max-height: 300px; 
        overflow-y: auto; 
    }

    /* Estilo para a caixa de "Busca rápida..." que fica fixa no topo durante a rolagem */
    .search-input-container {
        padding: 0.5rem 0.75rem;
        position: sticky;
        top: 0;
        background-color: white;
        z-index: 10;
        border-bottom: 1px solid #dee2e6;
    }
    
    /* Zera os estilos do <li> para que ele seja apenas um container sem espaçamento externo */
    .dropdown-options-container li {
        padding: 0;
        margin: 0; /* CORREÇÃO: Remove a margem que causava o corte dos itens */
        list-style: none !important;
    }

    /* Estilo para cada item clicável (checkbox + label) dentro do dropdown */
    .dropdown-options-container .form-check {
        padding: 0.4rem 1.8rem; /* CORREÇÃO: Adiciona espaçamento interno para evitar o corte do texto */
        white-space: normal;
        word-wrap: break-word;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }

    .dropdown-options-container .form-check:hover {
        background-color: #f8f9fa; /* Efeito visual ao passar o mouse */
    }
    
    /* Estilo para os títulos de disciplina (ex: "Matemática") no filtro de Assunto */
    .dropdown-options-container .dropdown-header {
        padding: 0.75rem 1rem 0.25rem;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--cor-primaria, #0d6efd);
    }

    /* Estilo base para os botões de filtro */
    .btn-filter {
        text-align: left;
        justify-content: space-between;
        display: flex;
        align-items: center;
        width: 100%;
    }

    /* Estilo para o botão QUANDO um filtro está ativo (selecionado) */
    .btn-filter.active {
        background-color: var(--bs-secondary, #6c757d);
        color: white;
        border-color: var(--bs-secondary, #6c757d);
    }

    /* Garante que a bolha de contagem fique visível no botão ativo */
    .btn-filter.active .badge {
        background-color: rgba(255, 255, 255, 0.25) !important;
        color: white;
    }

    /* Estilo para os "pills" de filtros ativos */
    .filter-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.6rem;
        font-size: 0.8em;
        font-weight: 500;
        border-radius: 1rem;
        background-color: #e9ecef;
        border: 1px solid #dee2e6;
        color: #495057;
    }
    .remove-filter-btn {
        margin-left: 0.5rem;
        padding: 0;
        background: none;
        border: none;
        font-size: 1.4em;
        line-height: 1;
        cursor: pointer;
        color: #6c757d;
        opacity: 0.7;
    }
    .remove-filter-btn:hover {
        opacity: 1;
    }
    /* ======================================================================== */
    /* FIM DA CORREÇÃO                                                          */
    /* ======================================================================== */
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2 class="h3 mb-0 d-flex align-items-center gap-2"><i class="fas fa-file-alt text-primary"></i> Gerenciar Simulados</h2>
        <a href="{% url 'gestao:criar_simulado' %}" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Novo Simulado</a>
    </div>

    {% include 'gestao/includes/_messages.html' %}

    <!-- Barra de filtros completa -->
    <div class="card card-body mb-4 shadow-sm" id="form-filtros"
        data-assuntos-url="{{ assuntos_url }}" 
        data-selected-assuntos="{{ selected_assuntos_json|safe }}">
        <form method="GET" action="">
            <!-- Linha 1: Busca, Status e Botão Filtrar -->
            <div class="row g-2 mb-2">
                <div class="col-lg-6">
                    <input type="text" name="q" class="form-control" placeholder="Buscar por nome ou código do simulado..." value="{{ active_filters.q|default:'' }}">
                </div>
                <div class="col-lg-3">
                    <select name="status" class="form-select">
                        <option value="">Todos os status</option>
                        {% for value, display in status_choices %}
                            <option value="{{ value }}" {% if active_filters.status == value %}selected{% endif %}>{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 d-grid">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-search me-2"></i>Filtrar</button>
                </div>
            </div>

            <!-- Linha 2: Dropdowns de Filtro (Layout com Grid) -->
            <div class="row g-2">
                <div class="col-sm-6 col-md-4 col-lg-3">
                    {% include 'pratica/includes/_filtro_dropdown.html' with name="disciplina" label="Disciplina" items=disciplinas_filtro selected_ids=selected_disciplinas %}
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3">
                    {% include 'pratica/includes/_filtro_dropdown.html' with name="assunto" label="Assunto" items=None selected_ids=selected_assuntos %}
                </div>
                <div class="col-sm-6 col-md-4 col-lg-2">
                    {% include 'pratica/includes/_filtro_dropdown.html' with name="banca" label="Banca" items=bancas_filtro selected_ids=selected_bancas %}
                </div>
                <div class="col-sm-6 col-md-6 col-lg-2">
                    {% include 'pratica/includes/_filtro_dropdown.html' with name="instituicao" label="Instituição" items=instituicoes_filtro selected_ids=selected_instituicoes %}
                </div>
                <div class="col-sm-6 col-md-6 col-lg-2 d-grid">
                     <a href="{% url 'gestao:listar_simulados_gestao' %}" class="btn btn-outline-secondary" title="Limpar Filtros"><i class="fas fa-times me-1 d-none d-sm-inline"></i> Limpar</a>
                </div>
            </div>
            
            <!-- =================================================================== -->
            <!-- ✅ ADIÇÃO: Container para exibir os filtros ativos ("pills")       -->
            <!-- =================================================================== -->
            <div id="active-filters-container" class="mt-3" style="display: none;">
                 <!-- Os "pills" dos filtros ativos serão injetados aqui pelo JavaScript -->
            </div>
        </form>
    </div>

    {% include 'gestao/includes/_ordenacao_e_paginacao_controls.html' with paginated_object=simulados sort_options=sort_options sort_by=sort_by per_page=per_page %}

    <div class="row g-4">
        {% for simulado in simulados %}
            <div class="col-lg-4 col-md-6" id="simulado-card-container-{{ simulado.id }}">
                {% include 'gestao/includes/_simulado_card.html' with simulado=simulado %}
            </div>
        {% empty %}
            <div class="col-12">
                <div class="text-center py-5 card card-body">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum simulado encontrado.</h5>
                    <p>Tente ajustar seus filtros ou <a href="{% url 'gestao:criar_simulado' %}">crie um novo simulado</a>.</p>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="mt-4">
        {% include 'includes/_paginacao.html' with paginated_object=simulados %}
    </div>
</div>

<!-- Modais (sem alterações) -->
<div class="modal fade" id="editSimuladoMetaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form id="form-edit-meta"><div class="modal-header"><h5 class="modal-title">Editar Detalhes do Simulado</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="modal-body-edit-meta"><div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar Alterações</button></div></form></div></div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Confirmar Exclusão</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Você tem certeza que deseja excluir o simulado <strong id="itemName"></strong>?</p><p class="text-danger">Esta ação não pode ser desfeita.</p></div><div class="modal-footer"><form id="deleteForm" method="POST" action="">{% csrf_token %}<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-danger">Sim, excluir</button></form></div></div></div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/filtros-questoes-avancado.js' %}"></script>
<script>
// Scripts dos modais (sem alterações)
document.addEventListener('DOMContentLoaded', function() {
    const editModalEl = document.getElementById('editSimuladoMetaModal');
    if (editModalEl) {
        const modal = new bootstrap.Modal(editModalEl);
        const modalBody = document.getElementById('modal-body-edit-meta');
        const form = document.getElementById('form-edit-meta');
        let currentSimuladoId = null;
        editModalEl.addEventListener('show.bs.modal', function(event) {
            currentSimuladoId = event.relatedTarget.dataset.simuladoId;
            modalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';
            fetch(`/gestao/simulados/api/editar-meta/${currentSimuladoId}/`).then(response => response.json()).then(data => { if (data.status === 'success') { modalBody.innerHTML = data.form_html; } else { modalBody.innerHTML = '<div class="alert alert-danger">Não foi possível carregar o formulário.</div>'; }});
        });
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(form);
            fetch(`/gestao/simulados/api/editar-meta/${currentSimuladoId}/`, { method: 'POST', body: formData, headers: { 'X-CSRFToken': '{{ csrf_token }}' }}).then(response => response.json()).then(data => { if (data.status === 'success') { const nomeEl = document.getElementById(`simulado-nome-${currentSimuladoId}`); const statusEl = document.getElementById(`simulado-status-${currentSimuladoId}`); if (nomeEl) nomeEl.textContent = data.simulado_data.nome; if (statusEl) { statusEl.textContent = data.simulado_data.status_display; statusEl.className = `badge ${data.simulado_data.status_class}`; } modal.hide(); } else { Object.keys(data.errors).forEach(fieldName => { const field = form.querySelector(`[name=${fieldName}]`); if(field) field.classList.add('is-invalid'); const errorDiv = form.querySelector(`.invalid-feedback[data-field=${fieldName}]`); if(errorDiv) errorDiv.textContent = data.errors[fieldName][0]; }); }});
        });
    }
    const deleteModalEl = document.getElementById('confirmDeleteModal');
    if (deleteModalEl) {
        deleteModalEl.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const deleteUrl = button.getAttribute('data-delete-url');
            const itemName = button.getAttribute('data-item-name');
            const modalBodyName = deleteModalEl.querySelector('#itemName');
            const deleteForm = deleteModalEl.querySelector('#deleteForm');
            modalBodyName.textContent = `"${itemName}"`;
            deleteForm.setAttribute('action', deleteUrl);
        });
    }
});
</script>
{% endblock %}