<!-- gesao/listar notificacao -->

{% extends 'base.html' %}
{% load static %}
{% load questoes_extras %}
{% block title %}Gerenciar Notificações{% endblock %}

{% block head %}

<!-- Google Fonts: Inter -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="{% static 'css/listagem-comum.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    /* =================================================================== */
    /* 1. ESTILOS GLOBAIS E VARIÁVEIS DE DESIGN */
    /* =================================================================== */
    :root {
        /* -- CORES DA MARCA -- (Ajuste a cor primária aqui) */
        --cor-primaria: #0d6efd; /* Cor azul padrão do Bootstrap, MUDE SE NECESSÁRIO */
        --cor-primaria-hover: #0b5ed7; /* Tom mais escuro para hover */
        
        /* -- TIPOGRAFIA E LAYOUT -- */
        --font-family-sans-serif: 'Inter', sans-serif;
        --bs-body-font-family: var(--font-family-sans-serif);
        --bs-border-color-translucent: rgba(0, 0, 0, 0.08); /* Borda mais sutil */
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        --card-shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.1);
        --card-border-radius: 0.75rem;
        --transition-default: all 0.3s ease-in-out;
    }

    body {
        background-color: #f9fafb; /* Fundo levemente acinzentado */
    }

    /* =================================================================== */
    /* 2. COMPONENTES PRINCIPAIS */
    /* =================================================================== */

    /* Título da Página */
    .page-header h2 {
        font-weight: 700;
        color: #111827;
    }
    .page-header p {
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    /* Cards de Resumo (Dashboard) */
    .summary-card {
        border-radius: var(--card-border-radius);
        border: 1px solid var(--bs-border-color-translucent);
        background-color: #fff;
        box-shadow: var(--card-shadow);
        transition: var(--transition-default);
    }
    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow-hover);
    }
    .summary-card .card-body {
        padding: 1.5rem;
    }
    .summary-card .card-title {
        font-weight: 700;
        font-size: 2.25rem;
    }

    /* Abas de Navegação */
    .nav-pills .nav-link {
        color: #4b5563;
        font-weight: 600;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        transition: var(--transition-default);
    }
    .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
        background-color: var(--cor-primaria); /* <-- Usa a cor da marca */
        color: #fff;
        box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3); /* <-- Sombra azulada */
    }
    .nav-pills .nav-link:not(.active):hover {
        background-color: #e5e7eb;
    }

    /* Card de Filtros */
    .filters-card {
        background-color: #fff;
        border: 1px solid var(--bs-border-color-translucent);
        border-radius: var(--card-border-radius);
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
    }

    /* Card de Notificação (Principal) */
    .notification-card {
        background-color: #fff;
        border: 1px solid var(--bs-border-color-translucent);
        border-radius: var(--card-border-radius);
        box-shadow: var(--card-shadow);
        transition: var(--transition-default);
    }
    .notification-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow-hover);
    }
    .notification-card .card-header {
        background-color: transparent;
        border-bottom: 1px solid var(--bs-border-color-translucent);
    }
    .notification-card .card-footer {
        background-color: #f9fafb;
        border-top: 1px solid var(--bs-border-color-translucent);
    }
    .notification-card .card-text.text-muted {
        font-style: italic;
        color: #6c757d !important;
    }

    /* Botão de visualizar dentro do card */
    .btn-visualizar-questao {
        border-radius: 50%;
        width: 38px;
        height: 38px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    /* Botões primários usando a cor da marca */
    .btn-primary {
        background-color: var(--cor-primaria);
        border-color: var(--cor-primaria);
    }
    .btn-primary:hover {
        background-color: var(--cor-primaria-hover);
        border-color: var(--cor-primaria-hover);
    }

    /* =================================================================== */
    /* 3. MELHORIAS DE RESPONSIVIDADE (MOBILE) */
    /* =================================================================== */
    @media (max-width: 767.98px) {
        .page-header h2 {
            font-size: 2rem;
        }

        .notification-card .card-footer {
            flex-direction: column;
            align-items: stretch !important;
            gap: 1rem;
        }
        
        .card-footer .user-info {
            text-align: center;
            justify-content: center; /* Centraliza o nome e o botão de olho */
        }

        .card-footer .card-footer-actions {
            width: 100%;
        }

        .card-footer-actions .d-flex {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 py-md-5">

    <div class="mb-4">
        <!-- ATENÇÃO: Verifique se 'gestao:painel' é a URL correta para o seu painel de gestão -->
        <a href="{% url 'gestao:dashboard' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-2"></i>Voltar ao Painel de Gestão
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-11 col-xl-10">

            <div class="text-center mb-5 page-header">
                <h2 class="display-6">Gerenciamento de Notificações</h2>
                <p class="text-muted fs-5">Revise, gerencie e resolva os erros reportados pelos usuários.</p>
            </div>
            
            <div id="message-container" class="mb-4">
                {% if messages %}{% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}{% endif %}
            </div>

            <!-- CARDS DE RESUMO GERAL (DASHBOARD) -->
            <div class="row g-4 mb-5">
                <div class="col-md-3 col-6">
                    <div class="card h-100 summary-card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-danger">{{ stats.pendentes_total }}</h5>
                            <p class="card-text text-muted mb-0">Pendentes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card h-100 summary-card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-success">{{ stats.resolvidas_7_dias }}</h5>
                            <p class="card-text text-muted mb-0">Resolvidas (7d)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card h-100 summary-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">{{ stats.arquivadas_7_dias }}</h5>
                            <p class="card-text text-muted mb-0">Arquivadas (7d)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card h-100 summary-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">{{ stats.total_notificacoes }}</h5>
                            <p class="card-text text-muted mb-0">Total</p>
                        </div>
                    </div>
                </div>

                <!-- =================================================================== -->
<!-- CARD DE QUESTÕES MAIS REPORTADAS (REINTEGRADO) -->
<!-- =================================================================== -->
<div class="card mb-4 summary-card"> <!-- Usamos a mesma classe dos outros cards para consistência -->
    <div class="card-header bg-transparent border-bottom-0 pt-3 pb-0">
        <h6 class="mb-0 fw-bold text-center text-md-start">
            <i class="fas fa-exclamation-triangle me-2 text-danger"></i>Questões Mais Reportadas
        </h6>
    </div>
    {% if stats.questoes_mais_reportadas %}
        <div class="card-body pt-2">
            <ul class="list-group list-group-flush">
                {% for q in stats.questoes_mais_reportadas %}
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <a href="{% url 'gestao:listar_notificacoes' %}?status=TODAS&q={{ q.questao__codigo }}" class="text-decoration-none fw-bold text-dark">
                            {{ q.questao__codigo }}
                        </a>
                        <span class="badge bg-danger rounded-pill">{{ q.num_reports }} report{{ q.num_reports|pluralize:"s" }}</span>
                    </li>
                {% endfor %}
            </ul>
        </div>
    {% else %}
        <div class="card-body text-center text-muted">
            <p class="mb-0">Não há dados de questões mais reportadas.</p>
        </div>
    {% endif %}
</div>
<!-- =================================================================== -->
<!-- FIM DO CARD -->
<!-- =================================================================== -->

            </div>

            

            <!-- Abas de status -->
            <ul class="nav nav-pills justify-content-center border-bottom pb-3 mb-4">
                 <li class="nav-item"><a class="nav-link {% if status_ativo == 'PENDENTE' %}active{% endif %}" href="?status=PENDENTE">Pendentes</a></li>
                <li class="nav-item"><a class="nav-link {% if status_ativo == 'RESOLVIDO' %}active{% endif %}" href="?status=RESOLVIDO">Resolvidas</a></li>
                <li class="nav-item"><a class="nav-link {% if status_ativo == 'ARQUIVADO' %}active{% endif %}" href="?status=ARQUIVADO">Arquivadas</a></li>
                <li class="nav-item"><a class="nav-link {% if status_ativo == 'TODAS' %}active{% endif %}" href="?status=TODAS">Todas</a></li>
            </ul>
            
            <!-- Formulário de Filtros -->
            <form method="GET" class="filters-card mb-4">
                <input type="hidden" name="status" value="{{ status_ativo }}">
                <div class="row g-3 align-items-end">
                    <div class="col-12 col-lg-4">
                        <label for="q" class="form-label fw-bold">Pesquisar</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="q" name="q" value="{{ termo_busca_ativo|default:'' }}" placeholder="Código, descrição, usuário...">
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-2">
                        <label for="tipo_erro" class="form-label fw-bold">Tipo de Erro</label>
                        <select name="tipo_erro" id="tipo_erro" class="form-select">
                            <option value="">Todos</option>
                            {% for value, display in tipos_de_erro %}<option value="{{ value }}" {% if tipo_erro_ativo == value %}selected{% endif %}>{{ display }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-12 col-md-6 col-lg-2">
                        <label for="data_inicio" class="form-label fw-bold">De</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                            <input type="text" class="form-control" id="data_inicio" name="data_inicio" value="{{ data_inicio_buscada|default:'' }}" placeholder="DD/MM/AAAA">
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-2">
                        <label for="data_fim" class="form-label fw-bold">Até</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                            <input type="text" class="form-control" id="data_fim" name="data_fim" value="{{ data_fim_buscada|default:'' }}" placeholder="DD/MM/AAAA">
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-2">
                        <div class="d-grid d-md-flex gap-2">
                           <button type="submit" class="btn btn-dark w-100"><i class="fas fa-filter me-2"></i>Filtrar</button>
                           <a href="?status={{ status_ativo }}" class="btn btn-outline-secondary w-100" title="Limpar Filtros"><i class="fas fa-times"></i></a>
                        </div>
                    </div>
                </div>
            </form>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="h5 mb-0 fw-bold">Resultados</h3>
                <span class="text-muted">{{ notificacoes.paginator.count }} notificaç{{ notificacoes.paginator.count|pluralize:"ão,ões" }}</span>
            </div>
            
            <!-- BARRA DE AÇÕES EM MASSA -->
            {% if status_ativo != 'TODAS' %}
            <div id="bulk-actions-bar" class="card card-body mb-3 sticky-top" style="display: none; top: 10px; z-index: 1000; background-color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,.1);">
                <div class="d-flex justify-content-between align-items-center">
                   <div class="form-check">
                       <input class="form-check-input" type="checkbox" id="select-all-checkbox">
                       <label class="form-check-label" for="select-all-checkbox">
                           <span id="selected-count" class="fw-bold">0</span> selecionada(s)
                       </label>
                   </div>
                   <div class="dropdown">
                       <button class="btn btn-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                           <i class="fas fa-play"></i> Aplicar Ação
                       </button>
                       <ul class="dropdown-menu dropdown-menu-end">
                           <li><a class="dropdown-item bulk-action-btn" href="#" data-action="resolver"><i class="fas fa-check-circle text-success me-2"></i>Marcar como Resolvida</a></li>
                           <li><a class="dropdown-item bulk-action-btn" href="#" data-action="arquivar"><i class="fas fa-archive text-secondary me-2"></i>Arquivar Selecionadas</a></li>
                           {% if status_ativo == 'ARQUIVADO' %}
                           <li><hr class="dropdown-divider"></li>
                           <li><a class="dropdown-item bulk-action-btn" href="#" data-action="excluir"><i class="fas fa-trash-alt text-danger me-2"></i>Excluir Permanentemente</a></li>
                           {% endif %}
                       </ul>
                   </div>
               </div>
           </div>
            {% endif %}

            {% if notificacoes %}
                {% for notificacao in notificacoes %}
                <div class="card mb-4 notification-card">
                    <!-- CARD HEADER -->
                    <div class="card-header py-3">
                        <div class="d-flex align-items-center">
                            {% if status_ativo != 'TODAS' %}
                            <div class="form-check me-3">
                                <input class="form-check-input notification-checkbox" type="checkbox" data-id="{{ notificacao.id }}" style="width: 1.25em; height: 1.25em;">
                            </div>
                            {% endif %}
                            <div class="flex-grow-1">
                                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                                    <h5 class="mb-0 h6">
                                        <strong class="me-2">Questão:</strong>
                                        <a href="{% url 'gestao:editar_questao' notificacao.questao.id %}" target="_blank">{{ notificacao.questao.codigo }}</a>
                                    </h5>
                                    <small class="text-muted">{{ notificacao.data_criacao|date:"d/m/Y H:i" }}</small>
                                </div>
                                <div>
                                    <span class="badge bg-secondary fw-normal">{{ notificacao.get_tipo_erro_display }}</span>
                                    {% if notificacao.questao_report_count > 1 %}
                                    <span class="badge bg-warning text-dark" title="Esta questão foi reportada {{ notificacao.questao_report_count }} vezes.">
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ notificacao.questao_report_count }} Reports
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- CARD BODY -->
                    <div class="card-body">
                        {% if notificacao.descricao %}<p class="card-text mb-0">{{ notificacao.descricao }}</p>{% else %}<p class="card-text text-muted mb-0">Nenhuma descrição fornecida.</p>{% endif %}
                    </div>
                    <!-- CARD FOOTER (MODIFICADO PARA MELHOR RESPONSIVIDADE) -->
                    <div class="card-footer d-flex flex-wrap justify-content-between align-items-center gap-3">
                        <div class="d-flex align-items-center gap-3 user-info">
                            <span class="text-muted small">
                                Por: <strong>{{ notificacao.usuario_reportou.userprofile.nome|default:"Usuário Deletado" }}</strong>
                            </span>
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-visualizar-questao"
                                    data-questao-id="{{ notificacao.questao.id }}" title="Visualizar Questão">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="card-footer-actions">
                            {% if notificacao.status == 'PENDENTE' %}
                            <div class="d-flex gap-2">
                                <form method="POST" action="{% url 'gestao:resolver_notificacao' notificacao.id %}?{{ request.GET.urlencode }}" class="w-100 form-require-confirmation">
                                    {% csrf_token %}<button type="submit" class="btn btn-success btn-sm w-100"><i class="fas fa-check me-1"></i>Resolver</button>
                                </form>
                                <form method="POST" action="{% url 'gestao:arquivar_notificacao' notificacao.id %}?{{ request.GET.urlencode }}" class="w-100 form-require-confirmation-archive">
                                    {% csrf_token %}<button type="submit" class="btn btn-outline-secondary btn-sm w-100"><i class="fas fa-archive me-1"></i>Arquivar</button>
                                </form>
                            </div>
                            {% elif notificacao.status == 'RESOLVIDO' %}
                            <div class="d-flex align-items-center gap-3">
                                <span class="text-success small"><i class="fas fa-check-circle me-1"></i>Resolvido</span>
                                <form method="POST" action="{% url 'gestao:arquivar_notificacao' notificacao.id %}?{{ request.GET.urlencode }}" class="form-require-confirmation-archive">
                                    {% csrf_token %}<button type="submit" class="btn btn-outline-secondary btn-sm" title="Arquivar"><i class="fas fa-archive"></i></button>
                                </form>
                            </div>
                            {% elif notificacao.status == 'ARQUIVADO' %}
                            <div class="d-flex align-items-center gap-3">
                                <span class="text-muted small"><i class="fas fa-archive me-1"></i>Arquivado em {{ notificacao.data_arquivamento|date:"d/m/Y" }}</span>
                                <form method="POST" action="{% url 'gestao:desarquivar_notificacao' notificacao.id %}?{{ request.GET.urlencode }}">
                                    {% csrf_token %}<button type="submit" class="btn btn-outline-info btn-sm" title="Restaurar"><i class="fas fa-undo"></i></button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
 
                {% include 'includes/_paginacao.html' with paginated_object=notificacoes page_numbers=page_numbers %}

            {% else %}
                <div class="text-center p-5 border rounded bg-light mt-5">
                    <h4 class="h5">Nenhuma notificação encontrada</h4>
                    <p class="text-muted mb-0">Não há notificações com os filtros aplicados.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- O restante do seu HTML (Modais e Scripts) permanece o mesmo -->
<!-- MODAL DE CONFIRMAÇÃO -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirmar Ação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmationModalBody">
                Tem certeza de que deseja prosseguir com esta ação?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-dark" id="btn-confirm-action">Sim, Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA VISUALIZAÇÃO RÁPIDA DA QUESTÃO -->
<div class="modal fade" id="visualizarQuestaoModal" tabindex="-1" aria-labelledby="visualizarQuestaoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="visualizarQuestaoModalLabel">
                    Visualizando Questão: <span id="modalQuestaoCodigo" class="fw-bold">...</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modalQuestaoSpinner" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
                <div id="modalQuestaoContent" style="display: none;">
                    <h6>Enunciado:</h6>
                    <div id="modalQuestaoEnunciado" class="enunciado-formatado mb-4 p-3 bg-light rounded"></div>
                    <h6>Alternativas:</h6>
                    <ul id="modalQuestaoAlternativas" class="list-group"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://unpkg.com/imask"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const inicioDateEl = document.querySelector("#data_inicio");
    const fimDateEl = document.querySelector("#data_fim");

    // Lógica da Máscara
    const applyDateMask = (element) => {
        if (!element) return null;
        return IMask(element, {
            mask: Date,
            pattern: 'd/`m/`Y',
            lazy: false,
            // ===================================================================
            // CORREÇÃO 1: 'autofix: true' ajuda a corrigir digitações parciais
            // ===================================================================
            autofix: true, 
            blocks: {
                d: { mask: IMask.MaskedRange, from: 1, to: 31, maxLength: 2 },
                m: { mask: IMask.MaskedRange, from: 1, to: 12, maxLength: 2 },
                // ===================================================================
                // CORREÇÃO 2: Simplificando a máscara do ano para aceitar 4 dígitos
                // sem o 'range', que estava causando o problema.
                // ===================================================================
                Y: { mask: IMask.MaskedRange, from: 1900, to: 9999 }
            },
            // Adicionando parse e format para melhor integração
            parse: function (str) {
                const [day, month, year] = str.split('/');
                return new Date(year, month - 1, day);
            },
            format: function (date) {
                let day = date.getDate();
                let month = date.getMonth() + 1;
                let year = date.getFullYear();
                
                if (day < 10) day = "0" + day;
                if (month < 10) month = "0" + month;

                return [day, month, year].join('/');
            },
        });
    };

    // Configuração comum para ambos os seletores de data
    const commonFlatpickrConfig = {
        dateFormat: "Y-m-d", // Formato que o backend (Django) entende
        altInput: true,      // Cria um campo de input visual separado
        altFormat: "d/m/Y",  // Formato que o usuário vê (DD/MM/AAAA)
        allowInput: true,    // Permite que o usuário digite a data
    };

    // Inicializa os seletores
    let inicioPicker, fimPicker;

    inicioPicker = flatpickr(inicioDateEl, {
        ...commonFlatpickrConfig,
        onReady: function(selectedDates, dateStr, instance) {
            const mask = applyDateMask(instance.altInput);
            if (mask) {
                mask.on('complete', () => {
                    instance.setDate(mask.value, true, 'd/m/Y');
                });
            }
        },
        onChange: function(selectedDates, dateStr, instance) {
            if (fimPicker) {
                fimPicker.set('minDate', selectedDates[0]);
            }
        },
    });

    fimPicker = flatpickr(fimDateEl, {
        ...commonFlatpickrConfig,
        onReady: function(selectedDates, dateStr, instance) {
            const mask = applyDateMask(instance.altInput);
            if (mask) {
                mask.on('complete', () => {
                    instance.setDate(mask.value, true, 'd/m/Y');
                });
            }
        },
        onChange: function(selectedDates, dateStr, instance) {
            if (inicioPicker) {
                inicioPicker.set('maxDate', selectedDates[0]);
            }
        },
    });

    const confirmationModalEl = document.getElementById('confirmationModal');
    const confirmationModal = confirmationModalEl ? new bootstrap.Modal(confirmationModalEl) : null;

    /**
     * Exibe um modal de confirmação genérico e executa um callback se confirmado.
     * @param {string} title - O título para o modal.
     * @param {string} message - A pergunta de confirmação.
     * @param {Function} onConfirmCallback - A função a ser executada ao clicar em "Confirmar".
     */



    function showConfirmationModal(title, message, onConfirmCallback) {
        if (!confirmationModal) {
            // Fallback para o confirm() padrão se o modal não for encontrado
            if (confirm(message)) {
                onConfirmCallback();
            }
            return;
        }

        // Preenche o modal com o conteúdo dinâmico
        document.getElementById('confirmationModalLabel').textContent = title;
        document.getElementById('confirmationModalBody').textContent = message;

        const confirmBtn = document.getElementById('btn-confirm-action');

        // Clona o botão para remover event listeners antigos e evitar disparos múltiplos
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        // Adiciona o novo evento de clique que executa o callback
        newConfirmBtn.addEventListener('click', () => {
            onConfirmCallback();
            confirmationModal.hide();
        }, { once: true }); // A opção 'once' garante que o evento dispare apenas uma vez

        confirmationModal.show();
    }

    // 2. Interceptar o envio de todos os formulários que requerem confirmação
    document.querySelectorAll('.form-require-confirmation').forEach(form => {
        form.addEventListener('submit', function(event) {
            // Previne o envio imediato do formulário
            event.preventDefault();

            // Mensagem de confirmação (pode ser personalizada se necessário)
            const message = 'Tem certeza que deseja marcar esta notificação como resolvida?';

            // Exibe o modal de confirmação
            showConfirmationModal('Confirmar Resolução', message, () => {
                // Se o usuário confirmar, o formulário é enviado
                form.submit();
            });
        });
    });
    // --- FIM DA NOVA LÓGICA DE MODAIS ---


    // ===================================================================
    // INÍCIO: LÓGICA PARA CONFIRMAÇÃO DE AÇÕES INDIVIDUAIS
    // ===================================================================
    document.querySelectorAll('.form-require-confirmation').forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const message = 'Tem certeza que deseja marcar esta notificação como resolvida?';
            showConfirmationModal('Confirmar Resolução', message, () => {
                form.submit();
            });
        });
    });

    document.querySelectorAll('.form-require-confirmation-archive').forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const message = 'Tem certeza que deseja arquivar esta notificação?';
            showConfirmationModal('Confirmar Arquivamento', message, () => {
                form.submit();
            });
        });
    });
    // ===================================================================
    // FIM: LÓGICA PARA CONFIRMAÇÃO DE AÇÕES INDIVIDUAIS
    // ===================================================================


    // ===================================================================
    // INÍCIO: LÓGICA PARA AÇÕES EM MASSA
    // ===================================================================
    const bulkActionsBar = document.getElementById('bulk-actions-bar');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const notificationCheckboxes = document.querySelectorAll('.notification-checkbox');
    const selectedCountSpan = document.getElementById('selected-count');
    const bulkActionButtons = document.querySelectorAll('.bulk-action-btn');

    function updateBulkActionBar() {
        if (!bulkActionsBar) return;
        const selectedCheckboxes = document.querySelectorAll('.notification-checkbox:checked');
        const count = selectedCheckboxes.length;

        if (count > 0) {
            bulkActionsBar.style.display = 'block';
            selectedCountSpan.textContent = count;
        } else {
            bulkActionsBar.style.display = 'none';
        }
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = count > 0 && count === notificationCheckboxes.length;
        }
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            notificationCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActionBar();
        });
    }

    notificationCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActionBar);
    });

    bulkActionButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const action = this.dataset.action;
            const selectedIds = Array.from(document.querySelectorAll('.notification-checkbox:checked')).map(cb => cb.dataset.id);

            if (selectedIds.length === 0) return;
            
            let confirmationMessage = `Tem certeza que deseja aplicar a ação "${action}" para ${selectedIds.length} item(ns)?`;
            if (action === 'excluir') {
                confirmationMessage += " Esta ação é PERMANENTE e não pode ser desfeita.";
            }

            showConfirmationModal('Confirmar Ação em Massa', confirmationMessage, () => {
                fetch("{% url 'gestao:notificacoes_acoes_em_massa' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ ids: selectedIds, action: action })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload(); // Recarrega a página para ver o resultado
                    } else {
                        // Você pode trocar este alert por um modal de erro no futuro
                        showNotificationModal('Erro na Ação', data.message || 'Não foi possível completar a ação.', 'error');
                    }
                }).catch(err => {
                    console.error('Erro de rede nas ações em massa:', err);
                    showNotificationModal('Erro de Conexão', 'Não foi possível se comunicar com o servidor. Tente novamente.', 'error');
                });
            });
        });
    });
    // ===================================================================
    // FIM: LÓGICA PARA AÇÕES EM MASSA
    // ===================================================================

    // ===================================================================
    // INÍCIO: LÓGICA PARA O MODAL DE VISUALIZAÇÃO DE QUESTÃO (ADICIONE ISTO)
    // ===================================================================
    const visualizarQuestaoModalEl = document.getElementById('visualizarQuestaoModal');
    const visualizarQuestaoModal = visualizarQuestaoModalEl ? new bootstrap.Modal(visualizarQuestaoModalEl) : null;
    
    const modalCodigo = document.getElementById('modalQuestaoCodigo');
    const modalEnunciado = document.getElementById('modalQuestaoEnunciado');
    const modalAlternativas = document.getElementById('modalQuestaoAlternativas');
    const modalSpinner = document.getElementById('modalQuestaoSpinner');
    const modalContent = document.getElementById('modalQuestaoContent');

    document.querySelectorAll('.btn-visualizar-questao').forEach(button => {
        button.addEventListener('click', function() {
            const questaoId = this.dataset.questaoId;
            
            // 1. Reseta e prepara o modal para carregar
            if (!visualizarQuestaoModal) return;
            modalContent.style.display = 'none';
            modalSpinner.style.display = 'block';
            modalCodigo.textContent = '...';
            modalEnunciado.innerHTML = '';
            modalAlternativas.innerHTML = '';
            visualizarQuestaoModal.show();

            // 2. Busca os dados da questão na nossa API
            fetch(`/gestao/api/visualizar-questao/${questaoId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 3. Preenche o modal com os dados recebidos
                        modalCodigo.textContent = data.codigo;
                        modalEnunciado.innerHTML = data.enunciado;

                        // Limpa e cria a lista de alternativas
                        modalAlternativas.innerHTML = '';
                        for (const [key, value] of Object.entries(data.alternativas)) {
                            const listItem = document.createElement('li');
                            listItem.classList.add('list-group-item');
                            
                            // Destaca a alternativa correta (gabarito)
                            if (key === data.gabarito) {
                                listItem.classList.add('list-group-item-success', 'fw-bold');
                            }
                            
                            listItem.innerHTML = `<strong>${key})</strong> ${value}`;
                            modalAlternativas.appendChild(listItem);
                        }

                        // 4. Mostra o conteúdo e esconde o spinner
                        modalSpinner.style.display = 'none';
                        modalContent.style.display = 'block';

                    } else {
                        // Trata o erro
                        modalEnunciado.innerHTML = `<div class="alert alert-danger">Erro ao carregar a questão: ${data.message}</div>`;
                        modalSpinner.style.display = 'none';
                        modalContent.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    modalEnunciado.innerHTML = `<div class="alert alert-danger">Ocorreu um erro de comunicação. Tente novamente.</div>`;
                    modalSpinner.style.display = 'none';
                    modalContent.style.display = 'block';
                });
        });
    });
    // ===================================================================
    // FIM: LÓGICA DO MODAL
    // ===================================================================
});
</script>
{% endblock %}