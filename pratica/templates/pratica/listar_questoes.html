<!-- pratica/listar_questoes.html -->

{% extends 'base.html' %}
{% load static %}
{% load questoes_extras %} 
{% load pratica_extras %} 

{% block title %}Praticar Questões{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/listagem-comum.css' %}">
<style>
    /* ========================================================================= */
    /* ESTILOS GERAIS DA PÁGINA DE PRÁTICA
    /* ========================================================================= */
    .enunciado-imagem {
        max-width: 100%;
        max-height: 450px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        border-radius: var(--raio-borda);
        box-shadow: var(--sombra-caixa);
    }
    
    /* Botões de filtro por status (Ex: Resolvidas, Acertei, Errei) */
    .btn-status-filter {
        border-radius: 20px !important;
        font-weight: 500;
        padding: 0.5rem 1.25rem;
        margin: 0.25rem;
        border: 1px solid var(--cor-borda);
        color: var(--cor-secundaria);
        transition: var(--transicao-padrao);
    }
    .btn-status-filter:hover {
        background-color: #e9ecef;
        border-color: #e9e7e0;
    }
    .btn-status-filter.active {
        background-color: var(--cor-primaria);
        color: var(--cor-texto-claro);
        border-color: var(--cor-primaria);
        box-shadow: 0 2px 4px rgba(74, 144, 226, 0.4);
    }
    
    /* ========================================================================= */
    /* ESTILOS PARA O EDITOR DE TEXTO TIPTAP (Comentários)
    /* ========================================================================= */
    .tiptap-toolbar {
        border: 1px solid var(--cor-borda);
        border-bottom: none;
        padding: .5rem;
        border-top-left-radius: var(--raio-borda);
        border-top-right-radius: var(--raio-borda);
        background-color: #f8f9fa;
    }
    .tiptap-toolbar button {
        border: none;
        background-color: transparent;
        border-radius: 4px;
        transition: var(--transicao-padrao);
    }
    .tiptap-toolbar button:hover {
        background-color: var(--cor-texto-escuro);
        color: var(--cor-texto-claro);
    }
    .tiptap-toolbar button.active {
        background-color: var(--cor-primaria);
        color: var(--cor-texto-claro);
    }
    
    .tiptap {
        border: 1px solid var(--cor-borda);
        border-radius: var(--raio-borda);
        padding: .75rem 1rem;
        min-height: 150px;
        background-color: var(--cor-fundo-claro);
    }
    .tiptap:focus-within { /* Aplica ao container quando o editor interno ganha foco */
        border-color: var(--cor-primaria);
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(74, 144, 226, .25);
    }
    
    .tiptap p.is-editor-empty:first-child::before {
      content: attr(data-placeholder);
      float: left;
      color: #adb5bd;
      pointer-events: none;
      height: 0;
    }
    
    .comment-edit-form .tiptap {
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }
    
    /* ========================================================================= */
    /* ESTILOS PARA A SEÇÃO DE COMENTÁRIOS
    /* ========================================================================= */
    .comentarios-section {
        background-color: #f8f9fa;
        border-radius: 0 0 var(--raio-borda) var(--raio-borda);
    }
    
    .comment-wrapper {
        position: relative;
        padding-left: 60px; /* Espaço para o avatar (40px) + gap (20px) */
        margin-bottom: 1.5rem;
    }
    
    .comment-card {
        background-color: var(--cor-fundo-claro);
        border: 1px solid var(--cor-borda);
        border-radius: var(--raio-borda);
        padding: 1rem 1.5rem;
        position: relative; /* Contexto para a seta do balão */
        box-shadow: none;
    }
    
    /* Seta do balão (simula um balão de fala) */
    .comment-card::before, .comment-card::after {
        content: '';
        position: absolute;
        top: 14px;
        left: -22px; 
        width: 0; height: 0;
        border: 11px solid transparent;
        border-right-color: var(--cor-borda);
    }
    .comment-card::after {
        left: -19px;
        top: 15px;
        border-width: 10px;
        border-right-color: var(--cor-fundo-claro);
    }
    
    .comment-wrapper .comment-avatar {
        position: absolute;
        left: 0; top: 0;
    }
    
    .new-comment-form-container {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .comment-avatar .avatar-icon {
        width: 40px; height: 40px;
        background-image: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
        color: var(--cor-texto-claro);
        display: flex;
        align-items: center; justify-content: center;
        border-radius: 50%;
        font-weight: bold; font-size: 1.1rem;
    }
    
    .comment-user { font-weight: 600; color: var(--cor-texto-escuro); }
    .comment-date { font-size: 0.8rem; color: var(--cor-secundaria); }
    
    .comment-footer {
        margin-top: 1rem;
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }
    .comment-footer a {
        text-decoration: none;
        color: var(--cor-secundaria);
        font-weight: 500;
        font-size: 0.85rem;
    }
    .comment-footer a:hover { color: var(--cor-primaria); }
    .btn-like.liked { color: var(--cor-primaria); font-weight: bold; }
    
    .comment-replies {
        margin-left: 4.5rem;
        padding-left: 1rem;
        border-left: 2px solid var(--cor-borda);
        margin-top: 1.5rem;
    }
    
    /* ========================================================================= */
    /* ESTILOS UNIFICADOS PARA CONTEÚDO (MARKDOWN)
    /* ========================================================================= */
    .enunciado-formatado, .explicacao, .tiptap, .comment-body {
        font-size: 1rem;
        line-height: 1.7;
        color: var(--cor-texto-escuro);
    }
    
    .enunciado-formatado p, .explicacao p, .tiptap p, .comment-body p { margin-bottom: 1rem; }
    .enunciado-formatado ul, .explicacao ul, .tiptap ul, .comment-body ul { padding-left: 1.5rem; margin-bottom: 1rem; }
    .enunciado-formatado blockquote, .explicacao blockquote, .tiptap blockquote, .comment-body blockquote {
        font-style: italic; color: var(--cor-secundaria);
        padding-left: 1.5rem; border-left: 4px solid var(--cor-borda);
        margin: 1rem 0;
    }

    /* ========================================================================= */
    /* ESTILOS ESPECÍFICOS DO CARD DA QUESTÃO
    /* ========================================================================= */
    .card-questao {
        background-color: var(--cor-fundo-claro);
        border: none;
        border-radius: var(--raio-borda);
        box-shadow: var(--sombra-caixa);
        margin-bottom: 2rem;
        overflow: hidden;
    }
    
    .card-questao .fa-star {
        font-size: 1.25rem; cursor: pointer; color: #ced4da;
    }
    .card-questao .fa-star.fas.text-warning {
        color: var(--cor-aviso) !important;
    }
    
    /* Feedback de Resposta */
    .alternativas .form-check-label.text-success { color: var(--cor-sucesso) !important; font-weight: bold; }
    .alternativas .form-check-label.text-danger { color: var(--cor-erro) !important; }
    .alternativas .form-check-label.text-danger::after {
        content: " (Sua resposta)"; font-style: italic; font-weight: normal;
    }
    
    .explicacao {
        background-color: #f8f9fa;
        border-radius: var(--raio-borda);
        border-left: 4px solid var(--cor-primaria);
    }

    /* ========================================================================= */
    /* AJUSTES PARA TELAS MOBILE (ATÉ 768px)
    /* ========================================================================= */
    @media (max-width: 768px) {
        .container { max-width: 100%; padding: 0; }
        .filtros-card, .card-questao {
            width: 100%;
            border-radius: 0;
            margin: 0 0 1rem 0;
            box-shadow: none;
            border-bottom: 1px solid var(--cor-borda); 
        }
        .card-body, .card-header, .card-footer, .comentarios-section { padding: 1.25rem; }
        .comment-wrapper { padding-left: 55px; }
        .comment-replies { margin-left: 1.25rem; padding-left: 1rem; }
    }
</style>
{% endblock %}


{% block content %}
<div class="container mt-5">

    <!-- CABEÇALHO E FILTROS -->
    <div class="filtros-card p-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0 h4">Filtrar Questões</h2>
            <div>
                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#filtrosSalvosModal">
                    <i class="fas fa-filter me-2"></i>Meus Filtros
                </button>
            </div>
        </div>

        <!-- Filtros rápidos por STATUS -->
        <div class="mb-4 text-center">
            <div class="btn-group flex-wrap" role="group" aria-label="Filtros de status">
                <!-- O botão "TODAS" agora remove o parâmetro 'status' da URL -->
                <a href="?{% url_replace status='' %}" class="btn btn-status-filter {% if not request.GET.status %}active{% endif %}">TODAS</a>
                
                <!-- Os outros botões definem o parâmetro 'status' para o valor correto -->
                <a href="?{% url_replace status='respondidas' %}" class="btn btn-status-filter {% if request.GET.status == 'respondidas' %}active{% endif %}">RESOLVIDAS</a>
                <a href="?{% url_replace status='nao_respondidas' %}" class="btn btn-status-filter {% if request.GET.status == 'nao_respondidas' %}active{% endif %}">NÃO RESOLVIDAS</a>
                <a href="?{% url_replace status='acertei' %}" class="btn btn-status-filter {% if request.GET.status == 'acertei' %}active{% endif %}">ACERTEI</a>
                <a href="?{% url_replace status='errei' %}" class="btn btn-status-filter {% if request.GET.status == 'errei' %}active{% endif %}">ERREI</a>
                <a href="?{% url_replace status='favoritas' %}" class="btn btn-status-filter {% if request.GET.status == 'favoritas' %}active{% endif %}">FAVORITAS</a>
            </div>
        </div>

        <!-- INCLUSÃO DO COMPONENTE DE FILTROS REUTILIZÁVEL -->
        {% include 'includes/_filtros_questoes.html' with form_action_url=request.path status_param=status_param %}
        
        <div class="text-center mt-3">
            <button type="button" class="btn btn-link text-secondary" data-bs-toggle="modal" data-bs-target="#salvarFiltroModal">
                <i class="fas fa-save me-2"></i>Salvar Filtros Atuais
            </button>
        </div>
    </div>

    <!-- CONTROLES DE ORDENAÇÃO E PAGINAÇÃO -->
    {% include 'gestao/includes/_ordenacao_e_paginacao_controls.html' with paginated_object=questoes sort_options=sort_options sort_by=sort_by per_page=per_page %}
   
    <!-- LISTAGEM DE QUESTÕES -->
    {% for questao in questoes %}
    <div class="card card-questao mb-4" id="questao-{{ questao.id }}">
        
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <span class="badge bg-dark me-2">{{ forloop.counter0|add:questoes.start_index }}.</span>
                <span class="badge bg-primary me-2">{{ questao.codigo }}</span>
                <strong>{{ questao.disciplina.nome }}</strong> - {{ questao.assunto.nome }}
                {% if questao.is_inedita %}
                    <span class="badge bg-info ms-2">Inédita</span>
                {% elif questao.banca and questao.ano %}
                    <span class="text-muted ms-2">({{ questao.banca.nome }} - {{ questao.ano }})</span>
                {% endif %}
            </div>
            <i class="fa-star {% if questao.id in favoritas_ids %}fas text-warning{% else %}far{% endif %}"
               style="cursor: pointer;"
               data-questao-id="{{ questao.id }}"
               title="Marcar como favorita"></i>
        </div>

        <div class="card-body p-4">
            {% if questao.imagem_enunciado %}
                <img src="{{ questao.imagem_enunciado.url }}" class="enunciado-imagem mb-4" alt="Imagem da questão">
            {% endif %}

            <div class="card-text enunciado-formatado mb-4">
                {{ questao.enunciado|render_markdown|safe }}
            </div>
            
            <hr>

            <div class="alternativas mt-4" data-questao-id="{{ questao.id }}">
                {% for key, value in questao.get_alternativas_dict.items %}
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="alternativa-{{ questao.id }}" id="q{{ questao.id }}-{{ key }}" value="{{ key }}">
                    <label class="form-check-label w-100" for="q{{ questao.id }}-{{ key }}">
                        <strong>{{ key }})</strong> {{ value }}
                    </label>
                </div>
                {% endfor %}
            </div>
            
            <button type="button" class="btn btn-success mt-4 w-100 btn-responder" data-questao-id="{{ questao.id }}">Responder</button>

            <div class="feedback mt-4" style="display: none;">
                <div class="alert"></div>
                <div class="explicacao p-3 mt-3" style="display: none;">
                    <h5 class="h6">Explicação da Alternativa Correta:</h5>
                    <div class="explicacao-conteudo"></div>
                </div>
            </div>
        </div>

        <div class="card-footer bg-white d-flex justify-content-center gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm btn-toggle-explicacao d-none" data-questao-id="{{ questao.id }}">
                <i class="fas fa-graduation-cap me-1"></i> Gabarito Comentado
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm btn-toggle-comentarios" data-questao-id="{{ questao.id }}">
                <i class="far fa-comment me-1"></i> Comentários
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalNotificarErro" data-questao-id="{{ questao.id }}">
                <i class="fas fa-flag me-1"></i> Notificar Erro
            </button>
        </div>

        <!-- Seção de Comentários (Oculta) -->
        <div class="comentarios-section p-3" id="comentarios-section-{{ questao.id }}" style="display: none;">
            {% include 'pratica/includes/_secao_comentarios.html' %}
        </div>
    </div>
    {% empty %}
    <div class="card card-body text-center py-5">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h4 class="h5">Nenhuma questão encontrada</h4>
        <p class="text-muted">Tente ajustar seus filtros ou buscar por outros termos.</p>
    </div>
    {% endfor %}

    <!-- COMPONENTE DE PAGINAÇÃO -->
    {% include 'includes/_paginacao.html' with paginated_object=questoes %} 

</div>

<!-- INCLUSÃO DOS MODAIS REUTILIZÁVEIS -->
{% include 'pratica/includes/_modais_pratica.html' %}

{% endblock %}

{% block scripts %}
<!-- Importação dos Módulos do Tiptap -->
<script type="module">
    import { Editor } from 'https://esm.sh/@tiptap/core';
    import StarterKit from 'https://esm.sh/@tiptap/starter-kit';
    import { Markdown } from 'https://esm.sh/tiptap-markdown';
    import Underline from 'https://esm.sh/@tiptap/extension-underline';
    import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder';
   
    // Disponibiliza globalmente para o script inline
    window.TipTap = { Editor, StarterKit, Markdown, Underline, Placeholder };
</script>

<!-- SCRIPT DE FILTROS -->
<script src="{% static 'js/filtros-questoes.js' %}"></script>

<!-- LÓGICA JS ESPECÍFICA DA PÁGINA -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // =======================================================================
        // INICIALIZAÇÃO E VARIÁVEIS
        // =======================================================================
        const tiptapEditors = {}; // Armazena instâncias dos editores Tiptap
        let editTiptapEditor = null; // Editor único para edição de comentários
    
        // Inicializa o editor de edição de comentários assim que o Tiptap estiver disponível
        if (window.TipTap) {
            const { Editor, StarterKit, Markdown, Underline, Placeholder } = window.TipTap;
            editTiptapEditor = new Editor({
                extensions: [ StarterKit, Markdown.configure({ html: false }), Underline, Placeholder.configure({ placeholder: 'Edite sua resposta...' }) ],
                content: '',
            });
        } else {
            console.error("Tiptap não foi carregado a tempo para criar o editor de edição.");
        }
    
        // =======================================================================
        // FUNÇÕES DE MANIPULAÇÃO DO TIPTAP
        // =======================================================================
        function initializeTiptapEditor({ editorElement, toolbarElement, hiddenTextarea }) {
            if (editorElement.tiptapEditor) return editorElement.tiptapEditor;
    
            const { Editor, StarterKit, Markdown, Underline, Placeholder } = window.TipTap;
            if (!Editor) {
                console.error("Tiptap não carregou corretamente.");
                return;
            }
    
            const editor = new Editor({
                element: editorElement,
                extensions: [
                    StarterKit, Markdown.configure({ html: false, linkify: true, breaks: true }), Underline,
                    Placeholder.configure({ placeholder: 'Escreva o seu comentário...' }),
                ],
                content: '',
                onUpdate: ({ editor }) => {
                    hiddenTextarea.value = editor.storage.markdown.getMarkdown();
                },
            });
    
            toolbarElement.querySelectorAll('button[data-command]').forEach(button => {
                button.addEventListener('click', () => {
                    const command = button.dataset.command;
                    const commands = {
                        toggleBold: () => editor.chain().focus().toggleBold().run(),
                        toggleItalic: () => editor.chain().focus().toggleItalic().run(),
                        toggleUnderline: () => editor.chain().focus().toggleUnderline().run(),
                        toggleBulletList: () => editor.chain().focus().toggleBulletList().run(),
                        toggleOrderedList: () => editor.chain().focus().toggleOrderedList().run(),
                    };
                    if (commands[command]) commands[command]();
                });
            });
    
            editorElement.tiptapEditor = editor;
            return editor;
        }
    
        // =======================================================================
        // DELEGAÇÃO DE EVENTOS CENTRALIZADA (CORRIGIDA)
        // =======================================================================
        document.body.addEventListener('click', function(e) {
            const target = e.target;
            const link = target.closest('a');
            const button = target.closest('button');
            const icon = target.closest('.fa-star');
    
            // Ações em links (<a>)
            if (link) {
                if (link.classList.contains('btn-like')) { e.preventDefault(); handleLikeComentario(link); }
                else if (link.classList.contains('toggle-replies-btn')) { e.preventDefault(); handleToggleReplies(link); }
                else if (link.classList.contains('sort-comments-btn')) { e.preventDefault(); handleSortClick(link); }
            }
            // Ações em botões (<button>)
            else if (button) {
                if (button.id === 'btn-confirmar-salvar-filtro') { handleSalvarFiltro(); }
                else if (button.classList.contains('btn-deletar-filtro')) {
                    const filtroId = button.dataset.filtroId;
                    const nomeFiltro = button.closest('.list-group-item').querySelector('a').textContent;
                    showConfirmationModal(`Deseja realmente excluir o filtro "${nomeFiltro}"?`, () => handleDeletarFiltro(filtroId));
                }
                else if (button.classList.contains('btn-responder')) { handleResponder(button); }
                else if (button.classList.contains('btn-toggle-comentarios')) { handleToggleComentarios(button); }
                else if (button.classList.contains('btn-toggle-explicacao')) { handleToggleExplicacao(button); }
                else if (button.classList.contains('btn-excluir-comentario')) {
                    const comentarioId = button.dataset.comentarioId;
                    showConfirmationModal('Deseja realmente excluir o seu comentário?', () => handleExcluirComentario(comentarioId));
                }
                else if (button.classList.contains('btn-editar-comentario')) { handleAbrirEdicao(button); }
                else if (button.classList.contains('btn-salvar-edicao')) { handleSalvarEdicao(button); }
                else if (button.classList.contains('btn-cancelar-edicao')) { cancelarEdicao(button.closest('.comment-edit-form')); }
            }
            // Ações em ícones (<i>)
            else if (icon) {
                handleFavoritar(icon);
            }
        });
    
        document.body.addEventListener('submit', function(e) {
            if (e.target.classList.contains('form-comentario')) {
                e.preventDefault();
                handleAdicionarComentario(e.target);
            }
            if (e.target.id === 'form-notificar-erro') {
                e.preventDefault();
                handleNotificarErro(e.target);
            }
        });
    
        // =======================================================================
        // HANDLERS DE AÇÕES (lógica principal da página)
        // =======================================================================
    
        /** Lida com o salvamento de um novo conjunto de filtros. */
        function handleSalvarFiltro() {
            const inputNome = document.getElementById('input-nome-filtro');
            if (!inputNome.value.trim()) { inputNome.classList.add('is-invalid'); return; }
            inputNome.classList.remove('is-invalid');
            const params = new URLSearchParams(new FormData(document.getElementById('form-filtros'))).toString();
            
            fetch("{% url 'pratica:salvar_filtro' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ nome: inputNome.value, parametros: params })
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('salvarFiltroModal')).hide();
                    const lista = document.getElementById('lista-modal-filtros-salvos');
                    document.getElementById('sem-filtros-salvos-msg')?.remove();
                    lista.insertAdjacentHTML('beforeend', `
                        <li class="list-group-item d-flex justify-content-between align-items-center" id="filtro-salvo-item-${result.filtro.id}">
                            <a href="?${result.filtro.parametros}" class="text-decoration-none text-dark flex-grow-1">${result.filtro.nome}</a>
                            <button type="button" class="btn btn-sm btn-danger btn-deletar-filtro" data-filtro-id="${result.filtro.id}">&times;</button>
                        </li>`);
                    showNotificationModal('Sucesso!', 'Filtro salvo com sucesso.', 'success');
                } else { showNotificationModal('Erro ao Salvar', result.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível salvar. Tente novamente.', 'error'));
        }
    
        /** Lida com a exclusão de um filtro salvo. */
        function handleDeletarFiltro(filtroId) {
            fetch("{% url 'pratica:deletar_filtro' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ filtro_id: filtroId })
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    document.getElementById(`filtro-salvo-item-${filtroId}`).remove();
                } else { showNotificationModal('Erro ao Deletar', result.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível deletar. Tente novamente.', 'error'));
        }
    
        /** Lida com o envio de uma resposta de questão. */
        function handleResponder(button) {
            const questaoId = button.dataset.questaoId;
            const questaoCard = document.getElementById(`questao-${questaoId}`);
            const alternativaSelecionada = questaoCard.querySelector(`input[name="alternativa-${questaoId}"]:checked`);
            if (!alternativaSelecionada) { 
                showNotificationModal('Atenção', 'Por favor, selecione uma alternativa.', 'info'); 
                return; 
            }
            
            fetch("{% url 'pratica:verificar_resposta' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ questao_id: questaoId, alternativa: alternativaSelecionada.value })
            })
            .then(response => response.json())
            .then(result => {
                const feedbackDiv = questaoCard.querySelector('.feedback');
                const alertDiv = feedbackDiv.querySelector('.alert');
                
                questaoCard.querySelectorAll('.form-check-input').forEach(input => input.disabled = true);
                button.style.display = 'none';
    
                alertDiv.className = result.correta ? 'alert alert-success' : 'alert alert-danger';
                alertDiv.textContent = result.correta ? `Correto! O gabarito é ${result.gabarito}.` : `Incorreto. A resposta correta era ${result.gabarito}.`;
                
                questaoCard.querySelectorAll('.form-check-label').forEach(label => {
                    const key = label.getAttribute('for').split('-')[1];
                    if (key === result.gabarito) label.classList.add('text-success');
                    if (!result.correta && key === alternativaSelecionada.value) label.classList.add('text-danger');
                });
    
                if (result.explicacao) {
                    feedbackDiv.querySelector('.explicacao-conteudo').innerHTML = result.explicacao;
                    questaoCard.querySelector('.btn-toggle-explicacao').classList.remove('d-none');
                }
                feedbackDiv.style.display = 'block';
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível verificar a resposta.', 'error'));
        }
    
        /** Alterna a visibilidade da explicação da questão. */
        function handleToggleExplicacao(button) {
            const questaoId = button.dataset.questaoId;
            const explicacaoDiv = document.getElementById(`questao-${questaoId}`).querySelector('.explicacao');
            if (explicacaoDiv) {
                const isHidden = explicacaoDiv.style.display === 'none' || !explicacaoDiv.style.display;
                explicacaoDiv.style.display = isHidden ? 'block' : 'none';
            }
        }
    
        /** Lida com o clique no ícone de favoritar. */
        function handleFavoritar(icon) {
            fetch("{% url 'pratica:favoritar_questao' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ questao_id: icon.dataset.questaoId })
            })
            .then(response => response.ok ? response.json() : Promise.reject('Erro na resposta do servidor'))
            .then(result => {
                if (result.status === 'success') {
                    icon.classList.toggle('far');
                    icon.classList.toggle('fas');
                    icon.classList.toggle('text-warning');
                } else { showNotificationModal('Erro', result.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível favoritar.', 'error'));
        }
    
        /** Alterna a seção de comentários e carrega-os se for a primeira vez. */
        function handleToggleComentarios(button) {
            const questaoId = button.dataset.questaoId;
            const comentariosSection = document.getElementById(`comentarios-section-${questaoId}`);
            const isHidden = comentariosSection.style.display === 'none';
            comentariosSection.style.display = isHidden ? 'block' : 'none';
    
            if (isHidden) {
                if (!tiptapEditors[questaoId]) { // Inicializa o editor de novo comentário
                    const form = comentariosSection.querySelector('.form-comentario');
                    if (form) {
                        tiptapEditors[questaoId] = initializeTiptapEditor({
                            editorElement: form.querySelector('.tiptap-editor'),
                            toolbarElement: form.querySelector('.tiptap-toolbar'),
                            hiddenTextarea: form.querySelector('textarea[name="conteudo"]'),
                        });
                    }
                }
                if (comentariosSection.dataset.carregado !== 'true') {
                    carregarComentarios(questaoId);
                }
            }
        }
    
        /** Envia um novo comentário ou resposta. */
        function handleAdicionarComentario(form) {
            const questaoId = form.dataset.questaoId;
            const parentId = form.dataset.parentId;
            const conteudo = form.querySelector('textarea[name="conteudo"]').value;
            if (!conteudo.trim()) { showNotificationModal('Atenção', 'O comentário não pode estar vazio.', 'info'); return; }
    
            fetch("{% url 'pratica:adicionar_comentario' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ questao_id: questaoId, conteudo: conteudo, parent_id: parentId })
            })
            .then(r => r.json())
            .then(result => {
                if (result.status === 'success') {
                    carregarComentarios(questaoId); // Recarrega os comentários para mostrar o novo
                    if (!parentId && tiptapEditors[questaoId]) {
                        tiptapEditors[questaoId].commands.clearContent();
                    } else {
                        const formContainer = form.closest('.reply-form-container');
                        if (formContainer) formContainer.innerHTML = ''; // Limpa o formulário de resposta
                    }
                } else { showNotificationModal('Erro ao Comentar', result.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível enviar o comentário.', 'error'));
        }
    
        /** Lida com a exclusão de um comentário. */
        function handleExcluirComentario(comentarioId) {
            const questaoId = document.getElementById(`comment-wrapper-${comentarioId}`).closest('.card-questao').id.replace('questao-', '');
            fetch("{% url 'pratica:excluir_comentario' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ comentario_id: comentarioId })
            })
            .then(r => r.json())
            .then(res => {
                if (res.status === 'success') {
                    carregarComentarios(questaoId);
                } else { showNotificationModal('Erro ao Excluir', res.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível excluir.', 'error'));
        }
        
        /** Lida com o like/unlike de um comentário. */
        function handleLikeComentario(link) {
            fetch("{% url 'pratica:toggle_like_comentario' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ comentario_id: link.dataset.comentarioId })
            })
            .then(r => r.ok ? r.json() : Promise.reject('Erro de servidor'))
            .then(result => {
                if (result.status === 'success') {
                    link.querySelector('.like-count').textContent = result.likes_count;
                    link.classList.toggle('liked', result.liked);
                } else { showNotificationModal('Erro', result.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível registrar o like.', 'error'));
        }
    
        /** Alterna a visibilidade das respostas e insere o formulário de resposta. */
        function handleToggleReplies(link) {
            const comentarioId = link.dataset.comentarioId;
            const questaoId = link.closest('.card-questao').id.replace('questao-', '');
            const wrapper = document.getElementById(`comment-wrapper-${comentarioId}`);
            const repliesWrapper = wrapper.querySelector('.replies-wrapper');
    
            const isHidden = repliesWrapper.style.display === 'none' || !repliesWrapper.style.display;
            repliesWrapper.style.display = isHidden ? 'block' : 'none';
    
            if (isHidden) {
                const formContainer = repliesWrapper.querySelector('.reply-form-container');
                if (!formContainer.querySelector('form')) {
                    formContainer.innerHTML = `
                        <div class="new-comment-form-container mt-3">
                            <div class="comment-avatar"><div class="avatar-icon"><i class="fas fa-user"></i></div></div>
                            <form class="form-comentario form-reply flex-grow-1" data-questao-id="${questaoId}" data-parent-id="${comentarioId}">
                                <textarea name="conteudo" class="form-control form-control-sm" rows="3" placeholder="Escreva sua resposta..." required></textarea>
                                <div class="d-flex justify-content-end mt-2">
                                    <button type="button" class="btn btn-sm btn-secondary me-2" onclick="this.closest('.reply-form-container').innerHTML = ''">Cancelar</button>
                                    <button type="submit" class="btn btn-sm btn-primary">Enviar</button>
                                </div>
                            </form>
                        </div>`;
                }
            }
        }
    
        /** Lida com a mudança na ordenação dos comentários. */
        function handleSortClick(link) {
            const questaoId = link.dataset.questaoId;
            document.getElementById(`sort-label-${questaoId}`).textContent = link.textContent;
            carregarComentarios(questaoId, link.dataset.sort);
        }
    
        /** Abre o formulário de edição para um comentário. */
        function handleAbrirEdicao(button) {
            const comentarioId = button.dataset.comentarioId;
            const commentCard = document.getElementById(`comentario-${comentarioId}`);
            const contentDiv = commentCard.querySelector('.comment-content');
            const editFormDiv = commentCard.querySelector('.comment-edit-form');
            
            document.querySelectorAll('.comment-edit-form:not([style*="display: none"])').forEach(cancelarEdicao);
    
            const rawContent = contentDiv.dataset.rawContent;
            editFormDiv.innerHTML = `
                <div class="tiptap-toolbar">
                    <button type="button" data-command="toggleBold" title="Negrito"><b>B</b></button>
                    <button type="button" data-command="toggleItalic" title="Itálico"><i>I</i></button>
                    <button type="button" data-command="toggleUnderline" title="Sublinhado"><u>U</u></button>
                </div>
                <div class="tiptap-editor" id="tiptap-editor-edit-${comentarioId}"></div>
                <div class="mt-2 d-flex justify-content-center">
                    <button type="button" class="btn btn-sm btn-secondary btn-cancelar-edicao me-2">Cancelar</button>
                    <button type="button" class="btn btn-sm btn-primary btn-salvar-edicao" data-comentario-id="${comentarioId}">Salvar</button>
                </div>`;
    
            editFormDiv.querySelector('.tiptap-editor').appendChild(editTiptapEditor.view.dom);
            editTiptapEditor.commands.setContent(rawContent, false);
            editTiptapEditor.commands.focus();
            
            contentDiv.style.display = 'none';
            editFormDiv.style.display = 'block';
        }
    
        /** Envia a edição de um comentário. */
        function handleSalvarEdicao(button) {
            const comentarioId = button.dataset.comentarioId;
            const novoConteudo = editTiptapEditor.storage.markdown.getMarkdown();
    
            fetch("{% url 'pratica:editar_comentario' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ comentario_id: comentarioId, conteudo: novoConteudo })
            })
            .then(r => r.json())
            .then(result => {
                if(result.status === 'success') {
                    const contentDiv = document.getElementById(`comentario-${comentarioId}`).querySelector('.comment-content');
                    contentDiv.innerHTML = result.conteudo_html;
                    contentDiv.dataset.rawContent = novoConteudo;
                    cancelarEdicao(button.closest('.comment-edit-form'));
                } else { showNotificationModal('Erro ao Salvar', result.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível salvar a edição.', 'error'));
        }
    
        /** Cancela o modo de edição de um comentário. */
        function cancelarEdicao(editFormDiv) {
            if (!editFormDiv) return;
            const contentDiv = editFormDiv.closest('.comment-card').querySelector('.comment-content');
            contentDiv.style.display = 'block';
            editFormDiv.style.display = 'none';
            editFormDiv.innerHTML = '';
        }
    
        /** Carrega e renderiza os comentários de uma questão. */
        function carregarComentarios(questaoId, sortBy = 'recent') {
            const comentariosList = document.getElementById(`comentarios-list-${questaoId}`);
            comentariosList.innerHTML = '<p class="text-center text-muted py-4">Carregando...</p>';
            
            fetch(`/pratica/carregar-comentarios/${questaoId}/?sort_by=${sortBy}`)
                .then(response => response.ok ? response.json() : Promise.reject('Erro ao carregar'))
                .then(data => {
                    comentariosList.innerHTML = '';
                    if (data.comentarios.length > 0) {
                        data.comentarios.forEach(c => {
                            comentariosList.appendChild(criarElementoComentario(c));
                        });
                    } else {
                        comentariosList.innerHTML = '<p class="text-center text-muted py-4">Nenhum comentário ainda.</p>';
                    }
                    document.getElementById(`comentarios-section-${questaoId}`).dataset.carregado = 'true';
                }).catch(err => {
                    comentariosList.innerHTML = '<p class="text-center text-danger py-4">Erro ao carregar comentários.</p>';
                });
        }
    
        /** Gera um ELEMENTO DOM para um comentário. */
        function criarElementoComentario(c) {
            const template = document.createElement('template');
            template.innerHTML = `
                <div class="comment-wrapper" id="comment-wrapper-${c.id}">
                    <div class="comment-avatar"><div class="avatar-icon">${c.usuario.charAt(0).toUpperCase()}</div></div>
                    <div class="comment-card" id="comentario-${c.id}">
                        <div class="comment-header d-flex justify-content-between">
                            <div><span class="comment-user">${c.usuario}</span><div class="comment-date">${c.data_criacao}</div></div>
                            ${c.pode_editar ? `
                            <div class="comment-actions dropdown">
                                <button class="btn btn-sm" type="button" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-h"></i></button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><button class="dropdown-item btn-editar-comentario" type="button" data-comentario-id="${c.id}">Editar</button></li>
                                    <li><button class="dropdown-item text-danger btn-excluir-comentario" type="button" data-comentario-id="${c.id}">Excluir</button></li>
                                </ul>
                            </div>` : ''}
                        </div>
                        <div class="comment-content" data-raw-content="${c.conteudo_raw.replace(/"/g, '&quot;')}">
                            <div class="comment-body">${c.conteudo}</div>
                        </div>
                        <div class="comment-edit-form mt-2" style="display: none;"></div>
                        ${!c.parent_id ? `
                        <div class="comment-footer">
                            <a href="#" class="btn btn-like ${c.user_liked ? 'liked' : ''}" data-comentario-id="${c.id}">
                                <i class="fas fa-thumbs-up"></i> Gostei (<span class="like-count">${c.likes_count}</span>)
                            </a>
                            <a href="#" class="btn toggle-replies-btn" data-comentario-id="${c.id}">
                                <i class="fas fa-reply"></i> Respostas (${c.respostas_count})
                            </a>
                        </div>` : ''}
                    </div>
                    ${!c.parent_id ? `
                    <div class="replies-wrapper" style="display: none;">
                        <div class="comment-replies"></div>
                        <div class="reply-form-container"></div>
                    </div>` : ''}
                </div>`.trim();
    
            const commentElement = template.content.firstChild;
            
            if (c.respostas && c.respostas.length > 0) {
                const repliesContainer = commentElement.querySelector('.comment-replies');
                c.respostas.forEach(resposta => {
                    repliesContainer.appendChild(criarElementoComentario(resposta));
                });
            }
            
            return commentElement;
        }
        
        /** Lida com o envio do formulário de notificação de erro. */
        function handleNotificarErro(form) {
            const tipoErroSelecionado = form.querySelector('#botoes-tipo-erro button.active')?.dataset.tipo;
            if (!tipoErroSelecionado) {
                showNotificationModal('Atenção', 'Selecione o tipo do erro.', 'error');
                return;
            }
    
            const data = {
                questao_id: form.querySelector('#notificar-erro-questao-id').value,
                tipo_erro: tipoErroSelecionado,
                descricao: form.querySelector('textarea[name="descricao"]').value
            };
    
            fetch("{% url 'pratica:notificar_erro' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(result => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalNotificarErro'));
                modal.hide();
                if (result.status === 'success') {
                    showNotificationModal('Notificação Enviada!', result.message, 'success');
                    form.reset();
                    form.querySelectorAll('#botoes-tipo-erro button').forEach(b => b.classList.remove('active', 'btn-dark'));
                } else {
                    showNotificationModal('Erro no Envio', result.message, 'error');
                }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível enviar a notificação.', 'error'));
        }
    
        // Listener para o modal de notificação de erro (setup inicial)
        const modalNotificarErroEl = document.getElementById('modalNotificarErro');
        if (modalNotificarErroEl) {
            modalNotificarErroEl.addEventListener('show.bs.modal', function (event) {
                document.getElementById('notificar-erro-questao-id').value = event.relatedTarget.dataset.questaoId;
            });
            modalNotificarErroEl.querySelectorAll('#botoes-tipo-erro button').forEach(btn => {
                btn.addEventListener('click', function() {
                    modalNotificarErroEl.querySelectorAll('#botoes-tipo-erro button').forEach(b => b.classList.remove('active', 'btn-dark'));
                    this.classList.add('active', 'btn-dark');
                });
            });
        }
    });
    </script>
{% endblock %}