<!-- pratica/templates/pratica/listar_questoes.html -->
{% extends 'base.html' %}
{% load static %}
{% load questoes_extras %} 
{% load pratica_extras %} 

{% block title %}Praticar Questões{% endblock %}

{% block head %}
<!-- Google Fonts: Inter -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="{% static 'css/listagem-comum.css' %}">
<style>
    /* ========================================================================= */
    /* ESTILOS GLOBAIS
    /* ========================================================================= */

    .new-comment-form-container .avatar-icon {
        display: none;
    }
    body {
        background-color: #f4f7fa; 
        font-family: 'Inter', sans-serif;
    }

    .enunciado-imagem {
        max-width: 100%;
        max-height: 450px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        border-radius: var(--raio-borda);
        box-shadow: var(--sombra-caixa);
    }

    /* ========================================================================= */
    /* CARD DE FILTROS
    /* ========================================================================= */
    .filtros-card {
        background-color: var(--cor-fundo-claro);
        border: none;
        border-radius: var(--raio-borda);
        box-shadow: var(--sombra-caixa);
    }
    
    .btn-status-filter {
        border-radius: 20px !important;
        font-weight: 500;
        padding: 0.5rem 1.25rem;
        margin: 0.25rem;
        border: 1px solid var(--cor-borda);
        color: var(--cor-secundaria);
        transition: var(--transicao-padrao);
    }

    .btn-status-filter:hover {
        background-color: #e9ecef;
        border-color: #ced4da;
    }

    .btn-status-filter.active {
        background-color: var(--cor-primaria);
        color: var(--cor-texto-claro);
        border-color: var(--cor-primaria);
        box-shadow: 0 2px 4px rgba(74, 144, 226, 0.4);
    }
    
    /* ========================================================================= */
    /* CARD DA QUESTÃO
    /* ========================================================================= */
    .card-questao {
        background-color: var(--cor-fundo-claro);
        border: 1px solid var(--cor-borda);
        border-radius: var(--raio-borda);
        box-shadow: var(--sombra-caixa);
        margin-bottom: 2.5rem;
        overflow: hidden;
    }

    .card-questao:hover {
        box-shadow: var(--sombra-caixa);
        transform: none;
    }

    .card-questao .card-header {
        background-color: transparent;
        border-bottom: 1px solid var(--cor-borda);
        padding: 1rem 1.5rem;
        font-weight: 500;
        color: var(--cor-secundaria);
    }

    .card-questao .card-header strong {
        color: var(--cor-texto-escuro);
    }

    .card-questao .card-header .q-code {
        background-color: #e9ecef;
        color: var(--cor-secundaria);
        padding: 0.2rem 0.6rem;
        border-radius: 5px;
        font-size: 0.8em;
        font-weight: 600;
    }

    .card-questao .fa-star {
        font-size: 1.25rem; 
        cursor: pointer; 
        color: #ced4da;
    }

    .card-questao .fa-star.fas {
        color: var(--cor-aviso) !important;
    }

    .card-body {
        padding: 2rem;
    }

    .enunciado-formatado, .explicacao-conteudo {
        font-size: 1.1rem;
        line-height: 1.7;
        color: var(--cor-texto-escuro);
    }

    .enunciado-formatado p:last-child {
        margin-bottom: 0;
    }

    .card-footer {
        background-color: #f8f9fa;
        border-top: 1px solid var(--cor-borda);
    }

    /* ========================================================================= */
    /* ALTERNATIVAS DA QUESTÃO
    /* ========================================================================= */
    .alternativas {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .alternativa-item .form-check-input {
        display: none;
    }

    .alternativa-item .form-check-label {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border: 1px solid var(--cor-borda);
        border-radius: var(--raio-borda);
        cursor: pointer;
        transition: var(--transicao-padrao);
        width: 100%;
    }

    .alternativa-item .form-check-label:hover {
        border-color: var(--cor-primaria);
        background-color: #f8f9fa;
    }

    .alternativa-letra {
        width: 32px;
        height: 32px;
        min-width: 32px;
        border-radius: 50%;
        border: 1px solid var(--cor-borda);
        display: grid;
        place-items: center;
        font-weight: 600;
        margin-right: 1rem;
        transition: var(--transicao-padrao);
    }

    .alternativa-texto {
        line-height: 1.6;
    }

    .alternativa-item .form-check-input:checked + .form-check-label {
        border-color: var(--cor-primaria);
        background-color: #eef5ff;
    }

    .alternativa-item .form-check-input:checked + .form-check-label .alternativa-letra {
        background-color: var(--cor-primaria);
        border-color: var(--cor-primaria);
        color: var(--cor-texto-claro);
    }

    .alternativas.respondido .form-check-label {
        cursor: default;
        background-color: transparent !important;
    }

     .alternativas.respondido .form-check-label:hover {
        border-color: var(--cor-borda);
     }

    .alternativas.respondido .label-correta {
        border-color: var(--cor-sucesso) !important;
    }

    .alternativas.respondido .label-correta .alternativa-letra {
        background-color: var(--cor-sucesso) !important;
        border-color: var(--cor-sucesso) !important;
        color: var(--cor-texto-claro) !important;
    }

    .alternativas.respondido .label-errada {
        border-color: var(--cor-erro) !important;
    }

     .alternativas.respondido .label-errada .alternativa-letra {
        background-color: var(--cor-erro) !important;
        border-color: var(--cor-erro) !important;
        color: var(--cor-texto-claro) !important;
    }

    .explicacao {
        background-color: #f8f9fa;
        border-radius: var(--raio-borda);
        border-left: 4px solid var(--cor-primaria);
    }

    /* ========================================================================= */
    /* SEÇÃO DE COMENTÁRIOS (Reorganizado e Otimizado)
    /* ========================================================================= */

        /* ✅ INÍCIO DA CORREÇÃO DEFINITIVA: Layout do Formulário de Resposta
    /* ======================================================================= */

    /* 1. Transforma o contêiner do formulário de resposta em um flex container */
    .new-comment-form-container {
        display: flex;
        align-items: flex-start; /* Alinha o topo do avatar com o topo do formulário */
        gap: 15px; /* Espaço entre o avatar e o formulário */
    }

    /* 2. Anula o posicionamento absoluto APENAS para o avatar dentro do formulário de resposta */
    .new-comment-form-container .comment-avatar {
        position: relative; /* Remove o 'position: absolute' herdado */
        left: auto;
        top: auto;
        width: 40px; /* Define um tamanho fixo e menor para o avatar de resposta */
        height: 40px;
    }

    /* 3. Garante que o avatar padrão (bolinha azul) se ajuste ao novo tamanho */
    .new-comment-form-container .comment-default-avatar {
        width: 100%;
        height: 100%;
        font-size: 1.2rem;
    }

    /* --- Estrutura Geral --- */
    .comentarios-section {
        background-color: #f8f9fa;
        border-radius: 0 0 var(--raio-borda) var(--raio-borda);
    }

    .comment-wrapper {
        position: relative;
        padding-left: 115px; /* Espaço para avatar grande (100px) + margem (15px) */
        margin-bottom: 1.25rem; /* Espaço ENTRE os comentários */
    }

    /* --- Avatar do Comentário --- */
    .comment-avatar {
        position: absolute;
        left: 0;
        top: 0;
        width: 100px; /* Tamanho do container com borda */
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .comment-avatar.with-frame .comment-avatar-image {
        width: 65%; /* Avatar ocupa 65% do espaço da moldura */
        height: 65%;
        border-radius: 8px;
        border: none;
    }

    .comment-avatar-image {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        position: relative;
        z-index: 1;
    }

    .comment-avatar-image.with-default-border {
        border: 2px solid #dee2e6;
    }

    .comment-border-image {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        pointer-events: none;
        z-index: 2;
    }
    
    .comment-default-avatar {
        width: 50px;
        height: 50px;
        background-image: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-weight: bold;
        font-size: 1.4rem;
    }

    /* --- Card do Comentário --- */
    .comment-card {
        background-color: var(--cor-fundo-claro);
        border: 1px solid var(--cor-borda);
        border-radius: var(--raio-borda);
        position: relative;
        box-shadow: none;
        padding: 0.75rem 1.25rem; /* MODIFICADO: Padding interno reduzido */
    }

    .comment-user {
        font-weight: 600;
        color: var(--cor-texto-escuro);
    }

    .comment-date {
        font-size: 0.8rem;
        color: var(--cor-secundaria);
    }

    .comment-body {
        font-size: 1.1rem;
        line-height: 1.7;
        color: var(--cor-texto-escuro);
        margin-top: 0.5rem; /* MODIFICADO: Controla o espaço abaixo do nome */
    }

    .comment-footer {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 0.75rem; /* MODIFICADO: Espaço acima dos botões reduzido */
    }

    .comment-footer a {
        text-decoration: none;
        color: var(--cor-secundaria);
        font-weight: 500;
        font-size: 0.85rem;
    }

    .comment-footer a:hover {
        color: var(--cor-primaria);
    }

    .btn-like.liked {
        color: var(--cor-primaria);
        font-weight: bold;
    }

    /* --- Respostas --- */
    .comment-replies {
        border-left: 2px solid var(--cor-borda);
        padding-left: 1.25rem;
        margin-top: 1rem;
        margin-left: 40px; 
    }

    /* ========================================================================= */
    /* EDITOR DE TEXTO TIPTAP
    /* ========================================================================= */
    .tiptap-toolbar {
        border: 1px solid var(--cor-borda);
        border-bottom: none;
        padding: .5rem;
        border-top-left-radius: var(--raio-borda);
        border-top-right-radius: var(--raio-borda);
        background-color: #f8f9fa;
    }

    .tiptap-toolbar button {
        border: none;
        background-color: transparent;
        border-radius: 4px;
        transition: var(--transicao-padrao);
    }

    .tiptap-toolbar button:hover {
        background-color: var(--cor-texto-escuro);
        color: var(--cor-texto-claro);
    }

    .tiptap-toolbar button.active {
        background-color: var(--cor-primaria);
        color: var(--cor-texto-claro);
    }
    
    .tiptap {
        border: 1px solid var(--cor-borda);
        border-radius: var(--raio-borda);
        padding: .75rem 1rem;
        min-height: 150px;
        background-color: var(--cor-fundo-claro);
    }

    .tiptap:focus-within {
        border-color: var(--cor-primaria);
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(74, 144, 226, .25);
    }
    
    .tiptap p.is-editor-empty:first-child::before {
      content: attr(data-placeholder);
      float: left;
      color: #adb5bd;
      pointer-events: none;
      height: 0;
    }
    
    .comment-edit-form .tiptap {
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }

    /* ========================================================================= */
    /* AJUSTES PARA MOBILE (ATÉ 768px)
    /* ========================================================================= */
    @media (max-width: 768px) {
        /* ======================================================================= */
        /* INÍCIO DA CORREÇÃO: Removendo o padding negativo do container */
        /* ======================================================================= */
        .container {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        /* ======================================================================= */
        /* FIM DA CORREÇÃO */
        /* ======================================================================= */
        
        .card-body, .card-header, .card-footer, .comentarios-section { 
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .filtros-card, .card-questao {
            width: 100%;
            border-radius: 0;
            margin-bottom: 0.5rem;
            box-shadow: none;
            border-left: none;
            border-right: none;
            border-top: 1px solid var(--cor-borda);
        }

        .comment-wrapper {
            padding-left: 55px; 
        }
        
        /* Ajuste do tamanho do avatar para mobile */
        .comment-avatar {
            width: 40px;
            height: 40px;
        }
        .comment-avatar.with-frame {
            width: 48px;
            height: 48px;
        }
        .comment-default-avatar {
            width: 40px;
            height: 40px;
            font-size: 1rem;
        }

        .comment-replies {
            margin-left: 1.25rem; 
            padding-left: 0.75rem;
        }
    }
</style>
{% endblock %}


{% block content %}
<!-- ======================================================================= -->
<!-- INÍCIO DA CORREÇÃO: Removida a classe 'container' e adicionada uma div wrapper -->
<!-- ======================================================================= -->
<div class="container-fluid container-lg mt-5">
<!-- ======================================================================= -->
<!-- FIM DA CORREÇÃO -->
<!-- ======================================================================= -->

    <!-- CABEÇALHO E FILTROS -->
    <div class="filtros-card p-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0 h4">Filtrar Questões</h2>
            <div>
                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#filtrosSalvosModal">
                    <i class="fas fa-filter me-2"></i>Meus Filtros
                </button>
            </div>
        </div>
        <div class="mb-4 text-center">
            <div class="btn-group flex-wrap" role="group" aria-label="Filtros de status">
                <a href="?{% url_replace status='' %}" class="btn btn-status-filter {% if not request.GET.status %}active{% endif %}">TODAS</a>
                <a href="?{% url_replace status='respondidas' %}" class="btn btn-status-filter {% if request.GET.status == 'respondidas' %}active{% endif %}">RESOLVIDAS</a>
                <a href="?{% url_replace status='nao_respondidas' %}" class="btn btn-status-filter {% if request.GET.status == 'nao_respondidas' %}active{% endif %}">NÃO RESOLVIDAS</a>
                <a href="?{% url_replace status='acertei' %}" class="btn btn-status-filter {% if request.GET.status == 'acertei' %}active{% endif %}">ACERTEI</a>
                <a href="?{% url_replace status='errei' %}" class="btn btn-status-filter {% if request.GET.status == 'errei' %}active{% endif %}">ERREI</a>
                <a href="?{% url_replace status='favoritas' %}" class="btn btn-status-filter {% if request.GET.status == 'favoritas' %}active{% endif %}">FAVORITAS</a>
            </div>
        </div>
        {% include 'includes/_filtros_questoes.html' with form_action_url=request.path status_param=status_param %}
        <div class="text-center mt-3">
            <button type="button" class="btn btn-link text-secondary" data-bs-toggle="modal" data-bs-target="#salvarFiltroModal">
                <i class="fas fa-save me-2"></i>Salvar Filtros Atuais
            </button>
        </div>
    </div>

    <!-- CONTROLES DE ORDENAÇÃO E PAGINAÇÃO -->
    {% include 'gestao/includes/_ordenacao_e_paginacao_controls.html' with paginated_object=questoes sort_options=sort_options sort_by=sort_by per_page=per_page %}
   
    <!-- LISTAGEM DE QUESTÕES -->
    {% for questao in questoes %}
    <div class="card card-questao mb-4" id="questao-{{ questao.id }}">
        
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <strong class="me-2">{{ forloop.counter0|add:questoes.start_index }}.</strong>
                <span class="q-code">{{ questao.codigo }}</span>
                <span class="ms-2">
                    <strong>{{ questao.disciplina.nome }}</strong> › {{ questao.assunto.nome }}
                    {% if questao.banca and questao.ano %}
                        <span class="text-muted ms-2"> ({{ questao.banca.nome }} - {{ questao.ano }})</span>
                    {% endif %}
                </span>
            </div>
            <i class="fa-star {% if questao.id in favoritas_ids %}fas{% else %}far{% endif %}"
               title="Marcar como favorita"
               data-questao-id="{{ questao.id }}"></i>
        </div>

        <div class="card-body">
            {% if questao.imagem_enunciado %}
                <img src="{{ questao.imagem_enunciado.url }}" class="enunciado-imagem mb-4" alt="Imagem da questão">
            {% endif %}

            <div class="enunciado-formatado">
                {{ questao.enunciado|render_markdown|safe }}
            </div>
            
            <div class="alternativas mt-4" data-questao-id="{{ questao.id }}">
                {% for key, value in questao.get_alternativas_dict.items %}
                <div class="alternativa-item">
                    <input class="form-check-input" type="radio" name="alternativa-{{ questao.id }}" id="q{{ questao.id }}-{{ key }}" value="{{ key }}">
                    <label class="form-check-label" for="q{{ questao.id }}-{{ key }}">
                        <span class="alternativa-letra">{{ key }}</span>
                        <span class="alternativa-texto">{{ value }}</span>
                    </label>
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-4">
                <button type="button" class="btn btn-primary w-100 p-2 btn-responder" data-questao-id="{{ questao.id }}">
                    <i class="fas fa-check-circle me-2"></i>Responder
                </button>
            </div>

            <div class="feedback mt-4" style="display: none;">
                <div class="alert"></div>
                <div class="explicacao p-3 mt-3" style="display: none;">
                    <h5 class="h6">Explicação da Alternativa Correta:</h5>
                    <div class="explicacao-conteudo"></div>
                </div>
            </div>
        </div>

        <div class="card-footer d-flex justify-content-center gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm btn-toggle-explicacao d-none" data-questao-id="{{ questao.id }}">
                <i class="fas fa-graduation-cap me-1"></i> Gabarito Comentado
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm btn-toggle-comentarios" data-questao-id="{{ questao.id }}">
                <i class="far fa-comment me-1"></i> Comentários
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalNotificarErro" data-questao-id="{{ questao.id }}">
                <i class="fas fa-flag me-1"></i> Notificar Erro
            </button>
        </div>

        <!-- Seção de Comentários (Oculta) -->
        <div class="comentarios-section p-3" id="comentarios-section-{{ questao.id }}" style="display: none;">
            {% include 'pratica/includes/_secao_comentarios.html' with questao=questao %}
        </div>
    </div>
    {% empty %}
    <div class="card card-body text-center py-5">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h4 class="h5">Nenhuma questão encontrada</h4>
        <p class="text-muted">Tente ajustar seus filtros ou buscar por outros termos.</p>
    </div>
    {% endfor %}

    <!-- COMPONENTE DE PAGINAÇÃO -->
    {% include 'includes/_paginacao.html' with paginated_object=questoes %} 

</div>

<!-- INCLUSÃO DOS MODAIS REUTILIZÁVEIS -->
{% include 'pratica/includes/_modais_pratica.html' %}

<!-- a. TOAST GENÉRICO PARA NOTIFICAÇÕES DE GAMIFICAÇÃO -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="gamificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="gamificationToastTitle"></strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="gamificationToastBody"></div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
<!-- Importação dos Módulos do Tiptap -->
<script type="module">
    import { Editor } from 'https://esm.sh/@tiptap/core';
    import StarterKit from 'https://esm.sh/@tiptap/starter-kit';
    import { Markdown } from 'https://esm.sh/tiptap-markdown';
    import Underline from 'https://esm.sh/@tiptap/extension-underline';
    import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder';
   
    // Disponibiliza globalmente para o script inline
    window.TipTap = { Editor, StarterKit, Markdown, Underline, Placeholder };
</script>

<!-- SCRIPT DE FILTROS -->
<script src="{% static 'js/filtros-questoes.js' %}"></script>

<!-- LÓGICA JS ESPECÍFICA DA PÁGINA -->
<script>

/**
     * Função genérica para exibir toasts de gamificação.
     * @param {string} title - O título do toast.
     * @param {string} bodyContent - O conteúdo HTML do corpo do toast.
     * @param {string} icon - Classes do ícone Font Awesome (ex: 'fas fa-star').
     * @param {string} color - A cor do ícone.
     */
     function showGamificationToast(title, bodyContent, icon, color = '#0d6efd') {
        const toastEl = document.getElementById('gamificationToast');
        if (!toastEl) return;

        const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
        const toastTitle = document.getElementById('gamificationToastTitle');
        const toastBody = document.getElementById('gamificationToastBody');
        
        toastTitle.innerHTML = `<i class="${icon} me-2" style="color: ${color};"></i> ${title}`;
        toastBody.innerHTML = bodyContent;
        
        toast.show();
    }


    document.addEventListener('DOMContentLoaded', function() {
        // =======================================================================
        // INICIALIZAÇÃO E VARIÁVEIS
        // =======================================================================
        const tiptapEditors = {}; // Armazena instâncias dos editores Tiptap
        let editTiptapEditor = null; // Editor único para edição de comentários
    
        // Inicializa o editor de edição de comentários assim que o Tiptap estiver disponível
        if (window.TipTap) {
            const { Editor, StarterKit, Markdown, Underline, Placeholder } = window.TipTap;
            editTiptapEditor = new Editor({
                extensions: [ StarterKit, Markdown.configure({ html: false }), Underline, Placeholder.configure({ placeholder: 'Edite sua resposta...' }) ],
                content: '',
            });
        } else {
            console.error("Tiptap não foi carregado a tempo para criar o editor de edição.");
        }
    
        // =======================================================================
        // FUNÇÕES DE MANIPULAÇÃO DO TIPTAP
        // =======================================================================
        function initializeTiptapEditor({ editorElement, toolbarElement, hiddenTextarea }) {
            if (editorElement.tiptapEditor) return editorElement.tiptapEditor;
    
            const { Editor, StarterKit, Markdown, Underline, Placeholder } = window.TipTap;
            if (!Editor) {
                console.error("Tiptap não carregou corretamente.");
                return;
            }
    
            const editor = new Editor({
                element: editorElement,
                extensions: [
                    StarterKit, Markdown.configure({ html: false, linkify: true, breaks: true }), Underline,
                    Placeholder.configure({ placeholder: 'Escreva o seu comentário...' }),
                ],
                content: '',
                onUpdate: ({ editor }) => {
                    hiddenTextarea.value = editor.storage.markdown.getMarkdown();
                },
            });
    
            toolbarElement.querySelectorAll('button[data-command]').forEach(button => {
                button.addEventListener('click', () => {
                    const command = button.dataset.command;
                    const commands = {
                        toggleBold: () => editor.chain().focus().toggleBold().run(),
                        toggleItalic: () => editor.chain().focus().toggleItalic().run(),
                        toggleUnderline: () => editor.chain().focus().toggleUnderline().run(),
                        toggleBulletList: () => editor.chain().focus().toggleBulletList().run(),
                        toggleOrderedList: () => editor.chain().focus().toggleOrderedList().run(),
                    };
                    if (commands[command]) commands[command]();
                });
            });
    
            editorElement.tiptapEditor = editor;
            return editor;
        }
    
        // =======================================================================
        // DELEGAÇÃO DE EVENTOS CENTRALIZADA
        // =======================================================================
        document.body.addEventListener('click', function(e) {
            const target = e.target;
            const link = target.closest('a');
            const button = target.closest('button');
            const icon = target.closest('.fa-star');
    
            // Ações em links (<a>)
            if (link) {
                if (link.classList.contains('btn-like')) { e.preventDefault(); handleLikeComentario(link); }
                else if (link.classList.contains('toggle-replies-btn')) { e.preventDefault(); handleToggleReplies(link); }
                else if (link.classList.contains('sort-comments-btn')) { e.preventDefault(); handleSortClick(link); }
            }
            // Ações em botões (<button>)
            else if (button) {
                if (button.id === 'btn-confirmar-salvar-filtro') { handleSalvarFiltro(); }
                else if (button.classList.contains('btn-responder')) { handleResponder(button); }
                else if (button.classList.contains('btn-deletar-filtro')) {
                    const filtroId = button.dataset.filtroId;
                    const nomeFiltro = button.closest('.list-group-item').querySelector('a').textContent;
                    showConfirmationModal(`Deseja realmente excluir o filtro "${nomeFiltro}"?`, () => handleDeletarFiltro(filtroId));
                }
                else if (button.classList.contains('btn-responder')) { handleResponder(button); }
                else if (button.classList.contains('btn-toggle-comentarios')) { handleToggleComentarios(button); }
                else if (button.classList.contains('btn-toggle-explicacao')) { handleToggleExplicacao(button); }
                else if (button.classList.contains('btn-excluir-comentario')) {
                    const comentarioId = button.dataset.comentarioId;
                    showConfirmationModal('Deseja realmente excluir o seu comentário?', () => handleExcluirComentario(comentarioId));
                }
                else if (button.classList.contains('btn-editar-comentario')) { handleAbrirEdicao(button); }
                else if (button.classList.contains('btn-salvar-edicao')) { handleSalvarEdicao(button); }
                else if (button.classList.contains('btn-cancelar-edicao')) { cancelarEdicao(button.closest('.comment-edit-form')); }
            }
            // Ações em ícones (<i>)
            else if (icon) {
                handleFavoritar(icon);
            }
        });
    
        document.body.addEventListener('submit', function(e) {
            if (e.target.classList.contains('form-comentario')) {
                e.preventDefault();
                handleAdicionarComentario(e.target);
            }
            if (e.target.id === 'form-notificar-erro') {
                e.preventDefault();
                handleNotificarErro(e.target);
            }
        });
    
        // =======================================================================
        // HANDLERS DE AÇÕES (lógica principal da página)
        // =======================================================================
    
        function handleSalvarFiltro() {
            const inputNome = document.getElementById('input-nome-filtro');
            if (!inputNome.value.trim()) { inputNome.classList.add('is-invalid'); return; }
            inputNome.classList.remove('is-invalid');
            const params = new URLSearchParams(new FormData(document.getElementById('form-filtros'))).toString();
            
            fetch("{% url 'pratica:salvar_filtro' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ nome: inputNome.value, parametros: params })
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('salvarFiltroModal')).hide();
                    const lista = document.getElementById('lista-modal-filtros-salvos');
                    document.getElementById('sem-filtros-salvos-msg')?.remove();
                    lista.insertAdjacentHTML('beforeend', `
                        <li class="list-group-item d-flex justify-content-between align-items-center" id="filtro-salvo-item-${result.filtro.id}">
                            <a href="?${result.filtro.parametros}" class="text-decoration-none text-dark flex-grow-1">${result.filtro.nome}</a>
                            <button type="button" class="btn btn-sm btn-danger btn-deletar-filtro" data-filtro-id="${result.filtro.id}">&times;</button>
                        </li>`);
                    showNotificationModal('Sucesso!', 'Filtro salvo com sucesso.', 'success');
                } else { showNotificationModal('Erro ao Salvar', result.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível salvar. Tente novamente.', 'error'));
        }
    
        function handleDeletarFiltro(filtroId) {
            fetch("{% url 'pratica:deletar_filtro' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ filtro_id: filtroId })
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    document.getElementById(`filtro-salvo-item-${filtroId}`).remove();
                } else { showNotificationModal('Erro ao Deletar', result.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível deletar. Tente novamente.', 'error'));
        }
    
        function handleResponder(button) {
        const questaoId = button.dataset.questaoId;
        const questaoCard = document.getElementById(`questao-${questaoId}`);
        const alternativaSelecionada = questaoCard.querySelector(`input[name="alternativa-${questaoId}"]:checked`);
        
        if (!alternativaSelecionada) { 
            window.showNotificationModal('Atenção', 'Por favor, selecione uma alternativa.', 'info'); 
            return; 
        }
        
        fetch("{% url 'pratica:verificar_resposta' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ questao_id: questaoId, alternativa: alternativaSelecionada.value })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.status === 'success') {
                const feedbackDiv = questaoCard.querySelector('.feedback');
                const alertDiv = feedbackDiv.querySelector('.alert');
                const alternativasDiv = questaoCard.querySelector('.alternativas');
                
                alternativasDiv.classList.add('respondido');
                questaoCard.querySelectorAll('.form-check-input').forEach(input => input.disabled = true);
                button.style.display = 'none';

                alertDiv.className = result.correta ? 'alert alert-success' : 'alert alert-danger';
                alertDiv.textContent = result.correta ? `Correto! O gabarito é ${result.gabarito}.` : `Incorreto. A resposta correta era ${result.gabarito}.`;
                
                questaoCard.querySelectorAll('.alternativa-item').forEach(item => {
                    const input = item.querySelector('input');
                    const label = item.querySelector('label');
                    if (input.value === result.gabarito) {
                        label.classList.add('label-correta');
                    } else if (input.checked && !result.correta) {
                        label.classList.add('label-errada');
                    }
                });

                if (result.explicacao) {
                    feedbackDiv.querySelector('.explicacao-conteudo').innerHTML = result.explicacao;
                    questaoCard.querySelector('.btn-toggle-explicacao').classList.remove('d-none');
                }
                feedbackDiv.style.display = 'block';

                let delay = 100;

                // INÍCIO DA MODIFICAÇÃO: Lógica de Feedback de Bloqueio
                if (result.motivo_bloqueio) {
                    let title = "Ação Rápida!";
                    let message = "Você respondeu muito rápido! Para garantir um aprendizado eficaz e justo, o ganho de XP foi desabilitado para esta resposta.";
                    let icon = 'fas fa-stopwatch';
                    let color = '#fd7e14';

                    if (result.motivo_bloqueio === 'COOLDOWN_QUESTAO') {
                        title = "Revisão Recente";
                        message = "Você já respondeu esta questão recentemente. O ganho de XP está em cooldown para incentivar a prática de novas questões.";
                        icon = 'fas fa-history';
                        color = '#6c757d';
                    } else if (result.motivo_bloqueio === 'TETO_XP_DIARIO') {
                        title = "Teto de XP Atingido!";
                        message = "Parabéns, você atingiu o limite máximo de XP que pode ser ganho hoje! Volte amanhã para continuar acumulando.";
                        icon = 'fas fa-battery-full';
                        color = '#0dcaf0';
                    }
                    showGamificationToast(title, message, icon, color);
                } else {
                    // Exibe toasts de recompensas normais apenas se não houver bloqueio
                    if (result.xp_ganho > 0) {
                        let xpMessage = `pela sua resposta.`;
                        if (result.bonus_ativo) {
                            xpMessage = `pelo seu <strong>combo de acertos!</strong>`;
                        }
                        showGamificationToast(`+${result.xp_ganho} XP`, xpMessage, 'fas fa-star', '#ffc107');
                        delay += 2000;
                    }
                    if (result.moedas_ganhas > 0) {
                        const saldoAtual = parseInt(document.getElementById('navbar-coin-balance').textContent, 10);
                        updateNavbarCoinBalance(saldoAtual + result.moedas_ganhas);
                        setTimeout(() => showCoinToast(result.moedas_ganhas, 'pela sua resposta'), delay);
                        delay += 2000;
                    }
                }
                // FIM DA MODIFICAÇÃO

                if (result.meta_completa_info) {
                    const meta = result.meta_completa_info;
                    const saldoAtualMoedas = parseInt(document.getElementById('navbar-coin-balance').textContent, 10);
                    updateNavbarCoinBalance(saldoAtualMoedas + meta.moedas_bonus);
                    const metaBody = `Você completou sua meta e ganhou <strong>+${meta.xp_bonus} XP</strong> e <strong>+${meta.moedas_bonus} FC</strong> de bônus!`;
                    setTimeout(() => showGamificationToast('Meta Diária Cumprida!', metaBody, 'fas fa-calendar-check', '#28a745'), delay);
                    delay += 2500;
                }

                if (result.level_up_info) {
                    const levelUpBody = `Parabéns! Você alcançou o <strong>Nível ${result.level_up_info.novo_level}</strong>! Novos prêmios podem estar esperando na sua Caixa de Recompensas.`;
                    setTimeout(() => showGamificationToast('Subiu de Nível!', levelUpBody, 'fas fa-star', '#f7b733'), delay);
                    delay += 2500;
                }
                
                if (result.nova_conquista) {
                    const conquista = result.nova_conquista;
                    const conquistaBody = `Você desbloqueou: <strong>${conquista.nome}</strong>`;
                    setTimeout(() => showGamificationToast('Conquista Desbloqueada!', conquistaBody, conquista.icone, conquista.cor), delay);
                }
                
            } else {
                window.showNotificationModal('Erro ao Responder', result.message, 'error');
            }
        }).catch(err => {
            console.error('Erro no fetch da resposta:', err);
            window.showNotificationModal('Erro de Rede', 'Não foi possível verificar a resposta. Verifique sua conexão e tente novamente.', 'error')
        });
    }
        
        function handleToggleExplicacao(button) {
            const questaoId = button.dataset.questaoId;
            const explicacaoDiv = document.getElementById(`questao-${questaoId}`).querySelector('.explicacao');
            if (explicacaoDiv) {
                const isHidden = explicacaoDiv.style.display === 'none' || !explicacaoDiv.style.display;
                explicacaoDiv.style.display = isHidden ? 'block' : 'none';
            }
        }
    
        function handleFavoritar(icon) {
            fetch("{% url 'pratica:favoritar_questao' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ questao_id: icon.dataset.questaoId })
            })
            .then(response => response.ok ? response.json() : Promise.reject('Erro na resposta do servidor'))
            .then(result => {
                if (result.status === 'success') {
                    icon.classList.toggle('far');
                    icon.classList.toggle('fas');
                } else { showNotificationModal('Erro', result.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível favoritar.', 'error'));
        }
    
        function handleToggleComentarios(button) {
            const questaoId = button.dataset.questaoId;
            const comentariosSection = document.getElementById(`comentarios-section-${questaoId}`);
            const isHidden = comentariosSection.style.display === 'none';
            comentariosSection.style.display = isHidden ? 'block' : 'none';
    
            if (isHidden) {
                if (!tiptapEditors[questaoId]) {
                    const form = comentariosSection.querySelector('.form-comentario');
                    if (form) {
                        tiptapEditors[questaoId] = initializeTiptapEditor({
                            editorElement: form.querySelector('.tiptap-editor'),
                            toolbarElement: form.querySelector('.tiptap-toolbar'),
                            hiddenTextarea: form.querySelector('textarea[name="conteudo"]'),
                        });
                    }
                }
                if (comentariosSection.dataset.carregado !== 'true') {
                    carregarComentarios(questaoId);
                }
            }
        }
    
        function handleAdicionarComentario(form) {
            const questaoId = form.dataset.questaoId;
            const parentId = form.dataset.parentId;
            const conteudo = form.querySelector('textarea[name="conteudo"]').value;
            if (!conteudo.trim()) { showNotificationModal('Atenção', 'O comentário não pode estar vazio.', 'info'); return; }
    
            fetch("{% url 'pratica:adicionar_comentario' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ questao_id: questaoId, conteudo: conteudo, parent_id: parentId })
            })
            .then(r => r.json())
            .then(result => {
                if (result.status === 'success') {
                    carregarComentarios(questaoId);
                    if (!parentId && tiptapEditors[questaoId]) {
                        tiptapEditors[questaoId].commands.clearContent();
                    } else {
                        const formContainer = form.closest('.reply-form-container');
                        if (formContainer) formContainer.innerHTML = '';
                    }
                } else { showNotificationModal('Erro ao Comentar', result.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível enviar o comentário.', 'error'));
        }
    
        function handleExcluirComentario(comentarioId) {
            const questaoId = document.getElementById(`comment-wrapper-${comentarioId}`).closest('.card-questao').id.replace('questao-', '');
            fetch("{% url 'pratica:excluir_comentario' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ comentario_id: comentarioId })
            })
            .then(r => r.json())
            .then(res => {
                if (res.status === 'success') {
                    carregarComentarios(questaoId);
                } else { showNotificationModal('Erro ao Excluir', res.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível excluir.', 'error'));
        }
        
        function handleLikeComentario(link) {
            fetch("{% url 'pratica:toggle_like_comentario' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ comentario_id: link.dataset.comentarioId })
            })
            .then(r => r.ok ? r.json() : Promise.reject('Erro de servidor'))
            .then(result => {
                if (result.status === 'success') {
                    link.querySelector('.like-count').textContent = result.likes_count;
                    link.classList.toggle('liked', result.liked);
                } else { showNotificationModal('Erro', result.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível registrar o like.', 'error'));
        }
    
        function handleToggleReplies(link) {
        const comentarioId = link.dataset.comentarioId;
        const questaoId = link.closest('.card-questao').id.replace('questao-', '');
        const wrapper = document.getElementById(`comment-wrapper-${comentarioId}`);
        const repliesWrapper = wrapper.querySelector('.replies-wrapper');

        const isHidden = repliesWrapper.style.display === 'none' || !repliesWrapper.style.display;
        repliesWrapper.style.display = isHidden ? 'block' : 'none';

        if (isHidden) {
            const formContainer = repliesWrapper.querySelector('.reply-form-container');
            if (!formContainer.querySelector('form')) {

                // =======================================================================
                // CORREÇÃO: Lógica para exibir o avatar do USUÁRIO LOGADO no form de resposta
                // =======================================================================
                let currentUserAvatarHtml = '';
                const avatarUrl = "{{ avatar_equipado_url|default:'' }}";
                const bordaUrl = "{{ borda_equipada_url|default:'' }}";
                const hasBorda = !!bordaUrl;
                const hasAvatar = !!avatarUrl;
                
                const containerClasses = `comment-avatar ${hasBorda ? 'with-frame' : ''}`;
                let innerAvatarHtml = '';

                if (hasBorda) {
                    innerAvatarHtml += `<img src="${bordaUrl}" class="comment-border-image" alt="Borda">`;
                }
                if (hasAvatar) {
                    const avatarClasses = `comment-avatar-image ${!hasBorda ? 'with-default-border' : ''}`;
                    innerAvatarHtml += `<img src="${avatarUrl}" class="${avatarClasses}" alt="Avatar">`;
                } else {
                    const userInitial = "{{ request.user.userprofile.nome.0|upper }}";
                    innerAvatarHtml += `<div class="comment-default-avatar">${userInitial}</div>`;
                }

                currentUserAvatarHtml = `<div class="${containerClasses}">${innerAvatarHtml}</div>`;
                // =======================================================================

                formContainer.innerHTML = `
                    <div class="new-comment-form-container mt-3">
                        ${currentUserAvatarHtml}
                        <form class="form-comentario form-reply flex-grow-1" data-questao-id="${questaoId}" data-parent-id="${comentarioId}">
                            <textarea name="conteudo" class="form-control form-control-sm" rows="3" placeholder="Escreva sua resposta..." required></textarea>
                            <div class="d-flex justify-content-end mt-2">
                                <button type="button" class="btn btn-sm btn-secondary me-2" onclick="this.closest('.reply-form-container').innerHTML = ''">Cancelar</button>
                                <button type="submit" class="btn btn-sm btn-primary">Enviar</button>
                            </div>
                        </form>
                    </div>`;
            }
        }
    }
    
        function handleSortClick(link) {
            const questaoId = link.dataset.questaoId;
            document.getElementById(`sort-label-${questaoId}`).textContent = link.textContent;
            carregarComentarios(questaoId, link.dataset.sort);
        }
    
        function handleAbrirEdicao(button) {
            const comentarioId = button.dataset.comentarioId;
            const commentCard = document.getElementById(`comentario-${comentarioId}`);
            const contentDiv = commentCard.querySelector('.comment-content');
            const editFormDiv = commentCard.querySelector('.comment-edit-form');
            
            document.querySelectorAll('.comment-edit-form:not([style*="display: none"])').forEach(cancelarEdicao);
    
            const rawContent = contentDiv.dataset.rawContent;
            editFormDiv.innerHTML = `
                <div class="tiptap-toolbar">
                    <button type="button" data-command="toggleBold" title="Negrito"><b>B</b></button>
                    <button type="button" data-command="toggleItalic" title="Itálico"><i>I</i></button>
                    <button type="button" data-command="toggleUnderline" title="Sublinhado"><u>U</u></button>
                </div>
                <div class="tiptap-editor" id="tiptap-editor-edit-${comentarioId}"></div>
                <div class="mt-2 d-flex justify-content-center">
                    <button type="button" class="btn btn-sm btn-secondary btn-cancelar-edicao me-2">Cancelar</button>
                    <button type="button" class="btn btn-sm btn-primary btn-salvar-edicao" data-comentario-id="${comentarioId}">Salvar</button>
                </div>`;
    
            editFormDiv.querySelector('.tiptap-editor').appendChild(editTiptapEditor.view.dom);
            editTiptapEditor.commands.setContent(rawContent, false);
            editTiptapEditor.commands.focus();
            
            contentDiv.style.display = 'none';
            editFormDiv.style.display = 'block';
        }
    
        function handleSalvarEdicao(button) {
            const comentarioId = button.dataset.comentarioId;
            const novoConteudo = editTiptapEditor.storage.markdown.getMarkdown();
    
            fetch("{% url 'pratica:editar_comentario' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ comentario_id: comentarioId, conteudo: novoConteudo })
            })
            .then(r => r.json())
            .then(result => {
                if(result.status === 'success') {
                    const contentDiv = document.getElementById(`comentario-${comentarioId}`).querySelector('.comment-content');
                    contentDiv.innerHTML = result.conteudo_html;
                    contentDiv.dataset.rawContent = novoConteudo;
                    cancelarEdicao(button.closest('.comment-edit-form'));
                } else { showNotificationModal('Erro ao Salvar', result.message, 'error'); }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível salvar a edição.', 'error'));
        }
    
        function cancelarEdicao(editFormDiv) {
            if (!editFormDiv) return;
            const contentDiv = editFormDiv.closest('.comment-card').querySelector('.comment-content');
            contentDiv.style.display = 'block';
            editFormDiv.style.display = 'none';
            editFormDiv.innerHTML = '';
        }
    
        function carregarComentarios(questaoId, sortBy = 'recent') {
            const comentariosList = document.getElementById(`comentarios-list-${questaoId}`);
            comentariosList.innerHTML = '<p class="text-center text-muted py-4">Carregando...</p>';
            
            fetch(`/pratica/carregar-comentarios/${questaoId}/?sort_by=${sortBy}`)
                .then(response => response.ok ? response.json() : Promise.reject('Erro ao carregar'))
                .then(data => {
                    comentariosList.innerHTML = '';
                    if (data.comentarios.length > 0) {
                        data.comentarios.forEach(c => {
                            comentariosList.appendChild(criarElementoComentario(c));
                        });
                    } else {
                        comentariosList.innerHTML = '<p class="text-center text-muted py-4">Nenhum comentário ainda.</p>';
                    }
                    document.getElementById(`comentarios-section-${questaoId}`).dataset.carregado = 'true';
                }).catch(err => {
                    comentariosList.innerHTML = '<p class="text-center text-danger py-4">Erro ao carregar comentários.</p>';
                });
        }
    
        function criarElementoComentario(c) {
        const template = document.createElement('template');
        
        let podeEditarHtml = '';
        if (c.pode_editar) {
            podeEditarHtml = `
                <li><button class="dropdown-item btn-editar-comentario" type="button" data-comentario-id="${c.id}"><i class="fas fa-edit me-2"></i>Editar</button></li>
                <li><button class="dropdown-item text-danger btn-excluir-comentario" type="button" data-comentario-id="${c.id}"><i class="fas fa-trash me-2"></i>Excluir</button></li>
                <li><hr class="dropdown-divider"></li>`;
        }

        const hasBorda = c.usuario_borda_url;
        const hasAvatar = c.usuario_avatar_url;

        const containerClasses = `comment-avatar ${hasBorda ? 'with-frame' : ''}`;
        
        let innerAvatarHtml = '';

        if (hasBorda) {
            innerAvatarHtml += `<img src="${c.usuario_borda_url}" class="comment-border-image" alt="Borda">`;
        }
        if (hasAvatar) {
            const avatarClasses = `comment-avatar-image ${!hasBorda ? 'with-default-border' : ''}`;
            innerAvatarHtml += `<img src="${c.usuario_avatar_url}" class="${avatarClasses}" alt="Avatar">`;
        } else {
            innerAvatarHtml += `<div class="comment-default-avatar">${c.usuario.charAt(0).toUpperCase()}</div>`;
        }
        
        // =======================================================================
        // INÍCIO DA CORREÇÃO: Envolvendo o avatar com a tag <a>
        // =======================================================================
        
        const profileUrl = `/auth/perfil/${c.usuario_username}/`;
        const avatarContainerHtml = `<a href="${profileUrl}" class="${containerClasses}">${innerAvatarHtml}</a>`;
        // =======================================================================
        // FIM DA CORREÇÃO
        // =======================================================================
        
        template.innerHTML = `
            <div class="comment-wrapper" id="comment-wrapper-${c.id}">
                ${avatarContainerHtml}
                <div class="comment-card" id="comentario-${c.id}">
                    <div class="comment-header d-flex justify-content-between">
                        <div><span class="comment-user">${c.usuario}</span><div class="comment-date">${c.data_criacao}</div></div>
                        <div class="comment-actions dropdown">
                            <button class="btn btn-sm btn-light py-0 px-2" type="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-ellipsis-h"></i></button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                ${podeEditarHtml}
                                <li>
                                    <button class="dropdown-item text-warning" type="button" 
                                            data-bs-toggle="modal" data-bs-target="#modalNotificarErro" 
                                            data-comentario-id="${c.id}">
                                        <i class="fas fa-flag me-2"></i>Denunciar
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="comment-content" data-raw-content="${c.conteudo_raw.replace(/"/g, '&quot;')}">
                        <div class="comment-body">${c.conteudo}</div>
                    </div>
                    <div class="comment-edit-form mt-2" style="display: none;"></div>
                    ${!c.parent_id ? `
                    <div class="comment-footer">
                        <a href="#" class="btn btn-like ${c.user_liked ? 'liked' : ''}" data-comentario-id="${c.id}">
                            <i class="fas fa-thumbs-up"></i> Gostei (<span class="like-count">${c.likes_count}</span>)
                        </a>
                        <a href="#" class="btn toggle-replies-btn" data-comentario-id="${c.id}">
                            <i class="fas fa-reply"></i> Respostas (${c.respostas_count})
                        </a>
                    </div>` : ''}
                </div>
                ${!c.parent_id ? `
                <div class="replies-wrapper" style="display: none;">
                    <div class="comment-replies"></div>
                    <div class="reply-form-container"></div>
                </div>` : ''}
            </div>`.trim();

        const commentElement = template.content.firstChild;
        
        if (c.respostas && c.respostas.length > 0) {
            const repliesContainer = commentElement.querySelector('.comment-replies');
            c.respostas.forEach(resposta => {
                repliesContainer.appendChild(criarElementoComentario(resposta));
            });
        }
        
        return commentElement;
    }
        
        function handleNotificarErro(form) {
            const tipoErroSelecionado = form.querySelector('button[data-tipo].active')?.dataset.tipo;
            if (!tipoErroSelecionado) {
                showNotificationModal('Atenção', 'Por favor, selecione o tipo do problema.', 'error');
                return;
            }
    
            const data = {
                alvo_id: form.querySelector('#notificar-erro-alvo-id').value,
                tipo_alvo: form.querySelector('#notificar-erro-tipo-alvo').value,
                tipo_erro: tipoErroSelecionado,
                descricao: form.querySelector('textarea[name="descricao"]').value
            };
    
            fetch("{% url 'pratica:notificar_erro' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(result => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalNotificarErro'));
                modal.hide();
                if (result.status === 'success') {
                    showNotificationModal('Notificação Enviada!', result.message, 'success');
                } else {
                    showNotificationModal('Erro no Envio', result.message, 'error');
                }
            }).catch(err => showNotificationModal('Erro de Rede', 'Não foi possível enviar a notificação.', 'error'));
        }
    
        const modalNotificarErroEl = document.getElementById('modalNotificarErro');
        if (modalNotificarErroEl) {
            const alvoIdInput = modalNotificarErroEl.querySelector('#notificar-erro-alvo-id');
            const tipoAlvoInput = modalNotificarErroEl.querySelector('#notificar-erro-tipo-alvo');
            const questaoButtonsDiv = modalNotificarErroEl.querySelector('#botoes-tipo-erro-questao');
            const comentarioButtonsDiv = modalNotificarErroEl.querySelector('#botoes-tipo-erro-comentario');
            const allErrorButtons = modalNotificarErroEl.querySelectorAll('button[data-tipo]');

            modalNotificarErroEl.addEventListener('show.bs.modal', function (event) {
                const triggerButton = event.relatedTarget;
                const questaoId = triggerButton.dataset.questaoId;
                const comentarioId = triggerButton.dataset.comentarioId;

                if (questaoId) {
                    alvoIdInput.value = questaoId;
                    tipoAlvoInput.value = 'questao';
                    questaoButtonsDiv.style.display = 'block';
                    comentarioButtonsDiv.style.display = 'none';
                } else if (comentarioId) {
                    alvoIdInput.value = comentarioId;
                    tipoAlvoInput.value = 'comentario';
                    questaoButtonsDiv.style.display = 'none';
                    comentarioButtonsDiv.style.display = 'block';
                }
            });

            modalNotificarErroEl.addEventListener('hidden.bs.modal', function() {
                modalNotificarErroEl.querySelector('form').reset();
                allErrorButtons.forEach(b => b.classList.remove('active', 'btn-dark'));
            });
            
            allErrorButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    allErrorButtons.forEach(b => b.classList.remove('active', 'btn-dark'));
                    this.classList.add('active', 'btn-dark');
                });
            });
        }
        // =======================================================================
        // FIM DA ALTERAÇÃO
        // =======================================================================
    });
</script>
{% endblock %}