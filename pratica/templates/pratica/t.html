<!-- pratica/listar_questoes.html -->

{% extends 'base.html' %}
{% load static %}
{% load questoes_extras %} 
{% load pratica_extras %} 

{% block title %}Praticar Questões{% endblock %}

{% block head %}
<!-- ... (todo o seu CSS <style> permanece o mesmo, sem alterações) ... -->
<link rel="stylesheet" href="{% static 'css/listagem-comum.css' %}">
<style>
    /* ========================================================================= */
    /* ESTILOS GERAIS DA PÁGINA DE PRÁTICA
    /* ========================================================================= */
    .enunciado-imagem {
        max-width: 100%;
        max-height: 450px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        border-radius: var(--raio-borda);
        box-shadow: var(--sombra-caixa);
    }
    
    /* Botões de filtro por status (Ex: Resolvidas, Acertei, Errei) */
    .btn-status-filter {
        border-radius: 20px !important;
        font-weight: 500;
        padding: 0.5rem 1.25rem;
        margin: 0.25rem;
        border: 1px solid var(--cor-borda);
        color: var(--cor-secundaria);
        transition: var(--transicao-padrao);
    }
    .btn-status-filter:hover {
        background-color: #e9ecef;
        border-color: #e9e7e0;
    }
    .btn-status-filter.active {
        background-color: var(--cor-primaria);
        color: var(--cor-texto-claro);
        border-color: var(--cor-primaria);
        box-shadow: 0 2px 4px rgba(74, 144, 226, 0.4);
    }
    
    /* ========================================================================= */
    /* ESTILOS PARA O EDITOR DE TEXTO TIPTAP (Comentários)
    /* ========================================================================= */
    .tiptap-toolbar {
        border: 1px solid var(--cor-borda);
        border-bottom: none;
        padding: .5rem;
        border-top-left-radius: var(--raio-borda);
        border-top-right-radius: var(--raio-borda);
        background-color: #f8f9fa;
    }
    .tiptap-toolbar button {
        border: none;
        background-color: transparent;
        border-radius: 4px;
        transition: var(--transicao-padrao);
    }
    .tiptap-toolbar button:hover {
        background-color: var(--cor-texto-escuro);
        color: var(--cor-texto-claro);
    }
    .tiptap-toolbar button.active {
        background-color: var(--cor-primaria);
        color: var(--cor-texto-claro);
    }
    
    .tiptap {
        border: 1px solid var(--cor-borda);
        border-radius: var(--raio-borda);
        padding: .75rem 1rem;
        min-height: 150px;
        background-color: var(--cor-fundo-claro);
    }
    .tiptap:focus-within { /* Aplica ao container quando o editor interno ganha foco */
        border-color: var(--cor-primaria);
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(74, 144, 226, .25);
    }
    
    .tiptap p.is-editor-empty:first-child::before {
      content: attr(data-placeholder);
      float: left;
      color: #adb5bd;
      pointer-events: none;
      height: 0;
    }
    
    .comment-edit-form .tiptap {
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }
    
    /* ========================================================================= */
    /* ESTILOS PARA A SEÇÃO DE COMENTÁRIOS
    /* ========================================================================= */
    .comentarios-section {
        background-color: #f8f9fa;
        border-radius: 0 0 var(--raio-borda) var(--raio-borda);
    }
    
    .comment-wrapper {
        position: relative;
        padding-left: 60px; /* Espaço para o avatar (40px) + gap (20px) */
        margin-bottom: 1.5rem;
    }
    
    .comment-card {
        background-color: var(--cor-fundo-claro);
        border: 1px solid var(--cor-borda);
        border-radius: var(--raio-borda);
        padding: 1rem 1.5rem;
        position: relative; /* Contexto para a seta do balão */
        box-shadow: none;
    }
    
    /* Seta do balão (simula um balão de fala) */
    .comment-card::before, .comment-card::after {
        content: '';
        position: absolute;
        top: 14px;
        left: -22px; 
        width: 0; height: 0;
        border: 11px solid transparent;
        border-right-color: var(--cor-borda);
    }
    .comment-card::after {
        left: -19px;
        top: 15px;
        border-width: 10px;
        border-right-color: var(--cor-fundo-claro);
    }
    
    .comment-wrapper .comment-avatar {
        position: absolute;
        left: 0; top: 0;
    }
    
    .new-comment-form-container {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .comment-avatar .avatar-icon {
        width: 40px; height: 40px;
        background-image: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
        color: var(--cor-texto-claro);
        display: flex;
        align-items: center; justify-content: center;
        border-radius: 50%;
        font-weight: bold; font-size: 1.1rem;
    }
    
    .comment-user { font-weight: 600; color: var(--cor-texto-escuro); }
    .comment-date { font-size: 0.8rem; color: var(--cor-secundaria); }
    
    .comment-footer {
        margin-top: 1rem;
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }
    .comment-footer a {
        text-decoration: none;
        color: var(--cor-secundaria);
        font-weight: 500;
        font-size: 0.85rem;
    }
    .comment-footer a:hover { color: var(--cor-primaria); }
    .btn-like.liked { color: var(--cor-primaria); font-weight: bold; }
    
    .comment-replies {
        margin-left: 4.5rem;
        padding-left: 1rem;
        border-left: 2px solid var(--cor-borda);
        margin-top: 1.5rem;
    }
    
    /* ========================================================================= */
    /* ESTILOS UNIFICADOS PARA CONTEÚDO (MARKDOWN)
    /* ========================================================================= */
    .enunciado-formatado, .explicacao, .tiptap, .comment-body {
        font-size: 1rem;
        line-height: 1.7;
        color: var(--cor-texto-escuro);
    }
    
    .enunciado-formatado p, .explicacao p, .tiptap p, .comment-body p { margin-bottom: 1rem; }
    .enunciado-formatado ul, .explicacao ul, .tiptap ul, .comment-body ul { padding-left: 1.5rem; margin-bottom: 1rem; }
    .enunciado-formatado blockquote, .explicacao blockquote, .tiptap blockquote, .comment-body blockquote {
        font-style: italic; color: var(--cor-secundaria);
        padding-left: 1.5rem; border-left: 4px solid var(--cor-borda);
        margin: 1rem 0;
    }

    /* ========================================================================= */
    /* ESTILOS ESPECÍFICOS DO CARD DA QUESTÃO
    /* ========================================================================= */
    .card-questao {
        background-color: var(--cor-fundo-claro);
        border: none;
        border-radius: var(--raio-borda);
        box-shadow: var(--sombra-caixa);
        margin-bottom: 2rem;
        overflow: hidden;
    }
    
    .card-questao .fa-star {
        font-size: 1.25rem; cursor: pointer; color: #ced4da;
    }
    .card-questao .fa-star.fas.text-warning {
        color: var(--cor-aviso) !important;
    }
    
    /* Feedback de Resposta */
    .alternativas .form-check-label.text-success { color: var(--cor-sucesso) !important; font-weight: bold; }
    .alternativas .form-check-label.text-danger { color: var(--cor-erro) !important; }
    .alternativas .form-check-label.text-danger::after {
        content: " (Sua resposta)"; font-style: italic; font-weight: normal;
    }
    
    .explicacao {
        background-color: #f8f9fa;
        border-radius: var(--raio-borda);
        border-left: 4px solid var(--cor-primaria);
    }

    /* ========================================================================= */
    /* AJUSTES PARA TELAS MOBILE (ATÉ 768px)
    /* ========================================================================= */
    @media (max-width: 768px) {
        .container { max-width: 100%; padding: 0; }
        .filtros-card, .card-questao {
            width: 100%;
            border-radius: 0;
            margin: 0 0 1rem 0;
            box-shadow: none;
            border-bottom: 1px solid var(--cor-borda); 
        }
        .card-body, .card-header, .card-footer, .comentarios-section { padding: 1.25rem; }
        .comment-wrapper { padding-left: 55px; }
        .comment-replies { margin-left: 1.25rem; padding-left: 1rem; }
    }
</style>
{% endblock %}


{% block content %}
<div class="container mt-5">

    <!-- CABEÇALHO E FILTROS -->
    <div class="filtros-card p-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0 h4">Filtrar Questões</h2>
            <div>
                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#filtrosSalvosModal">
                    <i class="fas fa-filter me-2"></i>Meus Filtros
                </button>
            </div>
        </div>

        <!-- Filtros rápidos por STATUS -->
        <div class="mb-4 text-center">
            <div class="btn-group flex-wrap" role="group" aria-label="Filtros de status">
                <a href="?{{ request.GET.urlencode|remove_page_param }}&status=" class="btn btn-status-filter {% if not request.GET.status %}active{% endif %}">TODAS</a>
                <a href="?{{ request.GET.urlencode|remove_page_param }}&status=respondidas" class="btn btn-status-filter {% if request.GET.status == 'respondidas' %}active{% endif %}">RESOLVIDAS</a>
                <a href="?{{ request.GET.urlencode|remove_page_param }}&status=nao_respondidas" class="btn btn-status-filter {% if request.GET.status == 'nao_respondidas' %}active{% endif %}">NÃO RESOLVIDAS</a>
                <a href="?{{ request.GET.urlencode|remove_page_param }}&status=acertei" class="btn btn-status-filter {% if request.GET.status == 'acertei' %}active{% endif %}">ACERTEI</a>
                <a href="?{{ request.GET.urlencode|remove_page_param }}&status=errei" class="btn btn-status-filter {% if request.GET.status == 'errei' %}active{% endif %}">ERREI</a>
                <a href="?{{ request.GET.urlencode|remove_page_param }}&status=favoritas" class="btn btn-status-filter {% if request.GET.status == 'favoritas' %}active{% endif %}">FAVORITAS</a>
            </div>
        </div>

        <!-- INCLUSÃO DO COMPONENTE DE FILTROS REUTILIZÁVEL -->
        {% include 'includes/_filtros_questoes.html' with form_action_url=request.path status_param=status_param %}
        
        <div class="text-center mt-3">
            <button type="button" class="btn btn-link text-secondary" data-bs-toggle="modal" data-bs-target="#salvarFiltroModal">
                <i class="fas fa-save me-2"></i>Salvar Filtros Atuais
            </button>
        </div>
    </div>

    <!-- CONTROLES DE ORDENAÇÃO E PAGINAÇÃO -->
    {% include 'gestao/includes/_ordenacao_e_paginacao_controls.html' with paginated_object=questoes sort_options=sort_options sort_by=sort_by per_page=per_page %}
   
    <!-- LISTAGEM DE QUESTÕES -->
    {% for questao in questoes %}
    <div class="card card-questao mb-4" id="questao-{{ questao.id }}">
        
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <span class="badge bg-dark me-2">{{ forloop.counter0|add:questoes.start_index }}.</span>
                <span class="badge bg-primary me-2">{{ questao.codigo }}</span>
                <strong>{{ questao.disciplina.nome }}</strong> - {{ questao.assunto.nome }}
                {% if questao.is_inedita %}
                    <span class="badge bg-info ms-2">Inédita</span>
                {% elif questao.banca and questao.ano %}
                    <span class="text-muted ms-2">({{ questao.banca.nome }} - {{ questao.ano }})</span>
                {% endif %}
            </div>
            <i class="fa-star {% if questao.id in favoritas_ids %}fas text-warning{% else %}far{% endif %}"
               style="cursor: pointer;"
               data-questao-id="{{ questao.id }}"
               title="Marcar como favorita"></i>
        </div>

        <div class="card-body p-4">
            {% if questao.imagem_enunciado %}
                <img src="{{ questao.imagem_enunciado.url }}" class="enunciado-imagem mb-4" alt="Imagem da questão">
            {% endif %}

            <div class="card-text enunciado-formatado mb-4">
                {{ questao.enunciado|render_markdown|safe }}
            </div>
            
            <hr>

            <div class="alternativas mt-4" data-questao-id="{{ questao.id }}">
                {% for key, value in questao.get_alternativas_dict.items %}
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="alternativa-{{ questao.id }}" id="q{{ questao.id }}-{{ key }}" value="{{ key }}">
                    <label class="form-check-label w-100" for="q{{ questao.id }}-{{ key }}">
                        <strong>{{ key }})</strong> {{ value }}
                    </label>
                </div>
                {% endfor %}
            </div>
            
            <button type="button" class="btn btn-success mt-4 w-100 btn-responder" data-questao-id="{{ questao.id }}">Responder</button>

            <div class="feedback mt-4" style="display: none;">
                <div class="alert"></div>
                <div class="explicacao p-3 mt-3" style="display: none;">
                    <h5 class="h6">Explicação da Alternativa Correta:</h5>
                    <div class="explicacao-conteudo"></div>
                </div>
            </div>
        </div>

        <div class="card-footer bg-white d-flex justify-content-center gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm btn-toggle-explicacao d-none" data-questao-id="{{ questao.id }}">
                <i class="fas fa-graduation-cap me-1"></i> Gabarito Comentado
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm btn-toggle-comentarios" data-questao-id="{{ questao.id }}">
                <i class="far fa-comment me-1"></i> Comentários
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalNotificarErro" data-questao-id="{{ questao.id }}">
                <i class="fas fa-flag me-1"></i> Notificar Erro
            </button>
        </div>

        <!-- Seção de Comentários (Oculta) -->
        <div class="comentarios-section p-3" id="comentarios-section-{{ questao.id }}" style="display: none;">
            {% include 'pratica/includes/_secao_comentarios.html' %}
        </div>
    </div>
    {% empty %}
    <div class="card card-body text-center py-5">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h4 class="h5">Nenhuma questão encontrada</h4>
        <p class="text-muted">Tente ajustar seus filtros ou buscar por outros termos.</p>
    </div>
    {% endfor %}

    <!-- COMPONENTE DE PAGINAÇÃO -->
    {% include 'includes/_paginacao.html' with paginated_object=questoes %} 

</div>

<!-- INCLUSÃO DOS MODAIS REUTILIZÁVEIS -->
{% include 'pratica/includes/_modais_pratica.html' %}

{% endblock %}

{% block scripts %}
<!-- Importação dos Módulos do Tiptap -->
<script type="module">
    import { Editor } from 'https://esm.sh/@tiptap/core';
    import StarterKit from 'https://esm.sh/@tiptap/starter-kit';
    import { Markdown } from 'https://esm.sh/tiptap-markdown';
    import Underline from 'https://esm.sh/@tiptap/extension-underline';
    import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder';
   
    // Disponibiliza globalmente para o script inline
    window.TipTap = { Editor, StarterKit, Markdown, Underline, Placeholder };
</script>

<!-- SCRIPT DE FILTROS -->
<script src="{% static 'js/filtros-questoes.js' %}"></script>

<!-- ======================================================================= -->
<!-- INÍCIO DO BLOCO DE SCRIPT CORRIGIDO -->
<!-- ======================================================================= -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tiptapEditors = {};
    let editTiptapEditor = null;

    if (window.TipTap) {
        const { Editor, StarterKit, Markdown, Underline, Placeholder } = window.TipTap;
        editTiptapEditor = new Editor({
            extensions: [ StarterKit, Markdown.configure({ html: false }), Underline, Placeholder.configure({ placeholder: 'Edite sua resposta...' }) ],
            content: '',
        });
    }

    function initializeTiptapEditor({ editorElement, toolbarElement, hiddenTextarea }) {
        if (editorElement.tiptapEditor) return editorElement.tiptapEditor;
        const { Editor, StarterKit, Markdown, Underline, Placeholder } = window.TipTap;
        const editor = new Editor({
            element: editorElement,
            extensions: [ StarterKit, Markdown.configure({ html: false }), Underline, Placeholder.configure({ placeholder: 'Escreva o seu comentário...' }) ],
            content: '',
            onUpdate: ({ editor }) => { hiddenTextarea.value = editor.storage.markdown.getMarkdown(); },
        });
        toolbarElement.querySelectorAll('button[data-command]').forEach(button => {
            button.addEventListener('click', () => {
                const command = {
                    toggleBold: () => editor.chain().focus().toggleBold().run(),
                    toggleItalic: () => editor.chain().focus().toggleItalic().run(),
                    toggleUnderline: () => editor.chain().focus().toggleUnderline().run(),
                    toggleBulletList: () => editor.chain().focus().toggleBulletList().run(),
                    toggleOrderedList: () => editor.chain().focus().toggleOrderedList().run(),
                }[button.dataset.command];
                if (command) command();
            });
        });
        editorElement.tiptapEditor = editor;
        return editor;
    }

    // =======================================================================
    // DELEGAÇÃO DE EVENTOS CENTRALIZADA (CORREÇÃO APLICADA AQUI)
    // =======================================================================
    document.body.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        const button = e.target.closest('button');
        const icon = e.target.closest('.fa-star');

        // Ações em links (<a>)
        if (link) {
            if (link.classList.contains('btn-like')) { e.preventDefault(); handleLikeComentario(link); }
            else if (link.classList.contains('toggle-replies-btn')) { e.preventDefault(); handleToggleReplies(link); }
            else if (link.classList.contains('sort-comments-btn')) { e.preventDefault(); handleSortClick(link); }
        }
        // Ações em botões (<button>)
        else if (button) {
            if (button.id === 'btn-confirmar-salvar-filtro') { handleSalvarFiltro(); }
            else if (button.classList.contains('btn-deletar-filtro')) {
                const nomeFiltro = button.closest('.list-group-item').querySelector('a').textContent;
                showConfirmationModal(`Excluir o filtro "${nomeFiltro}"?`, () => handleDeletarFiltro(button.dataset.filtroId));
            }
            else if (button.classList.contains('btn-responder')) { handleResponder(button); }
            else if (button.classList.contains('btn-toggle-comentarios')) { handleToggleComentarios(button); }
            else if (button.classList.contains('btn-toggle-explicacao')) { handleToggleExplicacao(button); }
            else if (button.classList.contains('btn-excluir-comentario')) {
                showConfirmationModal('Deseja excluir seu comentário?', () => handleExcluirComentario(button.dataset.comentarioId));
            }
            else if (button.classList.contains('btn-editar-comentario')) { handleAbrirEdicao(button); }
            else if (button.classList.contains('btn-salvar-edicao')) { handleSalvarEdicao(button); }
            else if (button.classList.contains('btn-cancelar-edicao')) { cancelarEdicao(button.closest('.comment-edit-form')); }
        }
        // Ações em ícones (<i>)
        else if (icon) {
            handleFavoritar(icon);
        }
    });

    document.body.addEventListener('submit', function(e) {
        if (e.target.classList.contains('form-comentario')) { e.preventDefault(); handleAdicionarComentario(e.target); }
        if (e.target.id === 'form-notificar-erro') { e.preventDefault(); handleNotificarErro(e.target); }
    });

    // =======================================================================
    // AS FUNÇÕES HANDLER (handleResponder, handleFavoritar, etc.)
    // PERMANECEM IGUAIS, EXCETO handleToggleReplies e criarHtmlComentario
    // =======================================================================
    
    // ... (cole aqui as funções handleSalvarFiltro, handleDeletarFiltro, handleResponder, etc., que já funcionavam)
    // ... (elas não precisam de alteração)

    /**
     * CORRIGIDO: Alterna a visibilidade das respostas e INSERE o formulário de resposta.
     */
    function handleToggleReplies(link) {
        const comentarioId = link.dataset.comentarioId;
        const questaoId = link.closest('.card-questao').id.replace('questao-', '');
        const wrapper = document.getElementById(`comment-wrapper-${comentarioId}`);
        const repliesWrapper = wrapper.querySelector('.replies-wrapper');

        const isHidden = repliesWrapper.style.display === 'none' || !repliesWrapper.style.display;
        repliesWrapper.style.display = isHidden ? 'block' : 'none';

        if (isHidden) {
            const formContainer = repliesWrapper.querySelector('.reply-form-container');
            if (!formContainer.querySelector('form')) {
                formContainer.innerHTML = `
                    <div class="new-comment-form-container mt-3">
                        <div class="comment-avatar"><div class="avatar-icon"><i class="fas fa-user"></i></div></div>
                        <form class="form-comentario form-reply flex-grow-1" data-questao-id="${questaoId}" data-parent-id="${comentarioId}">
                            <textarea name="conteudo" class="form-control form-control-sm" rows="3" placeholder="Escreva sua resposta..." required></textarea>
                            <div class="d-flex justify-content-end mt-2">
                                <button type="button" class="btn btn-sm btn-secondary me-2" onclick="this.closest('.reply-form-container').innerHTML = ''">Cancelar</button>
                                <button type="submit" class="btn btn-sm btn-primary">Enviar</button>
                            </div>
                        </form>
                    </div>`;
            }
        }
    }
    
    /**
     * CORRIGIDO: Carrega e renderiza os comentários, criando elementos DOM em vez de string.
     */
    function carregarComentarios(questaoId, sortBy = 'recent') {
        const comentariosList = document.getElementById(`comentarios-list-${questaoId}`);
        comentariosList.innerHTML = '<p class="text-center text-muted py-4">Carregando...</p>';
        
        fetch(`/pratica/carregar-comentarios/${questaoId}/?sort_by=${sortBy}`)
            .then(response => response.ok ? response.json() : Promise.reject('Erro ao carregar'))
            .then(data => {
                comentariosList.innerHTML = ''; // Limpa o container
                if (data.comentarios.length > 0) {
                    data.comentarios.forEach(c => {
                        // Agora usamos appendChild para adicionar o elemento DOM
                        comentariosList.appendChild(criarElementoComentario(c));
                    });
                } else {
                    comentariosList.innerHTML = '<p class="text-center text-muted py-4">Nenhum comentário ainda.</p>';
                }
                document.getElementById(`comentarios-section-${questaoId}`).dataset.carregado = 'true';
            }).catch(err => {
                comentariosList.innerHTML = '<p class="text-center text-danger py-4">Erro ao carregar comentários.</p>';
            });
    }

    /**
     * CORRIGIDO: Gera um ELEMENTO DOM para um comentário, em vez de uma string HTML.
     */
    function criarElementoComentario(c) {
        const template = document.createElement('template');
        template.innerHTML = `
            <div class="comment-wrapper" id="comment-wrapper-${c.id}">
                <div class="comment-avatar"><div class="avatar-icon">${c.usuario.charAt(0).toUpperCase()}</div></div>
                <div class="comment-card" id="comentario-${c.id}">
                    <div class="comment-header d-flex justify-content-between">
                        <div><span class="comment-user">${c.usuario}</span><div class="comment-date">${c.data_criacao}</div></div>
                        ${c.pode_editar ? `
                        <div class="comment-actions dropdown">
                            <button class="btn btn-sm" type="button" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-h"></i></button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><button class="dropdown-item btn-editar-comentario" type="button" data-comentario-id="${c.id}">Editar</button></li>
                                <li><button class="dropdown-item text-danger btn-excluir-comentario" type="button" data-comentario-id="${c.id}">Excluir</button></li>
                            </ul>
                        </div>` : ''}
                    </div>
                    <div class="comment-content" data-raw-content="${c.conteudo_raw.replace(/"/g, '&quot;')}">
                        <div class="comment-body">${c.conteudo}</div>
                    </div>
                    <div class="comment-edit-form mt-2" style="display: none;"></div>
                    ${!c.parent_id ? `
                    <div class="comment-footer">
                        <a href="#" class="btn btn-like ${c.user_liked ? 'liked' : ''}" data-comentario-id="${c.id}">
                            <i class="fas fa-thumbs-up"></i> Gostei (<span class="like-count">${c.likes_count}</span>)
                        </a>
                        <a href="#" class="btn toggle-replies-btn" data-comentario-id="${c.id}">
                            <i class="fas fa-reply"></i> Respostas (${c.respostas_count})
                        </a>
                    </div>` : ''}
                </div>
                ${!c.parent_id ? `
                <div class="replies-wrapper" style="display: none;">
                    <div class="comment-replies"></div>
                    <div class="reply-form-container"></div>
                </div>` : ''}
            </div>`.trim();

        const commentElement = template.content.firstChild;
        
        // Se houver respostas, cria os elementos delas e anexa
        if (c.respostas && c.respostas.length > 0) {
            const repliesContainer = commentElement.querySelector('.comment-replies');
            c.respostas.forEach(resposta => {
                repliesContainer.appendChild(criarElementoComentario(resposta));
            });
        }
        
        return commentElement;
    }

    // ... (cole aqui as outras funções handler que não foram alteradas)
    
});
</script>
<!-- ======================================================================= -->
<!-- FIM DO BLOCO DE SCRIPT CORRIGIDO -->
<!-- ======================================================================= -->
{% endblock %}