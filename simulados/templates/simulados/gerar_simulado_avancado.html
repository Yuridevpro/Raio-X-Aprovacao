<!-- simulados/templates/simulados/gerar_simulado_avancado.html -->

{% extends 'base.html' %}
{% load static %}
{% block title %}Gerador Avançado de Simulados{% endblock %}

{% block head %}
<!-- ======================================================================= -->
<!-- INÍCIO DA CORREÇÃO: Adicionando o CSS do Tom Select -->
<!-- ======================================================================= -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<!-- ======================================================================= -->
<!-- FIM DA CORREÇÃO -->
<!-- ======================================================================= -->
<style>
    .wizard-container { max-width: 900px; }
    .step-card {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .summary-card {
        position: sticky;
        top: 1.5rem;
        background-color: #f8f9fa;
    }
    .disciplina-selecionada {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 0.75rem 1rem;
    }
    .qtd-input { width: 80px; text-align: center; }
</style>
{% endblock %}

{% block content %}
<div class="container my-5 wizard-container">
    <div class="text-center mb-5">
        <h1 class="h3">Gerador Avançado de Simulados</h1>
        <p class="text-muted">Crie sua prova personalizada com controle total sobre o conteúdo e o tempo.</p>
    </div>

    {% include 'gestao/includes/_messages.html' %}

    <form method="POST" id="form-gerador-avancado">
        {% csrf_token %}
        <div class="row g-4">
            <!-- Coluna Principal: Passos -->
            <div class="col-lg-8">
                <div class="vstack gap-4">
                    <!-- PASSO 1: DETALHES -->
                    <div class="card step-card">
                        <div class="card-body p-4">
                            <h5 class="card-title mb-3">1. Detalhes do Simulado</h5>
                            <div class="mb-3">
                                <label for="{{ form.nome.id_for_label }}" class="form-label">{{ form.nome.label }}</label>
                                {{ form.nome }}
                            </div>
                            <div>
                                <label for="tempo-slider" class="form-label">Tempo médio por questão: <strong id="tempo-label">Ilimitado</strong></label>
                                <input type="range" class="form-range" id="tempo-slider" min="0" max="5" value="0">
                                <input type="hidden" name="tempo_por_questao" id="tempo-hidden-input" value="0">
                            </div>
                        </div>
                    </div>

                    <!-- PASSO 2: CONTEÚDO -->
                    <div class="card step-card">
                        <div class="card-body p-4">
                            <h5 class="card-title mb-3">2. Seleção de Conteúdo</h5>
                            <div class="mb-3">
                                <label for="disciplina-select" class="form-label">Adicionar Disciplina</label>
                                <!-- O select original continua aqui, mas será aprimorado pelo Tom Select -->
                                <select id="disciplina-select" placeholder="Busque e selecione uma disciplina...">
                                    <option value="">Selecione para adicionar...</option>
                                    {% for d in disciplinas %}
                                        <option value="{{ d.id }}" data-max="{{ d.num_questoes }}">{{ d.nome }} ({{ d.num_questoes }}q)</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div id="disciplinas-selecionadas-container" class="vstack gap-2">
                                <!-- Disciplinas selecionadas aparecerão aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna Lateral: Resumo -->
            <div class="col-lg-4">
                <div class="card step-card summary-card">
                    <div class="card-body p-4 text-center">
                        <h5 class="card-title mb-3">Resumo</h5>
                        <h3 class="display-5" id="total-questoes">0</h3>
                        <p class="text-muted mb-3">Questões no total</p>
                        
                        <h4 class="h6" id="tempo-total">Tempo Ilimitado</h4>
                        <p class="text-muted small mb-4">Tempo total estimado</p>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="btn-criar-simulado" disabled>
                                <i class="fas fa-cogs me-2"></i>Criar Simulado
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<!-- ======================================================================= -->
<!-- INÍCIO DA CORREÇÃO: Adicionando o SCRIPT do Tom Select -->
<!-- ======================================================================= -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<!-- ======================================================================= -->
<!-- FIM DA CORREÇÃO -->
<!-- ======================================================================= -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('form-gerador-avancado');
    const container = document.getElementById('disciplinas-selecionadas-container');
    const tempoSlider = document.getElementById('tempo-slider');
    const tempoLabel = document.getElementById('tempo-label');
    const tempoHiddenInput = document.getElementById('tempo-hidden-input');

    const totalQuestoesEl = document.getElementById('total-questoes');
    const tempoTotalEl = document.getElementById('tempo-total');
    const criarBtn = document.getElementById('btn-criar-simulado');

    const tempoMap = [0, 1, 2, 3, 4, 5];
    const tempoTextMap = ["Ilimitado", "1 min", "2 min", "3 min", "4 min", "5 min"];

    // =======================================================================
    // INÍCIO DA CORREÇÃO: Inicializando o Tom Select
    // =======================================================================
    const tomSelect = new TomSelect('#disciplina-select', {
        create: false,
        onItemAdd: function(value, item) {
            addDisciplina(value, item);
            this.clear(); // Limpa a seleção após adicionar
            this.blur(); // Tira o foco do campo
        }
    });
    // =======================================================================
    // FIM DA CORREÇÃO
    // =======================================================================

    function updateSummary() {
        let totalQuestoes = 0;
        const inputs = container.querySelectorAll('.qtd-input');
        inputs.forEach(input => {
            totalQuestoes += parseInt(input.value, 10) || 0;
        });
        totalQuestoesEl.textContent = totalQuestoes;
        
        const tempoPorQuestao = parseInt(tempoHiddenInput.value, 10);
        if (tempoPorQuestao > 0 && totalQuestoes > 0) {
            const totalMinutos = totalQuestoes * tempoPorQuestao;
            const horas = Math.floor(totalMinutos / 60);
            const minutos = totalMinutos % 60;
            let tempoStr = '';
            if (horas > 0) tempoStr += `${horas}h `;
            if (minutos > 0) tempoStr += `${minutos}min`;
            tempoTotalEl.textContent = tempoStr.trim() || '0min';
        } else {
            tempoTotalEl.textContent = "Tempo Ilimitado";
        }
        
        criarBtn.disabled = totalQuestoes < 10 || totalQuestoes > 120;
    }

    function addDisciplina(value, item) {
        if (!value || document.getElementById(`disciplina-item-${value}`)) {
            return;
        }

        const id = value;
        const nome = item.textContent.split(' (')[0];
        const max = item.dataset.max;

        const div = document.createElement('div');
        div.className = 'disciplina-selecionada d-flex justify-content-between align-items-center';
        div.id = `disciplina-item-${id}`;
        div.innerHTML = `
            <div>
                <strong class="d-block">${nome}</strong>
                <small class="text-muted">Máx: ${max} questões</small>
            </div>
            <div class="d-flex align-items-center gap-2">
                <input type="number" name="disciplina-${id}" class="form-control form-control-sm qtd-input" value="10" min="0" max="${max}" required>
                <button type="button" class="btn btn-sm btn-outline-danger btn-remove">&times;</button>
            </div>
        `;
        container.appendChild(div);
        updateSummary();
    }

    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-remove')) {
            e.target.closest('.disciplina-selecionada').remove();
            updateSummary();
        }
    });

    container.addEventListener('input', function(e) {
        if (e.target.classList.contains('qtd-input')) {
            const max = parseInt(e.target.max, 10);
            if (parseInt(e.target.value, 10) > max) {
                e.target.value = max;
            }
            if (parseInt(e.target.value, 10) < 0) {
                e.target.value = 0;
            }
            updateSummary();
        }
    });
    
    tempoSlider.addEventListener('input', function() {
        const index = parseInt(this.value, 10);
        tempoLabel.textContent = tempoTextMap[index];
        tempoHiddenInput.value = tempoMap[index];
        updateSummary();
    });
});
</script>
{% endblock %}