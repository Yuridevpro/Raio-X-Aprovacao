<!-- simulados/templates/simulados/includes/_simulado_card_oficial.html -->

<div class="card h-100 shadow-sm simulado-card">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="badge bg-primary-soft text-primary badge-oficial">OFICIAL</span>
            <span class="badge bg-{{ simulado.dificuldade|lower }}-soft text-{{ simulado.dificuldade|lower }}">{{ simulado.get_dificuldade_display }}</span>
        </div>

        <h5 class="card-title">{{ simulado.nome }}</h5>
        <p class="card-text text-muted small"><i class="fas fa-list-ol me-2"></i>{{ simulado.num_questoes }} questões</p>
        
        <div class="d-flex flex-wrap gap-1 mb-3">
            {% if simulado.principais_disciplinas %}
                {% for disciplina_nome in simulado.principais_disciplinas %}
                    <span class="badge badge-disciplina">{{ disciplina_nome }}</span>
                {% endfor %}
            {% elif simulado.num_questoes > 0 %}
                <span class="badge badge-disciplina">Disciplinas Diversas</span>
            {% endif %}
        </div>
    </div>
    <div class="card-footer bg-light p-3">
        {% if simulado.status == 'EM_BREVE' %}
            <button class="btn btn-outline-secondary w-100" disabled>
                <i class="fas fa-clock me-2"></i>Disponível em breve
            </button>
        {% else %}
            {% if simulado.sessoes_finalizadas_usuario %}
                <div class="btn-group w-100">
                    <a href="{% url 'simulados:resultado_simulado' simulado.sessoes_finalizadas_usuario.0.id %}" class="btn btn-success"><i class="fas fa-poll me-2"></i>Ver Último Resultado</a>
                    <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false"></button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'simulados:iniciar_ou_continuar_sessao' simulado.id %}"><i class="fas fa-redo fa-fw me-2"></i>Refazer Simulado</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li class="dropdown-header">Histórico Recente</li>
                        <!-- ======================================================================= -->
                        <!-- INÍCIO DA CORREÇÃO: Limita o histórico e adiciona o link "Ver mais" -->
                        <!-- ======================================================================= -->
                        {% for sessao in simulado.sessoes_finalizadas_usuario|slice:":5" %}
                            <li><a class="dropdown-item" href="{% url 'simulados:resultado_simulado' sessao.id %}">{{ sessao.data_fim|date:"d/m/Y, H:i" }}</a></li>
                        {% endfor %}
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-primary" href="{% url 'simulados:historico_simulado' simulado.id %}"><i class="fas fa-history fa-fw me-2"></i>Ver histórico completo...</a></li>
                        <!-- ======================================================================= -->
                        <!-- FIM DA CORREÇÃO -->
                        <!-- ======================================================================= -->
                    </ul>
                </div>
            {% elif simulado.sessao_ativa_id %}
                <a href="{% url 'simulados:realizar_simulado' simulado.sessao_ativa_id %}" class="btn btn-warning w-100"><i class="fas fa-play-circle me-2"></i>Continuar Simulado</a>
            {% else %}
                <a href="{% url 'simulados:iniciar_ou_continuar_sessao' simulado.id %}" class="btn btn-primary w-100"><i class="fas fa-rocket me-2"></i>Iniciar Simulado</a>
            {% endif %}
        {% endif %}
    </div>
</div>