<!-- templates/simulados/resultado_simulado.html -->
{% extends 'base.html' %}
{% load static %}
{% load pratica_extras %} <!-- ✅ GARANTA QUE O TEMPLATETAG ESTÁ CARREGADO -->

{% block title %}Resultado do Simulado{% endblock %}

{% block head %}
<style>
    :root {
        --cor-sucesso: #198754;
        --cor-erro: #dc3545;
        --cor-aviso: #ffc107;
        --cor-sucesso-leve: #d1e7dd;
        --cor-erro-leve: #f8d7da;
        --cor-branco-leve: #f8f9fa;
        --cor-borda: #dee2e6;
        --sombra-caixa: 0 4px 12px rgba(0,0,0,0.05);
        --raio-borda: 12px;
    }
    body { background-color: var(--cor-branco-leve); }
    .stat-card {
        text-align: center;
        border-radius: var(--raio-borda);
        padding: 1.5rem;
        box-shadow: var(--sombra-caixa);
        background-color: #fff;
        border-top: 4px solid;
    }
    .stat-card .icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .stat-card .stat-value { font-size: 2rem; font-weight: 700; }
    .stat-card.border-success { border-color: var(--cor-sucesso); }
    .stat-card.border-danger { border-color: var(--cor-erro); }
    .stat-card.border-secondary { border-color: #6c757d; }
    .stat-card.border-primary { border-color: var(--cor-primaria); }

    .resultado-header { background-color: #fff; border-radius: var(--raio-borda); box-shadow: var(--sombra-caixa); }

    .revisao-questao-card {
        background-color: #fff;
        border: 1px solid var(--cor-borda);
        border-radius: var(--raio-borda);
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: var(--sombra-caixa);
    }
    .revisao-questao-header {
        background-color: var(--cor-branco-leve);
        padding: 0.75rem 1.25rem;
        font-weight: 600;
        border-bottom: 1px solid var(--cor-borda);
    }
    .alternativa-revisao {
        padding: 0.75rem 1.25rem;
        border: 2px solid transparent;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        background-color: #f8f9fa;
    }
    .alternativa-letra {
        font-weight: 700;
        margin-right: 1rem;
    }
    .alternativa-revisao.correta {
        background-color: var(--cor-sucesso-leve);
        border-color: var(--cor-sucesso);
    }
    .alternativa-revisao.incorreta {
        background-color: var(--cor-erro-leve);
        border-color: var(--cor-erro);
    }
    .status-icon {
        font-size: 1.2rem;
        margin-left: auto;
    }
    .enunciado-formatado img { max-width: 100%; height: auto; border-radius: 8px; }
    
    .explicacao-container {
        background-color: #f0f6ff;
        border-left: 4px solid var(--cor-primaria);
        border-radius: 8px;
    }
    .explicacao-container p:last-child {
        margin-bottom: 0;
    }
    .progress-bar {
        transition: width 0.6s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Cabeçalho do Resultado -->
    <div class="resultado-header p-4 mb-5 text-center">
        <h1 class="h3">Resultado do Simulado</h1>
        <h2 class="h5 text-muted fw-normal">{{ sessao.simulado.nome }}</h2>
        <p class="mb-0">Finalizado em: {{ sessao.data_fim|date:"d/m/Y \à\s H:i" }}</p>
    </div>

    <!-- DASHBOARD DE ESTATÍSTICAS -->
    <div class="row g-4 mb-5">
        <div class="col-lg-3 col-md-6"><div class="stat-card border-success"><div class="icon text-success"><i class="fas fa-check-circle"></i></div><div class="stat-value" data-animate="int">{{ total_acertos }}</div><div class="stat-label text-muted">Acertos</div></div></div>
        <div class="col-lg-3 col-md-6"><div class="stat-card border-danger"><div class="icon text-danger"><i class="fas fa-times-circle"></i></div><div class="stat-value" data-animate="int">{{ total_erros }}</div><div class="stat-label text-muted">Erros</div></div></div>
        <div class="col-lg-3 col-md-6"><div class="stat-card border-secondary"><div class="icon text-secondary"><i class="fas fa-minus-circle"></i></div><div class="stat-value" data-animate="int">{{ total_em_branco }}</div><div class="stat-label text-muted">Em Branco</div></div></div>
        <div class="col-lg-3 col-md-6"><div class="stat-card border-primary"><div class="icon text-primary"><i class="fas fa-percentage"></i></div><div class="stat-value" data-animate="float">{{ percentual_acerto|floatformat:1 }}%</div><div class="stat-label text-muted">de Aproveitamento</div></div></div>
    </div>
    
    <div class="row g-4 mb-5">
        {% if eventos_gamificacao.xp_ganho > 0 or eventos_gamificacao.moedas_ganhas > 0 %}
            <div class="col-md-4">
                <div class="stat-card" style="border-color: #6f42c1;">
                    <div class="icon" style="color: #6f42c1;"><i class="fas fa-brain"></i></div>
                    <div class="stat-value small">+{{ eventos_gamificacao.xp_ganho }} XP</div>
                    <div class="stat-label text-muted">
                        {% if eventos_gamificacao.moedas_ganhas > 0 %}
                            e +{{ eventos_gamificacao.moedas_ganhas }} Moedas
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-4"><div class="stat-card"><div class="icon"><i class="fas fa-stopwatch"></i></div><div class="stat-value small">{{ tempo_gasto_formatado }}</div><div class="stat-label text-muted">Tempo Gasto</div></div></div>
            <div class="col-md-4"><div class="stat-card"><div class="icon"><i class="fas fa-tachometer-alt"></i></div><div class="stat-value small">{{ acertos_por_minuto }}</div><div class="stat-label text-muted">Acertos por Minuto</div></div></div>
        {% else %}
            <div class="col-md-6"><div class="stat-card"><div class="icon"><i class="fas fa-stopwatch"></i></div><div class="stat-value small">{{ tempo_gasto_formatado }}</div><div class="stat-label text-muted">Tempo Gasto</div></div></div>
            <div class="col-md-6"><div class="stat-card"><div class="icon"><i class="fas fa-tachometer-alt"></i></div><div class="stat-value small">{{ acertos_por_minuto }}</div><div class="stat-label text-muted">Acertos por Minuto</div></div></div>
        {% endif %}
    </div>

    <!-- DESEMPENHO POR DISCIPLINA -->
    {% if desempenho_disciplina %}
    <div class="card shadow-sm mb-5">
        <div class="card-header"><h4 class="h5 mb-0">Desempenho por Disciplina</h4></div>
        <div class="card-body p-4">
            {% for item in desempenho_disciplina %}
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>{{ item.disciplina }}</span>
                    <span class="fw-bold">{{ item.acertos }}/{{ item.total }} ({{ item.percentual|floatformat:1 }}%)</span>
                </div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar" role="progressbar" style="width: {{ item.percentual }}%;" aria-valuenow="{{ item.percentual }}" aria-valuemin="0" aria-valuemax="100">{{ item.percentual|floatformat:0 }}%</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Revisão Detalhada das Questões -->
    <h3 class="mb-4 text-center">Revisão Detalhada</h3>
    {% for item in revisao_detalhada %}
    <div class="revisao-questao-card">
        <div class="revisao-questao-header d-flex justify-content-between align-items-center">
            <span>Questão {{ item.numero }} ({{ item.questao.codigo }})</span>
            <span>
                {% if item.foi_correta %}
                    <span class="badge bg-success">Correta</span>
                {% elif item.resposta_usuario %}
                    <span class="badge bg-danger">Incorreta</span>
                {% else %}
                    <span class="badge bg-secondary">Em Branco</span>
                {% endif %}
            </span>
        </div>
        <div class="card-body p-4">
             <div class="text-muted small mb-3">
                <strong>Disciplina:</strong> {{ item.questao.disciplina.nome }} | 
                <strong>Banca:</strong> {{ item.questao.banca.nome|default:"N/A" }} | 
                <strong>Ano:</strong> {{ item.questao.ano|default:"N/A" }}
            </div>
            <div class="enunciado-formatado mb-4">
                {{ item.questao.enunciado|render_markdown|safe }} 
            </div>
            <div class="alternativas-container">
                {% for letra, texto in item.questao.get_alternativas_dict.items %}
                <div class="alternativa-revisao 
                    {% if letra == item.questao.gabarito %}correta{% endif %}
                    {% if letra == item.resposta_usuario and not item.foi_correta %}incorreta{% endif %}">
                    
                    <span class="alternativa-letra">{{ letra }})</span>
                    <span class="alternativa-texto">{{ texto }}</span>

                    {% if letra == item.questao.gabarito %}
                        <i class="fas fa-check-circle text-success status-icon" title="Alternativa Correta"></i>
                    {% elif letra == item.resposta_usuario %}
                        <i class="fas fa-times-circle text-danger status-icon" title="Sua Resposta"></i>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            {% if item.explicacao_html %}
            <div class="mt-4">
                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#explicacao-{{ item.questao.id }}" aria-expanded="false" aria-controls="explicacao-{{ item.questao.id }}">
                    <i class="fas fa-graduation-cap me-2"></i>Ver Explicação
                </button>
                <div class="collapse mt-2" id="explicacao-{{ item.questao.id }}">
                    <div class="explicacao-container p-3">
                        <!-- ✅ CORREÇÃO AQUI -->
                        {{ item.explicacao_html|safe }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <div class="text-center mt-5">
        <a href="{% url 'simulados:listar_simulados' %}" class="btn btn-primary btn-lg">
            <i class="fas fa-arrow-left me-2"></i>Voltar para a Lista de Simulados
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ eventos_gamificacao|json_script:"eventos-gamificacao-data" }}
<script src="{% static 'js/gamification-effects.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function animateCountUp(element) {
        const isFloat = element.dataset.animate === 'float';
        const rawValue = element.textContent.replace('%', '').replace(',', '.').trim();
        const finalValue = isFloat ? parseFloat(rawValue) : parseInt(rawValue, 10);
        
        if (isNaN(finalValue)) return;

        let startValue = 0;
        const duration = 1500;
        let startTime = null;

        function animationStep(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / duration, 1);
            let currentValue = progress * (finalValue - startValue) + startValue;
            
            if (isFloat) {
                element.textContent = currentValue.toFixed(1).replace('.', ',') + '%';
            } else {
                element.textContent = Math.floor(currentValue);
            }

            if (progress < 1) {
                requestAnimationFrame(animationStep);
            } else {
                if (isFloat) {
                    element.textContent = finalValue.toFixed(1).replace('.', ',') + '%';
                } else {
                    element.textContent = finalValue;
                }
            }
        }
        requestAnimationFrame(animationStep);
    }
    
    document.querySelectorAll('.stat-value[data-animate]').forEach(animateCountUp);

    const eventosDataElement = document.getElementById('eventos-gamificacao-data');
    const eventos = eventosDataElement ? JSON.parse(eventosDataElement.textContent) : null;
    const novasRecompensas = (eventos && eventos.novas_recompensas) ? eventos.novas_recompensas : [];
    
    let delay = 1500;

    if (eventos) {
        if (eventos.moedas_ganhas > 0) {
            const saldoAtual = parseInt(document.getElementById('navbar-coin-balance').textContent, 10);
            updateNavbarCoinBalance(saldoAtual + eventos.moedas_ganhas);
        }
        if (eventos.xp_ganho > 0) {
            setTimeout(() => { showGamificationToast('Simulado Concluído!', `Você ganhou <strong>${eventos.xp_ganho} XP</strong> pelo seu desempenho!`, 'fas fa-flag-checkered', '#28a745'); }, delay);
            delay += 2500;
        }
        if (eventos.moedas_ganhas > 0) {
            setTimeout(() => { showCoinToast(eventos.moedas_ganhas, 'pela conclusão do simulado'); }, delay);
            delay += 2500;
        }
        if (eventos.regras_info && eventos.regras_info.length > 0) {
            eventos.regras_info.forEach(regra => {
                if (regra.xp_extra > 0) {
                    setTimeout(() => { showGamificationToast('Bônus!', `Você ganhou <strong>+${regra.xp_extra} XP</strong> por <strong>${regra.nome}</strong>!`, 'fas fa-medal', '#ffc107'); }, delay);
                    delay += 2500;
                }
            });
        }
        if (eventos.level_up_info) {
            setTimeout(() => { triggerLevelUpNotification(eventos.level_up_info); }, delay);
            delay += 3000;
        }
        if (novasRecompensas && novasRecompensas.length > 0) {
            setTimeout(() => { triggerNewPendingRewardsNotification(novasRecompensas); }, delay);
        }
    }
});
</script>
{% endblock %}