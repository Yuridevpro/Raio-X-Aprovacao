<!-- usuarios/templates/usuarios/includes/_colecao_item_card.html -->
{% load colecao_extras %}

<div class="col">
    <div class="card h-100 collection-card {% if item.id in desbloqueados_ids %}unlocked{% else %}locked{% endif %}">
        
        <!-- Imagem -->
        {% if tipo_item == 'banner' %}
            <img src="{{ item.imagem.url }}" class="card-img-top bg-light" alt="{{ item.nome }}" style="aspect-ratio: 16 / 9;">
        {% else %}
            <img src="{{ item.imagem.url }}" class="card-img-top bg-light" alt="{{ item.nome }}">
        {% endif %}

        <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start">
                <h6 class="card-title mb-1">{{ item.nome }}</h6>
                <span class="rarity-badge {% rarity_class item.raridade %}">{{ item.get_raridade_display }}</span>
            </div>

            <!-- >>> INÍCIO DA MUDANÇA: CONDIÇÃO DE DESBLOQUEIO DINÂMICA <<< -->
            <small class="text-muted mb-2 unlock-condition">
                {% if item.tipo_desbloqueio == 'NIVEL' %}
                    <i class="fas fa-star me-1"></i> Desbloqueia no Nível {{ item.nivel_necessario }}
                {% elif item.tipo_desbloqueio == 'CONQUISTA' and item.conquista_necessaria %}
                    <i class="fas fa-trophy me-1"></i> Pela conquista "{{ item.conquista_necessaria.nome }}"
                {% elif item.tipo_desbloqueio == 'REGRA' %}
                     <i class="fas fa-scroll me-1"></i> Por Regra Automática
                {% else %}
                     <i class="fas fa-gift me-1"></i> Recompensa Especial
                {% endif %}
            </small>
            <!-- >>> FIM DA MUDANÇA <<< -->

            <p class="card-text flex-grow-1">{{ item.descricao }}</p>

            <!-- Botões de Ação -->
            <div class="mt-auto">
                {% if item.id in desbloqueados_ids %}
                    {% if item.id == equipado_id %}
                        <a href="{% url 'desequipar_item' tipo_item=tipo_item %}" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-times me-1"></i> Desequipar
                        </a>
                    {% else %}
                        {% if tipo_item == 'borda' and not user_profile.avatar_equipado %}
                             <button class="btn btn-secondary w-100" disabled data-bs-toggle="tooltip" title="Equipe um avatar para usar uma borda.">
                                 Equipar
                             </button>
                        {% else %}
                            <a href="{% if tipo_item == 'avatar' %}{% url 'equipar_avatar' item.id %}{% elif tipo_item == 'borda' %}{% url 'equipar_borda' item.id %}{% else %}{% url 'equipar_banner' item.id %}{% endif %}" class="btn btn-primary w-100">Equipar</a>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <button class="btn btn-secondary w-100" disabled><i class="fas fa-lock me-1"></i> Bloqueado</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>