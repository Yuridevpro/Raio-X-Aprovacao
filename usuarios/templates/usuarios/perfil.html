{% extends 'base.html' %}
{% load static %}
{% block title %}
    {% if request.user == perfil_visualizado.user %}
        Meu Santuário
    {% else %}
        Santuário de {{ perfil_visualizado.nome }}
    {% endif %}
{% endblock %}

{% block head %}
<style>
    /* ======================================================================= */
    /* FONTES E ESTILOS GLOBAIS
    /* ======================================================================= */
    @import url('https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700&display=swap');

    /* ======================================================================= */
    /* HEADER DO PERFIL (SANTUÁRIO) - ESTRUTURA RESTAURADA E RE-ESTILIZADA
    /* ======================================================================= */
    .profile-header {
        position: relative;
        overflow: hidden;
        color: white;
        padding: 2.5rem 1.5rem;
        border-radius: 12px;
        background-color: transparent;
        clip-path: polygon(0 0, 95% 0, 100% 50%, 95% 100%, 0 100%);
        box-shadow: 0 8px 25px rgba(26, 31, 61, 0.4); /* Sombra temática */
        perspective: 1200px;
        z-index: 1;
        min-height: 260px;
        display: flex;
        align-items: center;
        font-family: 'Oxanium', sans-serif;
    }

    /* Camada de Gradiente (Overlay) Celestial */
    .profile-header::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(26, 31, 61, 0.24) 0%, rgba(90, 73, 156, 0.5) 100%);
        z-index: -1;
    }

    /* Camada da Imagem de Fundo (Parallax) */
    .profile-header::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: var(--banner-url, url('{% static "img/default_banner.jpg" %}') );
        background-size: cover;
        background-position: center 85%; /* Posição de foco restaurada */
        background-attachment: fixed; /* Efeito Parallax mantido */
        z-index: -2;
    }

    .profile-header .row {
        position: relative;
        z-index: 2;
        width: 100%;
    }

    /* ✅ CORREÇÃO: Nome do usuário com cor mais clara e sombra para destaque */
    .profile-header h1 {
        font-family: 'Oxanium', sans-serif;
        font-weight: 700;
        font-size: 2.5rem;
        color: var(--cor-texto-claro); /* Cor clara do tema */
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    
    .profile-header .col-md-9 {
        text-align: left;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-start;
    }

    @media (max-width: 767px) {
        .profile-header .col-md-9 {
            text-align: center;
            align-items: center;
        }
    }


    /* AVATAR E BORDA */
    .profile-avatar-container {
        position: relative;
        width: 150px;
        height: 150px;
        filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
    }
    .avatar-image {
        width: 100%; height: 100%; object-fit: cover;
        position: relative; z-index: 1;
        border-radius: 50%;
        border: 3px solid rgba(255, 255, 255, 0.8);
    }
    .border-image {
        position: absolute; inset: -15px;
        width: calc(100% + 30px); height: calc(100% + 30px);
        object-fit: contain; pointer-events: none; z-index: 2;
    }
    .profile-avatar-container.with-frame .avatar-image {
        width: 65%; height: 65%;
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 12px;
        border: none;
    }

    /* NÍVEL E XP */
    .level-badge {
        background: linear-gradient(45deg, var(--cor-dourada), #ffc107);
        color: var(--cor-texto-escuro);
        padding: 0.4rem 1rem;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 700;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
    }
    /* ✅ CORREÇÃO: Classe que define a altura da barra de progresso */
    .xp-progress {
        height: 12px;
        background-color: rgba(26, 31, 61, 0.2);
        border-radius: 12px;
        overflow: hidden; /* Garante que a barra interna fique contida */
    }
    .xp-progress-bar {
        background: linear-gradient(90deg, #0dcaf0, var(--cor-sucesso));
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
    }

    /* CARDS DE ESTATÍSTICAS E CONQUISTAS */
    .stat-card {
        background-color: #fff;
        border: 1px solid var(--cor-borda);
        border-radius: var(--raio-borda);
        padding: 1.5rem;
        text-align: center;
        transition: var(--transicao-padrao);
    }
    .stat-card:hover { transform: translateY(-5px); box-shadow: var(--sombra-caixa-hover); }
    .stat-card .stat-icon { font-size: 2.5rem; margin-bottom: 1rem; }
    .stat-card .stat-value { font-family: var(--fonte-display); font-size: 2.2rem; font-weight: 700; }
    .stat-card .stat-label { color: var(--cor-texto-muted); }
    .conquista-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        flex-shrink: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    {% include 'usuarios/includes/_messages.html' %}

    <div class="profile-header mb-4" 
         style="--banner-url: url('{% if perfil_visualizado.banner_equipado %}{{ perfil_visualizado.banner_equipado.imagem.url }}{% else %}{% static "img/default_banner.jpg" %}{% endif %}');">
        
        <div class="row align-items-center">
            <div class="col-md-3 text-center mb-3 mb-md-0">
                <div class="profile-avatar-container mx-auto {% if perfil_visualizado.borda_equipada %}with-frame{% endif %}">
                    {% if perfil_visualizado.borda_equipada %}
                        <img src="{{ perfil_visualizado.borda_equipada.imagem.url }}" class="border-image" alt="Borda de Perfil">
                    {% endif %}
                    {% if perfil_visualizado.avatar_equipado %}
                        <img src="{{ perfil_visualizado.avatar_equipado.imagem.url }}" class="avatar-image" alt="Avatar de Perfil">
                    {% else %}
                        <div class="avatar-image d-flex align-items-center justify-content-center bg-secondary text-white fs-1">
                            {{ perfil_visualizado.nome.0 }}{{ perfil_visualizado.sobrenome.0 }}
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-9 text-center text-md-start">
                <h1 class="mb-2">{{ perfil_visualizado.nome }} {{ perfil_visualizado.sobrenome }}</h1>
                <p class="mb-3 text-white-50">{{ perfil_visualizado.user.email }}</p>
                {% if request.user == perfil_visualizado.user %}
                <a href="{% url 'editar_perfil' %}" class="btn btn-sm btn-light">
                    <i class="fas fa-pencil-alt me-2"></i>Editar Perfil e Conta
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Seção de Estatísticas -->
    <div class="row g-4 mb-4">
        <div class="col-lg-4 col-md-6">
            <div class="stat-card h-100">
                <div class="stat-icon text-warning"><i class="fas fa-star"></i></div>
                <div class="stat-value">{{ gamificacao_data.level }}</div>
                <div class="stat-label">Nível</div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="stat-card h-100">
                <div class="stat-icon text-danger"><i class="fas fa-fire"></i></div>
                <div class="stat-value">{{ streak_data.current_streak }}</div>
                <div class="stat-label">Dias em Sequência</div>
            </div>
        </div>
        <div class="col-lg-4 col-md-12">
            <div class="stat-card h-100">
                <div class="stat-icon text-info"><i class="fas fa-tasks"></i></div>
                <div class="stat-value">{{ meta_hoje.questoes_resolvidas }}/{{ meta_diaria_total }}</div>
                <div class="stat-label">Meta Diária de Questões</div>
            </div>
        </div>
    </div>

    <!-- Progresso de XP -->
    <div class="card shadow-sm mb-4">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center text-muted small mb-1">
                <span class="fw-bold">Nível {{ gamificacao_data.level }}</span>
                <span class="level-badge" title="{{ gamificacao_data.xp|floatformat:0 }} XP Total">
                    <i class="fas fa-bolt me-1"></i> Progresso
                </span>
                <span class="fw-bold">Nível {{ gamificacao_data.level|add:1 }}</span>
            </div>
            <!-- ✅ CORREÇÃO: Adicionada a classe 'xp-progress' ao container -->
            <div class="progress xp-progress" role="progressbar" title="{{ progresso_percentual|floatformat:2 }}%">
                <div class="progress-bar xp-progress-bar" style="width: {{ progresso_percentual }}%;"></div>
            </div>
            <div class="text-center mt-2 text-muted small">
                <span class="fw-bold">{{ gamificacao_data.xp|floatformat:0 }} / {{ xp_proximo_nivel|floatformat:0 }}</span> XP
            </div>
        </div>
    </div>

    <!-- Seção de Conquistas e Troféus -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Relíquias Conquistadas</h5>
                    <a href="{% url 'trilhas_de_conquistas' %}" class="btn btn-sm btn-outline-primary">Ver Todas as Trilhas</a>
                </div>
                <div class="card-body">
                    {% if conquistas_desbloqueadas %}
                        <div class="list-group list-group-flush">
                        {% for conquista in conquistas_desbloqueadas|slice:":5" %}
                            <div class="list-group-item d-flex align-items-center px-0">
                                <div class="conquista-icon me-3" style="background-color: {{ conquista.cor }}20; color: {{ conquista.cor }};">
                                    <i class="{{ conquista.icone }}"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">{{ conquista.nome }}</h6>
                                    <small class="text-muted">{{ conquista.descricao|truncatechars:60 }}</small>
                                </div>
                            </div>
                        {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center text-muted m-0 pt-3 pb-3">Nenhuma relíquia sagrada foi conquistada ainda. Continue sua jornada!</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light"><h5 class="mb-0">Hall da Fama</h5></div>
                <div class="card-body">
                    {% if not trofeus_semanais and not trofeus_mensais %}
                        <p class="text-center text-muted m-0 pt-3 pb-3">Nenhum troféu do ranking conquistado. Ascenda ao pódio para gravar seu nome na história!</p>
                    {% else %}
                        <ul class="list-group list-group-flush">
                            {% for trofeu in trofeus_mensais|slice:":3" %}
                                <li class="list-group-item px-0">{% if trofeu.posicao == 1 %}🥇{% elif trofeu.posicao == 2 %}🥈{% else %}🥉{% endif %} <strong>#{{ trofeu.posicao }} Lugar</strong> - Mês {{ trofeu.mes }}/{{ trofeu.ano }}</li>
                            {% endfor %}
                            {% for trofeu in trofeus_semanais|slice:":3" %}
                                <li class="list-group-item px-0">{% if trofeu.posicao == 1 %}🥇{% elif trofeu.posicao == 2 %}🥈{% else %}🥉{% endif %} <strong>#{{ trofeu.posicao }} Lugar</strong> - Semana {{ trofeu.semana }}/{{ trofeu.ano }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}