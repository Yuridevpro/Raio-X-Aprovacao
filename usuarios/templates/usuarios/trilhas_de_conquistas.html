<!-- usuarios/templates/usuarios/trilhas_de_conquistas.html -->
{% extends 'base.html' %}
{% load static %}
{% load gamificacao_extras %}
{% block title %}Minhas Trilhas de Conquistas{% endblock %}

{% block head %}
<style>
    :root {
        --connector-color: #e9ecef;
    }

    .filter-container {
        background-color: var(--cor-fundo-body);
        padding-bottom: 1rem;
        z-index: 100;
    }
    .accordion-item {
        border: 1px solid var(--cor-borda);
        margin-bottom: 2rem;
        border-radius: var(--raio-borda) !important;
        overflow: visible;
        position: relative;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .accordion-button {
        font-weight: 600;
        font-size: 1.1rem;
    }
    .accordion-button:not(.collapsed) {
        color: var(--cor-primaria);
        background-color: #eef5ff;
        box-shadow: inset 0 -1px 0 rgba(0, 0, 0, .125);
    }
    .accordion-button:focus {
        box-shadow: 0 0 0 0.25rem rgba(74, 144, 226, 0.25);
    }

    .sequencia-wrapper, .individuais-wrapper {
        position: relative;
        padding: 2rem 1rem 1rem 1rem;
        border: 1px solid var(--cor-borda);
        border-radius: var(--raio-borda);
        margin-bottom: 2rem;
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    .sequencia-wrapper::before, .individuais-wrapper::before {
        content: attr(data-title);
        position: absolute;
        top: -12px;
        left: 20px;
        background-color: #fff;
        padding: 0 10px;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--cor-secundaria);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border-radius: 4px;
        z-index: 3;
    }

    .sequencia-descricao, .individuais-descricao {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 1rem;
        margin-top: -0.25rem;
    }

    .sequencia-svg {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
    }
    .sequencia-list {
        position: relative;
        z-index: 2;
    }

    .conquista-entry {
        margin-bottom: 1.25rem;
    }

    .conquista-node {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border: 1px solid transparent;
        border-radius: 0.75rem;
        position: relative;
        background-color: #fff;
        z-index: 2;
        transition: all 0.25s ease, transform 0.25s ease;
        box-shadow: 0 1px 6px rgba(0,0,0,0.04);
        flex-wrap: wrap; /* ðŸ”¹ Permite quebra no mobile */
    }
    .conquista-node.unlocked {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
    .conquista-node.available {
        border-color: var(--cor-info);
        box-shadow: 0 6px 20px rgba(3, 169, 244, 0.08);
        transform: translateY(-2px);
    }
    .conquista-node.locked {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        filter: grayscale(90%);
        opacity: 0.85;
        cursor: not-allowed;
    }

    .step-indicator {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: #6c757d;
        color: white;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: background-color 0.3s ease;
        z-index: 3;
    }
    .conquista-node.unlocked .step-indicator {
        background-color: var(--cor-sucesso);
    }
    .conquista-node.available .step-indicator {
        background-color: var(--cor-info);
    }

    .conquista-icon-wrapper {
        flex-shrink: 0;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 1.25rem;
        color: white;
        transition: transform 0.25s ease, opacity 0.25s ease;
        z-index: 3;
    }
    .conquista-node.unlocked .conquista-icon-wrapper {
        opacity: 0.8;
    }
    .conquista-node.available .conquista-icon-wrapper {
        transform: scale(1.04);
    }
    .conquista-node.locked .conquista-icon-wrapper {
        background-color: #e9ecef;
        color: #6c757d;
    }

    .conquista-details {
        overflow-wrap: break-word;
        word-break: break-word;
        flex: 1 1 auto; /* ðŸ”¹ Faz o texto ocupar o espaÃ§o restante */
        min-width: 0; /* ðŸ”¹ Evita overflow no mobile */
    }
    .progress {
        height: 8px;
    }
    .conquista-recompensas {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px dashed #ced4da;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .recompensa-icon {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        cursor: pointer;
        transition: transform 0.15s ease;
        object-fit: cover; /* ðŸ”¹ Garante que a imagem nÃ£o estoure */
        max-width: 100%; /* ðŸ”¹ Se adapta ao container */
    }
    .recompensa-icon:hover {
        transform: scale(1.12);
        z-index: 10;
    }

    .unlock-conditions ul {
        padding-left: 0;
        list-style-position: inside;
    }
    .unlock-conditions li {
        padding: 2px 0;
    }

    .modal-recompensa-img {
        width: 100%;
        max-width: 200px; /* ðŸ”¹ Se adapta Ã  tela */
        height: auto;
        object-fit: contain;
    }

    /* -------------------------
       RESPONSIVIDADE MOBILE
       ------------------------- */
    @media (max-width: 767px) {
        .conquista-node {
            flex-direction: column;
            text-align: center;
            gap: 0.75rem;
        }
        .conquista-node .conquista-details {
            width: 100%;
        }
        .sequencia-svg path {
            stroke-width: 3;
        }
        .conquistas-individuais-grid .col-12 {
            flex: 0 0 100%;
            max-width: 100%;
        }
        .recompensa-icon {
            width: 45px;
            height: 45px;
        }
    }

    .sequencia-svg path {
        stroke: var(--connector-color);
        stroke-width: 4;
        stroke-linecap: round;
        stroke-linejoin: round;
        fill: none;
    }
</style>
{% endblock %}

{% block content %}
{% include 'includes/_loader.html' %}

<div id="page-content-wrapper" style="opacity: 0; transition: opacity 0.5s ease;">
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="h3 mb-0">Minha ColeÃ§Ã£o</h2>
            <p class="text-muted">Acompanhe seu progresso e veja as prÃ³ximas conquistas a serem desbloqueadas.</p>
        </div>
        <a href="{% url 'meu_perfil' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar ao Perfil
        </a>
    </div>

    {% include 'usuarios/includes/_colecao_submenu.html' with active_tab='trilhas_de_conquistas' %}

    <div class="filter-container">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="trilhaSearchInput" class="form-control" placeholder="Buscar por nome da trilha ou conquista...">
        </div>
    </div>
    
    <div class="accordion" id="trilhasAccordion">
        {% for trilha in trilhas %}
        <div class="accordion-item" data-trilha-nome="{{ trilha.nome|lower }}">
            <h2 class="accordion-header" id="heading-{{ trilha.id }}">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ trilha.id }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapse-{{ trilha.id }}">
                    <i class="{{ trilha.icone }} me-2"></i>{{ trilha.nome }}
                </button>
            </h2>
            <div id="collapse-{{ trilha.id }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading-{{ trilha.id }}" data-bs-parent="#trilhasAccordion">
                <div class="accordion-body p-lg-4 p-3">
                    <p class="text-muted border-bottom pb-3 mb-4">{{ trilha.descricao }}</p>
                    
                    {% for serie in trilha.sequencias_com_titulo %}
                    <div class="sequencia-wrapper" data-title="SÃ‰RIE: {{ serie.titulo|upper }}">
                        {% if serie.descricao %}
                            <p class="sequencia-descricao">{{ serie.descricao }}</p>
                        {% endif %}
                        <svg class="sequencia-svg" preserveAspectRatio="none" aria-hidden="true"></svg>

                        <div class="sequencia-list">
                            {% for conquista in serie.conquistas %}
                            <div class="conquista-entry" data-conquista-nome="{{ conquista.nome|lower }}">
                                {% include 'usuarios/includes/_conquista_node.html' with conquista=conquista step=forloop.counter %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
        
                    {% if trilha.conquistas_individuais %}
                        <div class="individuais-wrapper" data-title="CONQUISTAS INDIVIDUAIS">
                            {% if trilha.descricao_individuais %}
                                <p class="individuais-descricao">{{ trilha.descricao_individuais }}</p>
                            {% endif %}
                            <div class="row g-3 conquistas-individuais-grid">
                            {% for conquista in trilha.conquistas_individuais %}
                                <div class="col-12" data-conquista-nome="{{ conquista.nome|lower }}">
                                     {% include 'usuarios/includes/_conquista_node.html' with conquista=conquista step=None %}
                                </div>
                            {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="card card-body text-center py-5">
            <i class="fas fa-road fa-3x text-muted mb-3"></i>
            <h4 class="h5">Nenhuma trilha de conquistas disponÃ­vel</h4>
            <p class="text-muted">Fique de olho! Novas jornadas serÃ£o adicionadas em breve.</p>
        </div>
        {% endfor %}
    </div>
    <div id="noResultsMessage" class="card card-body text-center py-5" style="display: none;">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h4 class="h5">Nenhuma trilha encontrada</h4>
        <p class="text-muted">Tente um termo de busca diferente.</p>
    </div>
</div>

<div class="modal fade" id="recompensaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="recompensaModalLabel">Detalhes da Recompensa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" id="modalImagem" class="modal-recompensa-img rounded-circle mb-3" alt="Recompensa">
                <h4 id="modalNome" class="fw-bold"></h4>
                <p id="modalDescricao" class="text-muted"></p>
                <span id="modalRaridade" class="badge"></span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/loader.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  });

  const recompensaModal = document.getElementById('recompensaModal');
  if (recompensaModal) {
    recompensaModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const nome = button.getAttribute('data-nome');
      const descricao = button.getAttribute('data-descricao');
      const raridade = button.getAttribute('data-raridade');
      const raridadeClasse = button.getAttribute('data-raridade-classe');
      const imagem = button.getAttribute('data-imagem');
      
      recompensaModal.querySelector('#modalNome').textContent = nome;
      recompensaModal.querySelector('#modalDescricao').textContent = descricao;
      recompensaModal.querySelector('#modalRaridade').textContent = raridade;
      recompensaModal.querySelector('#modalImagem').src = imagem;
      recompensaModal.querySelector('#modalRaridade').className = 'badge ' + raridadeClasse;
    });
  }

  /* -------------------------
     FunÃ§Ãµes para desenhar SVG
     ------------------------- */
  function drawConnectorForWrapper(wrapper) {
    const svg = wrapper.querySelector('.sequencia-svg');
    if (!svg) return;

    // =======================================================================
    // INÃCIO DA CORREÃ‡ÃƒO: Verifica se hÃ¡ um filtro ativo
    // =======================================================================
    const searchInput = document.getElementById('trilhaSearchInput');
    const isFiltering = searchInput && searchInput.value.trim() !== '';

    // Se estiver filtrando, limpa o SVG e para a execuÃ§Ã£o
    if (isFiltering) {
        svg.innerHTML = '';
        return;
    }
    // =======================================================================
    // FIM DA CORREÃ‡ÃƒO
    // =======================================================================

    const nodes = Array.from(wrapper.querySelectorAll('.conquista-entry .conquista-node'))
                      .filter(n => window.getComputedStyle(n).display !== 'none');

    if (!nodes || nodes.length < 2) {
      svg.innerHTML = '';
      return;
    }

    const wrapperRect = wrapper.getBoundingClientRect();
    const width = Math.max(1, Math.floor(wrapperRect.width));
    const height = Math.max(1, Math.floor(wrapperRect.height));

    svg.setAttribute('width', width);
    svg.setAttribute('height', height);
    svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

    const points = [];
    nodes.forEach(node => {
      const icon = node.querySelector('.conquista-icon-wrapper') || node.querySelector('.step-indicator') || node;
      const rect = icon.getBoundingClientRect();
      const cx = rect.left - wrapperRect.left + rect.width / 2;
      const cy = rect.top - wrapperRect.top + rect.height / 2;
      points.push({ x: cx, y: cy });
    });

    let d = '';
    points.forEach((p, i) => {
      if (i === 0) d += `M ${p.x} ${p.y}`;
      else d += ` L ${p.x} ${p.y}`;
    });

    svg.innerHTML = `<path d="${d}" fill="none" stroke="var(--connector-color)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>`;
  }

  function redrawAllConnectors() {
    const wrappers = document.querySelectorAll('.sequencia-wrapper');
    wrappers.forEach(wrap => drawConnectorForWrapper(wrap));
  }

  let redrawTimeout = null;
  function scheduleRedraw(delay = 120) {
    if (redrawTimeout) clearTimeout(redrawTimeout);
    redrawTimeout = setTimeout(() => {
      redrawAllConnectors();
      redrawTimeout = null;
    }, delay);
  }

  window.addEventListener('resize', function () {
    scheduleRedraw(120);
  });

  const trilhasAccordion = document.getElementById('trilhasAccordion');
  if (trilhasAccordion) {
    trilhasAccordion.addEventListener('shown.bs.collapse', function () { scheduleRedraw(40); });
    trilhasAccordion.addEventListener('hidden.bs.collapse', function () { scheduleRedraw(40); });
  }

  scheduleRedraw(80);

  /* -------------------------
     Busca / filtro
     ------------------------- */
  const searchInput = document.getElementById('trilhaSearchInput');
  const accordion = document.getElementById('trilhasAccordion');
  const allTrilhas = accordion ? Array.from(accordion.querySelectorAll('.accordion-item')) : [];
  const noResultsMessage = document.getElementById('noResultsMessage');

  if (searchInput) {
      searchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase().trim();
          let visibleTrilhasCount = 0;

          allTrilhas.forEach(trilhaItem => {
              const trilhaNome = trilhaItem.dataset.trilhaNome || '';
              const conquistas = trilhaItem.querySelectorAll('[data-conquista-nome]');
              let isTrilhaVisible = false;

              if (searchTerm === '' || trilhaNome.includes(searchTerm)) {
                  isTrilhaVisible = true;
                  conquistas.forEach(conq => conq.style.display = '');
              } else {
                  let visibleConquistasCount = 0;
                  conquistas.forEach(conq => {
                      const conqNome = (conq.dataset.conquistaNome || '').toLowerCase();
                      if (conqNome.includes(searchTerm)) {
                          conq.style.display = '';
                          visibleConquistasCount++;
                      } else {
                          conq.style.display = 'none';
                      }
                  });

                  if (visibleConquistasCount > 0) {
                      isTrilhaVisible = true;
                  }
              }
              
              trilhaItem.style.display = isTrilhaVisible ? '' : 'none';
              if (isTrilhaVisible) visibleTrilhasCount++;
          });

          if(noResultsMessage) {
              noResultsMessage.style.display = visibleTrilhasCount === 0 ? 'block' : 'none';
          }

          scheduleRedraw(40);
      });
  }
});
</script>
{% endblock %}